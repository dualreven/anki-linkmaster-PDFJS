# 20251002213000-pdf-annotation-sidebar 工作日志
**参考标准**: v001-spec.md

## 工作记录1
**时间**: 2025-10-02 21:54:33

### 工作内容:
创建PDF Viewer标注栏功能（第一期）需求文档

### 工作步骤:
1. 分析用户需求：点击标注按钮打开标注栏，支持截图、选字、批注三种标注类型
2. 参考BookmarkSidebarUI的实现设计标注侧边栏UI
3. 设计三种标注工具的交互流程
4. 设计标注数据模型和存储方案
5. 设计完整的事件接口（27个事件）
6. 设计核心类架构（8个核心类）
7. 制定10个Phase的实现计划
8. 规划后续版本功能

### 工作结果:
- ✅ 创建任务目录：`todo-and-doing/2 todo/20251002213000-pdf-annotation-sidebar/`
- ✅ 完成需求文档：`v001-spec.md` (约1300行)
  * 详细的现状分析和问题描述
  * 完整的功能需求（3种标注类型）
  * 清晰的UI设计（侧边栏布局、工具栏、标注卡片）
  * 完整的事件接口定义（27个事件）
  * 详细的类设计（8个核心类）
    - AnnotationManager（核心业务逻辑）
    - AnnotationSidebarUI（侧边栏UI）
    - ScreenshotTool（截图工具）
    - TextHighlightTool（选字高亮工具）
    - CommentTool（批注工具）
    - AnnotationRenderer（标注渲染器）
    - AnnotationStorage（数据存储）
    - ScreenshotCapturer（截图捕获）
  * 完整的数据模型（Annotation、Comment）
  * 明确的验收标准（单元测试 + 7个端到端测试）
  * 10个Phase的实现计划（预计31小时）
  * 后端扩展需求（WebSocket消息格式、JSON存储）
  * 风险评估和缓解措施
  * 第二期、第三期功能规划

### 关键设计决策:
1. **三种标注类型**:
   - 截图标注：Canvas截取PDF区域，保存为base64图片
   - 选字标注：使用PDF.js textContent API，支持多颜色高亮
   - 批注标注：页面上点击添加批注图标，支持纯文字内容

2. **侧边栏设计**: 参考BookmarkSidebarUI，包含header工具栏和标注列表

3. **标注渲染**: 独立的AnnotationRenderer类在PDF页面上渲染标注覆盖层

4. **数据持久化**: 通过WebSocket保存到后端JSON文件，关联PDF文件路径

5. **工具模式管理**: 同一时间只能激活一种工具，ESC取消当前模式

6. **评论系统**: 每个标注支持多条纯文字评论，形成评论列表

7. **跳转功能**: 点击标注卡片的跳转按钮，跳转到对应页码并高亮标注

### 技术亮点:
- **Canvas截图**: 使用Canvas API精确截取PDF指定区域
- **文本高亮**: 基于PDF.js的textContent实现精准文本定位
- **虚拟滚动**: 支持1000+标注的流畅滚动
- **自动保存**: debounce 2秒自动保存到后端
- **事件驱动**: 完全基于EventBus，组件解耦

### 存在问题:
无

### 下一步计划:
第一期功能开发（按Phase顺序执行）：

1. **Phase 1**: 数据模型和事件接口（2小时）
2. **Phase 2**: 标注侧边栏UI（4小时）
3. **Phase 3**: 截图工具（4小时）
4. **Phase 4**: 选字高亮工具（3小时）
5. **Phase 5**: 批注工具（3小时）
6. **Phase 6**: 标注管理器（4小时）
7. **Phase 7**: 标注渲染器（3小时）
8. **Phase 8**: 数据存储（3小时，包含后端扩展）
9. **Phase 9**: AnnotationFeature集成（3小时）
10. **Phase 10**: 文档和优化（2小时）

**总预计时间**: 31小时

### 第一期完成后的功能:
- ✅ 打开/关闭标注侧边栏
- ✅ 截图标注（拖拽选择区域、添加描述）
- ✅ 选字标注（文本高亮、多颜色、添加笔记）
- ✅ 批注标注（页面点击、添加批注图标）
- ✅ 标注列表展示
- ✅ 跳转到标注位置
- ✅ 添加评论（多条评论）
- ✅ 编辑和删除标注
- ✅ 数据持久化（WebSocket + JSON文件）

### 后续版本规划:
- **第二期**: 排序、筛选、只显示当前页、搜索、导出
- **第三期**: 分组标签、协作标注、历史记录、撤销重做、更多标注类型
