# PDF Viewer æ ‡æ³¨æ åŠŸèƒ½è§„æ ¼è¯´æ˜ï¼ˆç¬¬ä¸‰æœŸ:åç«¯æ”¯æŒï¼‰

**åŠŸèƒ½ID**: 20251004030630-pdf-annotation-sidebar-stage3
**ä¼˜å…ˆçº§**: é«˜
**ç‰ˆæœ¬**: v001
**åˆ›å»ºæ—¶é—´**: 2025-10-04 03:06:30
**é¢„è®¡å®Œæˆ**: 2025-10-15
**çŠ¶æ€**: è®¾è®¡ä¸­
**ä¾èµ–éœ€æ±‚**:
- 20251002213000-pdf-annotation-sidebar (ç¬¬ä¸€æœŸ)
- 20251004030600-pdf-annotation-sidebar-stage2 (ç¬¬äºŒæœŸ)

## ç°çŠ¶è¯´æ˜

### å½“å‰ç³»ç»ŸçŠ¶æ€
- âœ… ç¬¬ä¸€æœŸå·²å®Œæˆï¼šåŸºç¡€æ ‡æ³¨åŠŸèƒ½ï¼ˆæˆªå›¾ã€é€‰å­—ã€æ‰¹æ³¨ï¼‰
- âœ… ç¬¬äºŒæœŸå·²å®Œæˆï¼šUIæ·±åŒ–ï¼ˆç­›é€‰ã€æ’åºã€IDå¤åˆ¶ï¼‰
- âœ… å‰ç«¯æ ‡æ³¨ç®¡ç†å·²å®ç°
- âš ï¸ åç«¯æ•°æ®æŒä¹…åŒ–ä»…æœ‰åŸºç¡€å®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

### å·²æœ‰åŠŸèƒ½åŸºç¡€
1. **å‰ç«¯æ ‡æ³¨ç³»ç»Ÿ**: å®Œæ•´çš„æ ‡æ³¨åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€è¯„è®ºåŠŸèƒ½
2. **WebSocketé€šä¿¡**: å‰åç«¯æ¶ˆæ¯ä¼ é€’æœºåˆ¶å·²å»ºç«‹
3. **ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆ**: ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨æ ‡æ³¨æ•°æ®
4. **æ ‡æ³¨æ•°æ®æ¨¡å‹**: å®Œæ•´çš„æ•°æ®ç»“æ„å®šä¹‰

### ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆçš„é—®é¢˜
- **æ•°æ®åˆ†æ•£**: æ¯ä¸ªPDFæ–‡ä»¶ä¸€ä¸ªJSONæ–‡ä»¶ï¼Œç®¡ç†å›°éš¾
- **æŸ¥è¯¢æ•ˆç‡ä½**: æ— æ³•å¿«é€ŸæŸ¥è¯¢å¤šä¸ªPDFçš„æ ‡æ³¨
- **å¹¶å‘é—®é¢˜**: å¤šè¿›ç¨‹/å¤šç”¨æˆ·å¯èƒ½å¯¼è‡´æ•°æ®è¦†ç›–
- **æ— å¤‡ä»½æœºåˆ¶**: æ–‡ä»¶æŸååˆ™æ•°æ®ä¸¢å¤±
- **æ— å†å²è®°å½•**: åˆ é™¤/ä¿®æ”¹åæ— æ³•æ¢å¤

## å­˜åœ¨é—®é¢˜

### æ•°æ®æŒä¹…åŒ–é—®é¢˜
1. **æ•°æ®å®‰å…¨**: JSONæ–‡ä»¶æ˜“æŸåï¼Œæ— äº‹åŠ¡ä¿è¯
2. **æ€§èƒ½é—®é¢˜**: å¤§é‡æ ‡æ³¨æ—¶åŠ è½½å’Œä¿å­˜æ…¢
3. **æŸ¥è¯¢èƒ½åŠ›å¼±**: æ— æ³•è·¨PDFæŸ¥è¯¢æ ‡æ³¨
4. **æ‰©å±•æ€§å·®**: æ— æ³•æ”¯æŒé«˜çº§åŠŸèƒ½ï¼ˆæœç´¢ã€ç»Ÿè®¡ï¼‰
5. **å¤‡ä»½å›°éš¾**: æ— è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤æœºåˆ¶

### æ•°æ®ç®¡ç†é—®é¢˜
1. **æ— å¢é‡æ›´æ–°**: æ¯æ¬¡ä¿å­˜æ•´ä¸ªæ ‡æ³¨åˆ—è¡¨
2. **æ— å†²çªæ£€æµ‹**: å¹¶å‘ä¿®æ”¹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
3. **æ— å†å²ç‰ˆæœ¬**: è¯¯åˆ é™¤åæ— æ³•æ¢å¤
4. **æ— æ•°æ®è¿ç§»**: å‡çº§æ•°æ®ç»“æ„å›°éš¾

## æå‡ºéœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚ï¼ˆç¬¬ä¸‰æœŸï¼‰

#### 1. æ ‡æ³¨æ•°æ®çš„ä¿å­˜

**æ•°æ®åº“è®¾è®¡**

##### æ•°æ®åº“é€‰å‹
- **SQLite**: è½»é‡çº§ã€æ— éœ€æœåŠ¡å™¨ã€æ”¯æŒäº‹åŠ¡ã€è·¨å¹³å°
- **è¡¨ç»“æ„**: annotationsï¼ˆæ ‡æ³¨ï¼‰ã€commentsï¼ˆè¯„è®ºï¼‰ã€annotation_historyï¼ˆå†å²ï¼‰

##### è¡¨ç»“æ„è®¾è®¡

**annotationsè¡¨**
```sql
CREATE TABLE annotations (
    id TEXT PRIMARY KEY,                    -- æ ‡æ³¨ID (UUID)
    pdf_path TEXT NOT NULL,                 -- PDFæ–‡ä»¶è·¯å¾„
    type TEXT NOT NULL,                     -- æ ‡æ³¨ç±»å‹ (screenshot|text-highlight|comment)
    page_number INTEGER NOT NULL,           -- é¡µç 
    data TEXT NOT NULL,                     -- ç±»å‹ç‰¹å®šæ•°æ® (JSONæ ¼å¼)
    created_at TEXT NOT NULL,               -- åˆ›å»ºæ—¶é—´ (ISO 8601)
    updated_at TEXT NOT NULL,               -- ä¿®æ”¹æ—¶é—´ (ISO 8601)
    deleted_at TEXT,                        -- è½¯åˆ é™¤æ—¶é—´ (NULLè¡¨ç¤ºæœªåˆ é™¤)
    version INTEGER DEFAULT 1               -- ç‰ˆæœ¬å·ï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰
);

-- ç´¢å¼•
CREATE INDEX idx_pdf_path ON annotations(pdf_path);
CREATE INDEX idx_page_number ON annotations(page_number);
CREATE INDEX idx_type ON annotations(type);
CREATE INDEX idx_created_at ON annotations(created_at);
CREATE INDEX idx_deleted_at ON annotations(deleted_at);
```

**dataå­—æ®µJSONæ ¼å¼ç¤ºä¾‹**:
```javascript
// æˆªå›¾æ ‡æ³¨
{
  "rect": { "x": 100, "y": 200, "width": 300, "height": 200 },
  "imageData": "data:image/png;base64,...",
  "description": "è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å›¾è¡¨"
}

// é€‰å­—æ ‡æ³¨
{
  "selectedText": "è¿™æ˜¯è¢«é€‰ä¸­çš„æ–‡æœ¬...",
  "textRanges": [{ "start": 120, "end": 180 }],
  "highlightColor": "#ffff00",
  "note": "è¿™æ®µè¯å¾ˆé‡è¦"
}

// æ‰¹æ³¨æ ‡æ³¨
{
  "position": { "x": 150, "y": 300 },
  "content": "è¿™é‡Œéœ€è¦è¿›ä¸€æ­¥ç ”ç©¶"
}
```

**commentsè¡¨**
```sql
CREATE TABLE comments (
    id TEXT PRIMARY KEY,                    -- è¯„è®ºID (UUID)
    annotation_id TEXT NOT NULL,            -- å…³è”çš„æ ‡æ³¨ID
    content TEXT NOT NULL,                  -- è¯„è®ºå†…å®¹
    created_at TEXT NOT NULL,               -- åˆ›å»ºæ—¶é—´
    deleted_at TEXT,                        -- è½¯åˆ é™¤æ—¶é—´
    FOREIGN KEY (annotation_id) REFERENCES annotations(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_annotation_id ON comments(annotation_id);
CREATE INDEX idx_deleted_at_comment ON comments(deleted_at);
```

**annotation_historyè¡¨**ï¼ˆå†å²è®°å½•ï¼‰
```sql
CREATE TABLE annotation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    annotation_id TEXT NOT NULL,            -- æ ‡æ³¨ID
    operation TEXT NOT NULL,                -- æ“ä½œç±»å‹ (CREATE|UPDATE|DELETE)
    data_before TEXT,                       -- æ“ä½œå‰çš„æ•°æ® (JSON)
    data_after TEXT,                        -- æ“ä½œåçš„æ•°æ® (JSON)
    timestamp TEXT NOT NULL,                -- æ“ä½œæ—¶é—´
    user TEXT DEFAULT 'default'             -- ç”¨æˆ·æ ‡è¯†ï¼ˆæœªæ¥æ‰©å±•ï¼‰
);

-- ç´¢å¼•
CREATE INDEX idx_annotation_id_history ON annotation_history(annotation_id);
CREATE INDEX idx_timestamp ON annotation_history(timestamp);
```

**ä¿å­˜æµç¨‹**

```
å‰ç«¯åˆ›å»ºæ ‡æ³¨
    â†“
å‘é€ annotation:create æ¶ˆæ¯
    â†“
åç«¯æ¥æ”¶æ¶ˆæ¯
    â†“
éªŒè¯æ•°æ®ï¼ˆå¿…å¡«å­—æ®µã€æ ¼å¼ï¼‰
    â†“
æ’å…¥ annotations è¡¨
    â†“
æ’å…¥ annotation_history è¡¨ï¼ˆæ“ä½œ=CREATEï¼‰
    â†“
è¿”å› annotation:created æ¶ˆæ¯
    â†“
å¹¿æ’­ annotation:list:updated æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
```

**å¹¶å‘å†²çªå¤„ç†**
- ä½¿ç”¨versionå­—æ®µå®ç°ä¹è§‚é”
- æ›´æ–°æ—¶æ£€æŸ¥versionæ˜¯å¦åŒ¹é…
- ä¸åŒ¹é…åˆ™è¿”å›å†²çªé”™è¯¯ï¼Œè¦æ±‚å®¢æˆ·ç«¯åˆ·æ–°æ•°æ®

#### 2. æ ‡æ³¨æ•°æ®çš„è¯»å–

**è¯»å–æ–¹å¼**

##### 2.1 æŒ‰PDFè·¯å¾„åŠ è½½å…¨éƒ¨æ ‡æ³¨
```python
def load_annotations(pdf_path):
    """
    åŠ è½½æŒ‡å®šPDFçš„æ‰€æœ‰æ ‡æ³¨

    å‚æ•°:
        pdf_path (str): PDFæ–‡ä»¶è·¯å¾„

    è¿”å›:
        List[dict]: æ ‡æ³¨åˆ—è¡¨
    """
    query = """
        SELECT id, pdf_path, type, page_number, data,
               created_at, updated_at, version
        FROM annotations
        WHERE pdf_path = ? AND deleted_at IS NULL
        ORDER BY created_at DESC
    """
    # æ‰§è¡ŒæŸ¥è¯¢...
```

**WebSocketæ¶ˆæ¯æ ¼å¼**:
```javascript
// è¯·æ±‚
{
  type: 'annotation:load',
  data: {
    pdfPath: '/path/to/document.pdf'
  }
}

// å“åº”
{
  type: 'annotation:loaded',
  data: {
    annotations: [
      {
        id: 'ann_001',
        type: 'screenshot',
        pageNumber: 23,
        data: { rect: {...}, imageData: '...' },
        createdAt: '2025-10-04T10:30:00Z',
        updatedAt: '2025-10-04T10:30:00Z',
        version: 1
      },
      // ...
    ]
  }
}
```

##### 2.2 æŒ‰é¡µç åŠ è½½æ ‡æ³¨ï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰
```python
def load_annotations_by_page(pdf_path, page_number):
    """
    åŠ è½½æŒ‡å®šé¡µçš„æ ‡æ³¨ï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰

    å‚æ•°:
        pdf_path (str): PDFæ–‡ä»¶è·¯å¾„
        page_number (int): é¡µç 

    è¿”å›:
        List[dict]: æ ‡æ³¨åˆ—è¡¨
    """
    query = """
        SELECT id, pdf_path, type, page_number, data,
               created_at, updated_at, version
        FROM annotations
        WHERE pdf_path = ? AND page_number = ? AND deleted_at IS NULL
        ORDER BY created_at DESC
    """
    # æ‰§è¡ŒæŸ¥è¯¢...
```

##### 2.3 æ‰¹é‡åŠ è½½è¯„è®º
```python
def load_comments(annotation_ids):
    """
    æ‰¹é‡åŠ è½½è¯„è®º

    å‚æ•°:
        annotation_ids (List[str]): æ ‡æ³¨IDåˆ—è¡¨

    è¿”å›:
        Dict[str, List[dict]]: {annotation_id: [comments]}
    """
    query = """
        SELECT id, annotation_id, content, created_at
        FROM comments
        WHERE annotation_id IN ({}) AND deleted_at IS NULL
        ORDER BY created_at ASC
    """.format(','.join(['?'] * len(annotation_ids)))
    # æ‰§è¡ŒæŸ¥è¯¢ï¼ŒæŒ‰annotation_idåˆ†ç»„...
```

**æ€§èƒ½ä¼˜åŒ–**
- **ç´¢å¼•**: åœ¨pdf_pathã€page_numberã€created_atä¸Šå»ºç«‹ç´¢å¼•
- **åˆ†é¡µåŠ è½½**: æ”¯æŒlimitå’Œoffsetå‚æ•°
- **æ‡’åŠ è½½**: ä»…åŠ è½½å½“å‰é¡µå’Œé™„è¿‘é¡µçš„æ ‡æ³¨
- **ç¼“å­˜**: åç«¯ç¼“å­˜æœ€è¿‘è®¿é—®çš„æ ‡æ³¨ï¼ˆLRU Cacheï¼‰

#### 3. æ ‡æ³¨æ•°æ®çš„æ›´æ–°

**æ›´æ–°æµç¨‹**

```
å‰ç«¯ä¿®æ”¹æ ‡æ³¨
    â†“
å‘é€ annotation:update æ¶ˆæ¯
    â†“
åç«¯æ¥æ”¶æ¶ˆæ¯
    â†“
æŸ¥è¯¢å½“å‰æ•°æ®ï¼ˆå«versionï¼‰
    â†“
æ£€æŸ¥versionæ˜¯å¦åŒ¹é…
    â†“ (ä¸åŒ¹é…)
è¿”å›å†²çªé”™è¯¯ â†’ å‰ç«¯åˆ·æ–°æ•°æ®
    â†“ (åŒ¹é…)
æ›´æ–° annotations è¡¨ï¼ˆversion+1ï¼‰
    â†“
æ’å…¥ annotation_history è¡¨ï¼ˆæ“ä½œ=UPDATEï¼‰
    â†“
è¿”å› annotation:updated æ¶ˆæ¯
    â†“
å¹¿æ’­ annotation:list:updated æ¶ˆæ¯
```

**WebSocketæ¶ˆæ¯æ ¼å¼**:
```javascript
// è¯·æ±‚
{
  type: 'annotation:update',
  data: {
    id: 'ann_001',
    changes: {
      data: { description: 'æ›´æ–°åçš„æè¿°' }
    },
    version: 1  // å½“å‰ç‰ˆæœ¬å·ï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰
  }
}

// æˆåŠŸå“åº”
{
  type: 'annotation:updated',
  data: {
    annotation: {
      id: 'ann_001',
      // ... å®Œæ•´æ•°æ®
      version: 2  // ç‰ˆæœ¬å·+1
    }
  }
}

// å†²çªå“åº”
{
  type: 'annotation:update:conflict',
  data: {
    id: 'ann_001',
    currentVersion: 3,  // æ•°æ®åº“ä¸­çš„æœ€æ–°ç‰ˆæœ¬
    message: 'æ ‡æ³¨å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•'
  }
}
```

**ä¹è§‚é”å®ç°**
```python
def update_annotation(annotation_id, changes, expected_version):
    """
    æ›´æ–°æ ‡æ³¨ï¼ˆä¹è§‚é”ï¼‰

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID
        changes (dict): è¦æ›´æ–°çš„å­—æ®µ
        expected_version (int): æœŸæœ›çš„ç‰ˆæœ¬å·

    è¿”å›:
        (bool, dict): (æ˜¯å¦æˆåŠŸ, æ›´æ–°åçš„æ•°æ®æˆ–é”™è¯¯ä¿¡æ¯)
    """
    # æŸ¥è¯¢å½“å‰æ•°æ®
    current = db.query("SELECT * FROM annotations WHERE id = ?", annotation_id)

    if current['version'] != expected_version:
        return (False, {
            'error': 'VERSION_CONFLICT',
            'currentVersion': current['version']
        })

    # æ›´æ–°æ•°æ®
    db.execute("""
        UPDATE annotations
        SET data = ?, updated_at = ?, version = version + 1
        WHERE id = ? AND version = ?
    """, json.dumps(changes['data']), now(), annotation_id, expected_version)

    # æ’å…¥å†å²è®°å½•
    db.execute("""
        INSERT INTO annotation_history (annotation_id, operation, data_before, data_after, timestamp)
        VALUES (?, 'UPDATE', ?, ?, ?)
    """, annotation_id, json.dumps(current), json.dumps(changes), now())

    # è¿”å›æ›´æ–°åçš„æ•°æ®
    updated = db.query("SELECT * FROM annotations WHERE id = ?", annotation_id)
    return (True, updated)
```

#### 4. æ ‡æ³¨æ•°æ®çš„åˆ é™¤

**è½¯åˆ é™¤æœºåˆ¶**
- ä¸çœŸæ­£åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯è®¾ç½®`deleted_at`å­—æ®µ
- æŸ¥è¯¢æ—¶è¿‡æ»¤`deleted_at IS NULL`çš„è®°å½•
- ä¿ç•™å†å²è®°å½•ï¼Œæ”¯æŒæ¢å¤

**åˆ é™¤æµç¨‹**

```
å‰ç«¯åˆ é™¤æ ‡æ³¨
    â†“
å‘é€ annotation:delete æ¶ˆæ¯
    â†“
åç«¯æ¥æ”¶æ¶ˆæ¯
    â†“
æŸ¥è¯¢å½“å‰æ•°æ®
    â†“
è½¯åˆ é™¤ï¼ˆè®¾ç½®deleted_atï¼‰
    â†“
æ’å…¥ annotation_history è¡¨ï¼ˆæ“ä½œ=DELETEï¼‰
    â†“
è¿”å› annotation:deleted æ¶ˆæ¯
    â†“
å¹¿æ’­ annotation:list:updated æ¶ˆæ¯
```

**WebSocketæ¶ˆæ¯æ ¼å¼**:
```javascript
// è¯·æ±‚
{
  type: 'annotation:delete',
  data: {
    id: 'ann_001'
  }
}

// å“åº”
{
  type: 'annotation:deleted',
  data: {
    id: 'ann_001',
    deletedAt: '2025-10-04T15:00:00Z'
  }
}
```

**Pythonå®ç°**:
```python
def delete_annotation(annotation_id):
    """
    è½¯åˆ é™¤æ ‡æ³¨

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID

    è¿”å›:
        bool: æ˜¯å¦æˆåŠŸ
    """
    # æŸ¥è¯¢å½“å‰æ•°æ®
    current = db.query("SELECT * FROM annotations WHERE id = ? AND deleted_at IS NULL", annotation_id)

    if not current:
        return False

    # è½¯åˆ é™¤
    now_time = datetime.now().isoformat()
    db.execute("""
        UPDATE annotations
        SET deleted_at = ?, version = version + 1
        WHERE id = ?
    """, now_time, annotation_id)

    # æ’å…¥å†å²è®°å½•
    db.execute("""
        INSERT INTO annotation_history (annotation_id, operation, data_before, timestamp)
        VALUES (?, 'DELETE', ?, ?)
    """, annotation_id, json.dumps(current), now_time)

    return True
```

#### 5. è¯„è®ºçš„å¢åŠ 

**æ·»åŠ è¯„è®ºæµç¨‹**

```
å‰ç«¯æ·»åŠ è¯„è®º
    â†“
å‘é€ annotation:comment:add æ¶ˆæ¯
    â†“
åç«¯æ¥æ”¶æ¶ˆæ¯
    â†“
éªŒè¯æ ‡æ³¨æ˜¯å¦å­˜åœ¨
    â†“
æ’å…¥ comments è¡¨
    â†“
æ›´æ–°æ ‡æ³¨çš„ updated_at å­—æ®µ
    â†“
è¿”å› annotation:comment:added æ¶ˆæ¯
    â†“
å¹¿æ’­è¯„è®ºæ›´æ–°ï¼ˆå¯é€‰ï¼‰
```

**WebSocketæ¶ˆæ¯æ ¼å¼**:
```javascript
// è¯·æ±‚
{
  type: 'annotation:comment:add',
  data: {
    annotationId: 'ann_001',
    content: 'è¿™æ˜¯ä¸€æ¡è¯„è®º'
  }
}

// å“åº”
{
  type: 'annotation:comment:added',
  data: {
    comment: {
      id: 'comment_001',
      annotationId: 'ann_001',
      content: 'è¿™æ˜¯ä¸€æ¡è¯„è®º',
      createdAt: '2025-10-04T16:00:00Z'
    }
  }
}
```

**Pythonå®ç°**:
```python
def add_comment(annotation_id, content):
    """
    æ·»åŠ è¯„è®º

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID
        content (str): è¯„è®ºå†…å®¹

    è¿”å›:
        dict: åˆ›å»ºçš„è¯„è®º
    """
    # éªŒè¯æ ‡æ³¨å­˜åœ¨
    annotation = db.query("SELECT id FROM annotations WHERE id = ? AND deleted_at IS NULL", annotation_id)
    if not annotation:
        raise ValueError("æ ‡æ³¨ä¸å­˜åœ¨")

    # åˆ›å»ºè¯„è®º
    comment_id = generate_uuid()
    now_time = datetime.now().isoformat()

    db.execute("""
        INSERT INTO comments (id, annotation_id, content, created_at)
        VALUES (?, ?, ?, ?)
    """, comment_id, annotation_id, content, now_time)

    # æ›´æ–°æ ‡æ³¨çš„ä¿®æ”¹æ—¶é—´
    db.execute("""
        UPDATE annotations
        SET updated_at = ?
        WHERE id = ?
    """, now_time, annotation_id)

    return {
        'id': comment_id,
        'annotationId': annotation_id,
        'content': content,
        'createdAt': now_time
    }
```

#### 6. è¯„è®ºçš„åˆ é™¤

**åˆ é™¤è¯„è®ºæµç¨‹**

```
å‰ç«¯åˆ é™¤è¯„è®º
    â†“
å‘é€ annotation:comment:delete æ¶ˆæ¯
    â†“
åç«¯æ¥æ”¶æ¶ˆæ¯
    â†“
è½¯åˆ é™¤è¯„è®ºï¼ˆè®¾ç½®deleted_atï¼‰
    â†“
è¿”å› annotation:comment:deleted æ¶ˆæ¯
```

**WebSocketæ¶ˆæ¯æ ¼å¼**:
```javascript
// è¯·æ±‚
{
  type: 'annotation:comment:delete',
  data: {
    commentId: 'comment_001'
  }
}

// å“åº”
{
  type: 'annotation:comment:deleted',
  data: {
    commentId: 'comment_001'
  }
}
```

**Pythonå®ç°**:
```python
def delete_comment(comment_id):
    """
    è½¯åˆ é™¤è¯„è®º

    å‚æ•°:
        comment_id (str): è¯„è®ºID

    è¿”å›:
        bool: æ˜¯å¦æˆåŠŸ
    """
    now_time = datetime.now().isoformat()

    rows_affected = db.execute("""
        UPDATE comments
        SET deleted_at = ?
        WHERE id = ? AND deleted_at IS NULL
    """, now_time, comment_id)

    return rows_affected > 0
```

### é«˜çº§åŠŸèƒ½éœ€æ±‚

#### 7. å†å²è®°å½•å’Œæ¢å¤

**æŸ¥çœ‹å†å²è®°å½•**
```python
def get_annotation_history(annotation_id):
    """
    è·å–æ ‡æ³¨çš„å†å²è®°å½•

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID

    è¿”å›:
        List[dict]: å†å²è®°å½•åˆ—è¡¨
    """
    query = """
        SELECT id, operation, data_before, data_after, timestamp
        FROM annotation_history
        WHERE annotation_id = ?
        ORDER BY timestamp DESC
    """
    return db.query_all(query, annotation_id)
```

**æ¢å¤å·²åˆ é™¤çš„æ ‡æ³¨**
```python
def restore_annotation(annotation_id):
    """
    æ¢å¤å·²åˆ é™¤çš„æ ‡æ³¨

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID

    è¿”å›:
        dict: æ¢å¤åçš„æ ‡æ³¨
    """
    db.execute("""
        UPDATE annotations
        SET deleted_at = NULL, version = version + 1
        WHERE id = ?
    """, annotation_id)

    # æ’å…¥å†å²è®°å½•
    db.execute("""
        INSERT INTO annotation_history (annotation_id, operation, timestamp)
        VALUES (?, 'RESTORE', ?)
    """, annotation_id, datetime.now().isoformat())

    return db.query("SELECT * FROM annotations WHERE id = ?", annotation_id)
```

#### 8. æ•°æ®å¤‡ä»½å’Œå¯¼å‡º

**å¯¼å‡ºä¸ºJSON**
```python
def export_annotations(pdf_path, format='json'):
    """
    å¯¼å‡ºæ ‡æ³¨æ•°æ®

    å‚æ•°:
        pdf_path (str): PDFæ–‡ä»¶è·¯å¾„
        format (str): å¯¼å‡ºæ ¼å¼ ('json'|'markdown'|'csv')

    è¿”å›:
        str: å¯¼å‡ºçš„æ•°æ®
    """
    annotations = load_annotations(pdf_path)

    if format == 'json':
        return json.dumps(annotations, indent=2, ensure_ascii=False)

    elif format == 'markdown':
        # ç”ŸæˆMarkdownæ ¼å¼
        lines = [f"# {pdf_path} æ ‡æ³¨\n"]
        for ann in annotations:
            lines.append(f"## é¡µç  {ann['page_number']}\n")
            lines.append(f"- **ç±»å‹**: {ann['type']}\n")
            lines.append(f"- **æ—¶é—´**: {ann['created_at']}\n")
            # ...
        return '\n'.join(lines)

    elif format == 'csv':
        # ç”ŸæˆCSVæ ¼å¼
        import csv
        # ...
```

**å¯¼å…¥æ ‡æ³¨æ•°æ®**
```python
def import_annotations(pdf_path, data, format='json'):
    """
    å¯¼å…¥æ ‡æ³¨æ•°æ®

    å‚æ•°:
        pdf_path (str): PDFæ–‡ä»¶è·¯å¾„
        data (str): å¯¼å…¥çš„æ•°æ®
        format (str): æ•°æ®æ ¼å¼

    è¿”å›:
        int: å¯¼å…¥çš„æ ‡æ³¨æ•°é‡
    """
    if format == 'json':
        annotations = json.loads(data)

        count = 0
        for ann in annotations:
            # åˆ›å»ºæ ‡æ³¨
            create_annotation(ann)
            count += 1

        return count
```

#### 9. æ•°æ®ç»Ÿè®¡

**ç»Ÿè®¡æ ‡æ³¨æ•°é‡**
```python
def get_annotation_stats(pdf_path=None):
    """
    è·å–æ ‡æ³¨ç»Ÿè®¡ä¿¡æ¯

    å‚æ•°:
        pdf_path (str, optional): PDFæ–‡ä»¶è·¯å¾„ï¼ˆNoneè¡¨ç¤ºå…¨éƒ¨ï¼‰

    è¿”å›:
        dict: ç»Ÿè®¡ä¿¡æ¯
    """
    if pdf_path:
        query = """
            SELECT
                COUNT(*) as total,
                SUM(CASE WHEN type = 'screenshot' THEN 1 ELSE 0 END) as screenshots,
                SUM(CASE WHEN type = 'text-highlight' THEN 1 ELSE 0 END) as highlights,
                SUM(CASE WHEN type = 'comment' THEN 1 ELSE 0 END) as comments
            FROM annotations
            WHERE pdf_path = ? AND deleted_at IS NULL
        """
        result = db.query(query, pdf_path)
    else:
        query = """
            SELECT
                COUNT(*) as total,
                SUM(CASE WHEN type = 'screenshot' THEN 1 ELSE 0 END) as screenshots,
                SUM(CASE WHEN type = 'text-highlight' THEN 1 ELSE 0 END) as highlights,
                SUM(CASE WHEN type = 'comment' THEN 1 ELSE 0 END) as comments,
                COUNT(DISTINCT pdf_path) as pdf_count
            FROM annotations
            WHERE deleted_at IS NULL
        """
        result = db.query(query)

    return result
```

### æ€§èƒ½è¦æ±‚
- **æ•°æ®åº“æŸ¥è¯¢æ—¶é—´**: < 100msï¼ˆ1000ä¸ªæ ‡æ³¨ï¼‰
- **æ’å…¥/æ›´æ–°æ—¶é—´**: < 50msï¼ˆå•æ¡è®°å½•ï¼‰
- **æ‰¹é‡åŠ è½½æ—¶é—´**: < 500msï¼ˆåŠ è½½100ä¸ªæ ‡æ³¨åŠè¯„è®ºï¼‰
- **å¯¼å‡ºæ—¶é—´**: < 2ç§’ï¼ˆ1000ä¸ªæ ‡æ³¨ï¼‰
- **å¤‡ä»½æ—¶é—´**: < 5ç§’ï¼ˆå®Œæ•´æ•°æ®åº“å¤‡ä»½ï¼‰

### æ•°æ®å®‰å…¨è¦æ±‚
- ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- å®šæœŸè‡ªåŠ¨å¤‡ä»½æ•°æ®åº“ï¼ˆæ¯æ—¥å¤‡ä»½ï¼‰
- æ•°æ®åº“æ–‡ä»¶æƒé™æ§åˆ¶ï¼ˆä»…åº”ç”¨å¯è¯»å†™ï¼‰
- SQLæ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- æ•æ„Ÿæ•°æ®åŠ å¯†ï¼ˆbase64å›¾ç‰‡æ•°æ®å‹ç¼©ï¼‰

## è§£å†³æ–¹æ¡ˆ

### æŠ€æœ¯æ¶æ„

#### åç«¯ç›®å½•ç»“æ„
```
src/backend/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ connection.py            # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ migrations/              # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ 001_create_tables.sql
â”‚   â”‚   â”œâ”€â”€ 002_add_indexes.sql
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ annotation.py        # Annotation ORMæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ comment.py           # Comment ORMæ¨¡å‹
â”‚   â”‚   â””â”€â”€ history.py           # History ORMæ¨¡å‹
â”‚   â””â”€â”€ repositories/
â”‚       â”œâ”€â”€ annotation_repository.py  # æ ‡æ³¨æ•°æ®è®¿é—®å±‚
â”‚       â”œâ”€â”€ comment_repository.py     # è¯„è®ºæ•°æ®è®¿é—®å±‚
â”‚       â””â”€â”€ history_repository.py     # å†å²æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ annotation_service.py    # æ ‡æ³¨ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ comment_service.py       # è¯„è®ºä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ backup_service.py        # å¤‡ä»½æœåŠ¡
â”‚   â””â”€â”€ migration_service.py     # æ•°æ®è¿ç§»æœåŠ¡
â”œâ”€â”€ websocket/
â”‚   â”œâ”€â”€ annotation_handler.py    # WebSocketæ¶ˆæ¯å¤„ç†å™¨
â”‚   â””â”€â”€ ...
â””â”€â”€ utils/
    â”œâ”€â”€ uuid_generator.py        # UUIDç”Ÿæˆå·¥å…·
    â””â”€â”€ date_helper.py           # æ—¥æœŸå¤„ç†å·¥å…·
```

### æ ¸å¿ƒç±»è®¾è®¡

#### AnnotationRepositoryç±»
```python
"""
æ ‡æ³¨æ•°æ®è®¿é—®å±‚
"""
class AnnotationRepository:
    def __init__(self, db_connection):
        self.db = db_connection

    def create(self, annotation: dict) -> dict:
        """åˆ›å»ºæ ‡æ³¨"""
        pass

    def find_by_id(self, annotation_id: str) -> dict:
        """æ ¹æ®IDæŸ¥è¯¢æ ‡æ³¨"""
        pass

    def find_by_pdf_path(self, pdf_path: str) -> list:
        """æ ¹æ®PDFè·¯å¾„æŸ¥è¯¢æ‰€æœ‰æ ‡æ³¨"""
        pass

    def find_by_page(self, pdf_path: str, page_number: int) -> list:
        """æ ¹æ®é¡µç æŸ¥è¯¢æ ‡æ³¨"""
        pass

    def update(self, annotation_id: str, changes: dict, expected_version: int) -> tuple:
        """æ›´æ–°æ ‡æ³¨ï¼ˆä¹è§‚é”ï¼‰"""
        pass

    def soft_delete(self, annotation_id: str) -> bool:
        """è½¯åˆ é™¤æ ‡æ³¨"""
        pass

    def restore(self, annotation_id: str) -> dict:
        """æ¢å¤å·²åˆ é™¤çš„æ ‡æ³¨"""
        pass

    def count_by_type(self, pdf_path: str = None) -> dict:
        """ç»Ÿè®¡æ ‡æ³¨æ•°é‡"""
        pass
```

#### AnnotationServiceç±»
```python
"""
æ ‡æ³¨ä¸šåŠ¡é€»è¾‘å±‚
"""
class AnnotationService:
    def __init__(self, annotation_repo, comment_repo, history_repo):
        self.annotation_repo = annotation_repo
        self.comment_repo = comment_repo
        self.history_repo = history_repo

    def create_annotation(self, data: dict) -> dict:
        """
        åˆ›å»ºæ ‡æ³¨
        - éªŒè¯æ•°æ®
        - è°ƒç”¨repositoryä¿å­˜
        - è®°å½•å†å²
        - è¿”å›ç»“æœ
        """
        pass

    def update_annotation(self, annotation_id: str, changes: dict, version: int) -> dict:
        """
        æ›´æ–°æ ‡æ³¨
        - ä¹è§‚é”æ£€æŸ¥
        - æ›´æ–°æ•°æ®
        - è®°å½•å†å²
        """
        pass

    def delete_annotation(self, annotation_id: str) -> bool:
        """
        åˆ é™¤æ ‡æ³¨
        - è½¯åˆ é™¤
        - è®°å½•å†å²
        """
        pass

    def load_annotations(self, pdf_path: str, page_number: int = None) -> list:
        """
        åŠ è½½æ ‡æ³¨
        - æ”¯æŒå…¨éƒ¨åŠ è½½æˆ–æŒ‰é¡µåŠ è½½
        - æ‰¹é‡åŠ è½½è¯„è®º
        """
        pass

    def add_comment(self, annotation_id: str, content: str) -> dict:
        """æ·»åŠ è¯„è®º"""
        pass

    def delete_comment(self, comment_id: str) -> bool:
        """åˆ é™¤è¯„è®º"""
        pass

    def get_history(self, annotation_id: str) -> list:
        """è·å–å†å²è®°å½•"""
        pass

    def restore_annotation(self, annotation_id: str) -> dict:
        """æ¢å¤å·²åˆ é™¤çš„æ ‡æ³¨"""
        pass
```

#### AnnotationHandlerç±»ï¼ˆWebSocketï¼‰
```python
"""
WebSocketæ¶ˆæ¯å¤„ç†å™¨
"""
class AnnotationHandler:
    def __init__(self, annotation_service):
        self.service = annotation_service

    async def handle_create(self, message: dict, websocket):
        """å¤„ç†åˆ›å»ºæ ‡æ³¨æ¶ˆæ¯"""
        try:
            data = message['data']
            annotation = self.service.create_annotation(data)

            # è¿”å›æˆåŠŸæ¶ˆæ¯
            await websocket.send(json.dumps({
                'type': 'annotation:created',
                'data': {'annotation': annotation}
            }))

            # å¹¿æ’­åˆ—è¡¨æ›´æ–°
            await self.broadcast_list_updated(data['pdfPath'])

        except Exception as e:
            # è¿”å›é”™è¯¯æ¶ˆæ¯
            await websocket.send(json.dumps({
                'type': 'annotation:create:error',
                'data': {'error': str(e)}
            }))

    async def handle_update(self, message: dict, websocket):
        """å¤„ç†æ›´æ–°æ ‡æ³¨æ¶ˆæ¯"""
        try:
            data = message['data']
            annotation = self.service.update_annotation(
                data['id'],
                data['changes'],
                data['version']
            )

            await websocket.send(json.dumps({
                'type': 'annotation:updated',
                'data': {'annotation': annotation}
            }))

        except VersionConflictError as e:
            # è¿”å›å†²çªæ¶ˆæ¯
            await websocket.send(json.dumps({
                'type': 'annotation:update:conflict',
                'data': {
                    'id': data['id'],
                    'currentVersion': e.current_version,
                    'message': 'æ ‡æ³¨å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•'
                }
            }))

    async def handle_delete(self, message: dict, websocket):
        """å¤„ç†åˆ é™¤æ ‡æ³¨æ¶ˆæ¯"""
        pass

    async def handle_load(self, message: dict, websocket):
        """å¤„ç†åŠ è½½æ ‡æ³¨æ¶ˆæ¯"""
        pass

    async def handle_comment_add(self, message: dict, websocket):
        """å¤„ç†æ·»åŠ è¯„è®ºæ¶ˆæ¯"""
        pass

    async def handle_comment_delete(self, message: dict, websocket):
        """å¤„ç†åˆ é™¤è¯„è®ºæ¶ˆæ¯"""
        pass
```

#### DatabaseConnectionç±»
```python
"""
æ•°æ®åº“è¿æ¥ç®¡ç†
"""
import sqlite3
from contextlib import contextmanager

class DatabaseConnection:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.connection = None

    def connect(self):
        """å»ºç«‹è¿æ¥"""
        self.connection = sqlite3.connect(self.db_path)
        self.connection.row_factory = sqlite3.Row  # è¿”å›å­—å…¸æ ¼å¼
        return self.connection

    def close(self):
        """å…³é—­è¿æ¥"""
        if self.connection:
            self.connection.close()

    @contextmanager
    def transaction(self):
        """äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        try:
            yield self.connection
            self.connection.commit()
        except Exception as e:
            self.connection.rollback()
            raise e

    def execute(self, query: str, params: tuple = ()):
        """æ‰§è¡ŒSQLï¼ˆINSERT/UPDATE/DELETEï¼‰"""
        cursor = self.connection.cursor()
        cursor.execute(query, params)
        return cursor.rowcount

    def query_one(self, query: str, params: tuple = ()):
        """æŸ¥è¯¢å•æ¡è®°å½•"""
        cursor = self.connection.cursor()
        cursor.execute(query, params)
        row = cursor.fetchone()
        return dict(row) if row else None

    def query_all(self, query: str, params: tuple = ()):
        """æŸ¥è¯¢å¤šæ¡è®°å½•"""
        cursor = self.connection.cursor()
        cursor.execute(query, params)
        rows = cursor.fetchall()
        return [dict(row) for row in rows]
```

#### MigrationServiceç±»
```python
"""
æ•°æ®åº“è¿ç§»æœåŠ¡
"""
class MigrationService:
    def __init__(self, db_connection):
        self.db = db_connection

    def run_migrations(self):
        """æ‰§è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»"""
        # åˆ›å»ºmigrationsè¡¨ï¼ˆè®°å½•å·²æ‰§è¡Œçš„è¿ç§»ï¼‰
        self.db.execute("""
            CREATE TABLE IF NOT EXISTS migrations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE,
                executed_at TEXT NOT NULL
            )
        """)

        # è·å–å·²æ‰§è¡Œçš„è¿ç§»
        executed = self.db.query_all("SELECT name FROM migrations")
        executed_names = [m['name'] for m in executed]

        # åŠ è½½è¿ç§»æ–‡ä»¶
        migration_files = self._load_migration_files()

        # æ‰§è¡Œæœªæ‰§è¡Œçš„è¿ç§»
        for name, sql in migration_files:
            if name not in executed_names:
                print(f"æ‰§è¡Œè¿ç§»: {name}")
                self.db.execute(sql)
                self.db.execute(
                    "INSERT INTO migrations (name, executed_at) VALUES (?, ?)",
                    (name, datetime.now().isoformat())
                )

    def _load_migration_files(self):
        """åŠ è½½è¿ç§»æ–‡ä»¶"""
        import os
        migration_dir = os.path.join(os.path.dirname(__file__), 'migrations')
        files = sorted(os.listdir(migration_dir))

        migrations = []
        for filename in files:
            if filename.endswith('.sql'):
                path = os.path.join(migration_dir, filename)
                with open(path, 'r', encoding='utf-8') as f:
                    sql = f.read()
                    migrations.append((filename, sql))

        return migrations
```

#### BackupServiceç±»
```python
"""
å¤‡ä»½æœåŠ¡
"""
import shutil
from datetime import datetime

class BackupService:
    def __init__(self, db_path: str, backup_dir: str):
        self.db_path = db_path
        self.backup_dir = backup_dir

    def create_backup(self):
        """åˆ›å»ºå¤‡ä»½"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_name = f"annotations_backup_{timestamp}.db"
        backup_path = os.path.join(self.backup_dir, backup_name)

        # å¤åˆ¶æ•°æ®åº“æ–‡ä»¶
        shutil.copy2(self.db_path, backup_path)

        print(f"å¤‡ä»½å·²åˆ›å»º: {backup_path}")
        return backup_path

    def restore_backup(self, backup_path: str):
        """æ¢å¤å¤‡ä»½"""
        # éªŒè¯å¤‡ä»½æ–‡ä»¶å­˜åœ¨
        if not os.path.exists(backup_path):
            raise FileNotFoundError(f"å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: {backup_path}")

        # å¤‡ä»½å½“å‰æ•°æ®åº“ï¼ˆä»¥é˜²æ¢å¤å¤±è´¥ï¼‰
        self.create_backup()

        # æ¢å¤å¤‡ä»½
        shutil.copy2(backup_path, self.db_path)

        print(f"å¤‡ä»½å·²æ¢å¤: {backup_path}")

    def list_backups(self):
        """åˆ—å‡ºæ‰€æœ‰å¤‡ä»½"""
        import glob
        pattern = os.path.join(self.backup_dir, 'annotations_backup_*.db')
        backups = glob.glob(pattern)
        return sorted(backups, reverse=True)

    def cleanup_old_backups(self, keep_days: int = 30):
        """æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘Nå¤©ï¼‰"""
        import time
        cutoff_time = time.time() - (keep_days * 24 * 60 * 60)

        for backup_path in self.list_backups():
            if os.path.getmtime(backup_path) < cutoff_time:
                os.remove(backup_path)
                print(f"å·²åˆ é™¤æ—§å¤‡ä»½: {backup_path}")
```

### æ•°æ®åº“è¿ç§»è„šæœ¬

#### 001_create_tables.sql
```sql
-- åˆ›å»ºæ ‡æ³¨è¡¨
CREATE TABLE IF NOT EXISTS annotations (
    id TEXT PRIMARY KEY,
    pdf_path TEXT NOT NULL,
    type TEXT NOT NULL,
    page_number INTEGER NOT NULL,
    data TEXT NOT NULL,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    deleted_at TEXT,
    version INTEGER DEFAULT 1
);

-- åˆ›å»ºè¯„è®ºè¡¨
CREATE TABLE IF NOT EXISTS comments (
    id TEXT PRIMARY KEY,
    annotation_id TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TEXT NOT NULL,
    deleted_at TEXT,
    FOREIGN KEY (annotation_id) REFERENCES annotations(id) ON DELETE CASCADE
);

-- åˆ›å»ºå†å²è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS annotation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    annotation_id TEXT NOT NULL,
    operation TEXT NOT NULL,
    data_before TEXT,
    data_after TEXT,
    timestamp TEXT NOT NULL,
    user TEXT DEFAULT 'default'
);
```

#### 002_add_indexes.sql
```sql
-- æ ‡æ³¨è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_pdf_path ON annotations(pdf_path);
CREATE INDEX IF NOT EXISTS idx_page_number ON annotations(page_number);
CREATE INDEX IF NOT EXISTS idx_type ON annotations(type);
CREATE INDEX IF NOT EXISTS idx_created_at ON annotations(created_at);
CREATE INDEX IF NOT EXISTS idx_deleted_at ON annotations(deleted_at);

-- è¯„è®ºè¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_annotation_id ON comments(annotation_id);
CREATE INDEX IF NOT EXISTS idx_deleted_at_comment ON comments(deleted_at);

-- å†å²è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_annotation_id_history ON annotation_history(annotation_id);
CREATE INDEX IF NOT EXISTS idx_timestamp ON annotation_history(timestamp);
```

## çº¦æŸæ¡ä»¶

### ä»…ä¿®æ”¹åç«¯ä»£ç 
ä»…ä¿®æ”¹ `src/backend/` ä¸­çš„ä»£ç ï¼Œå‰ç«¯æ¥å£ä¿æŒå…¼å®¹

### å‘åå…¼å®¹
- æ”¯æŒä»JSONæ–‡ä»¶è¿ç§»åˆ°æ•°æ®åº“
- WebSocketæ¶ˆæ¯æ ¼å¼ä¿æŒå…¼å®¹
- ä¸ç ´åç¬¬ä¸€æœŸå’Œç¬¬äºŒæœŸåŠŸèƒ½

### æ•°æ®å®‰å…¨
- ä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- SQLæ³¨å…¥é˜²æŠ¤
- å®šæœŸè‡ªåŠ¨å¤‡ä»½
- è½¯åˆ é™¤æœºåˆ¶

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- æ”¯æŒæ‡’åŠ è½½å’Œåˆ†é¡µ
- æ‰¹é‡æ“ä½œä¼˜åŒ–

## å¯è¡ŒéªŒæ”¶æ ‡å‡†

### å•å…ƒæµ‹è¯•

#### AnnotationRepositoryæµ‹è¯•
- âœ… createæ­£ç¡®æ’å…¥æ ‡æ³¨
- âœ… find_by_idæ­£ç¡®æŸ¥è¯¢æ ‡æ³¨
- âœ… find_by_pdf_pathæ­£ç¡®æŸ¥è¯¢æ‰€æœ‰æ ‡æ³¨
- âœ… find_by_pageæ­£ç¡®æŒ‰é¡µæŸ¥è¯¢
- âœ… updateä¹è§‚é”æ­£å¸¸å·¥ä½œ
- âœ… soft_deleteæ­£ç¡®è½¯åˆ é™¤
- âœ… restoreæ­£ç¡®æ¢å¤å·²åˆ é™¤æ ‡æ³¨

#### AnnotationServiceæµ‹è¯•
- âœ… create_annotationåˆ›å»ºæ ‡æ³¨å¹¶è®°å½•å†å²
- âœ… update_annotationç‰ˆæœ¬å†²çªæ£€æµ‹
- âœ… delete_annotationè½¯åˆ é™¤å¹¶è®°å½•å†å²
- âœ… add_commentæ­£ç¡®æ·»åŠ è¯„è®º
- âœ… load_annotationsæ‰¹é‡åŠ è½½è¯„è®º

#### DatabaseConnectionæµ‹è¯•
- âœ… transactionäº‹åŠ¡å›æ»šæ­£å¸¸å·¥ä½œ
- âœ… executeæ­£ç¡®æ‰§è¡ŒSQL
- âœ… query_oneè¿”å›å­—å…¸æ ¼å¼
- âœ… query_allè¿”å›åˆ—è¡¨

#### BackupServiceæµ‹è¯•
- âœ… create_backupåˆ›å»ºå¤‡ä»½æ–‡ä»¶
- âœ… restore_backupæ¢å¤å¤‡ä»½
- âœ… cleanup_old_backupsæ¸…ç†æ—§å¤‡ä»½

### é›†æˆæµ‹è¯•

#### æµ‹è¯•1: å®Œæ•´CRUDæµç¨‹
1. åˆ›å»ºæ ‡æ³¨
2. éªŒè¯ï¼šæ•°æ®åº“ä¸­æœ‰è®°å½•ï¼Œå†å²è¡¨æœ‰CREATEè®°å½•
3. æ›´æ–°æ ‡æ³¨
4. éªŒè¯ï¼šversion+1ï¼Œå†å²è¡¨æœ‰UPDATEè®°å½•
5. åˆ é™¤æ ‡æ³¨
6. éªŒè¯ï¼šdeleted_atä¸ä¸ºç©ºï¼Œå†å²è¡¨æœ‰DELETEè®°å½•
7. æ¢å¤æ ‡æ³¨
8. éªŒè¯ï¼šdeleted_atä¸ºç©ºï¼Œå†å²è¡¨æœ‰RESTOREè®°å½•

#### æµ‹è¯•2: å¹¶å‘å†²çªæ£€æµ‹
1. åŠ è½½æ ‡æ³¨ï¼ˆversion=1ï¼‰
2. æ¨¡æ‹Ÿå¦ä¸€ä¸ªå®¢æˆ·ç«¯æ›´æ–°ï¼ˆversionå˜ä¸º2ï¼‰
3. å°è¯•æ›´æ–°ï¼ˆä½¿ç”¨version=1ï¼‰
4. éªŒè¯ï¼šè¿”å›å†²çªé”™è¯¯ï¼Œversionæœªæ”¹å˜

#### æµ‹è¯•3: è¯„è®ºå…³è”åˆ é™¤
1. åˆ›å»ºæ ‡æ³¨å’Œ3æ¡è¯„è®º
2. åˆ é™¤æ ‡æ³¨
3. éªŒè¯ï¼šæ ‡æ³¨å’Œè¯„è®ºéƒ½è¢«è½¯åˆ é™¤

#### æµ‹è¯•4: æ€§èƒ½æµ‹è¯•
1. æ’å…¥1000ä¸ªæ ‡æ³¨
2. éªŒè¯ï¼šæ’å…¥æ—¶é—´ < 5ç§’
3. æŸ¥è¯¢æ‰€æœ‰æ ‡æ³¨
4. éªŒè¯ï¼šæŸ¥è¯¢æ—¶é—´ < 100ms
5. æ‰¹é‡åŠ è½½è¯„è®º
6. éªŒè¯ï¼šåŠ è½½æ—¶é—´ < 500ms

#### æµ‹è¯•5: å¤‡ä»½å’Œæ¢å¤
1. åˆ›å»º10ä¸ªæ ‡æ³¨
2. åˆ›å»ºå¤‡ä»½
3. éªŒè¯ï¼šå¤‡ä»½æ–‡ä»¶å­˜åœ¨
4. åˆ é™¤æ‰€æœ‰æ ‡æ³¨
5. æ¢å¤å¤‡ä»½
6. éªŒè¯ï¼š10ä¸ªæ ‡æ³¨æ¢å¤

#### æµ‹è¯•6: æ•°æ®è¿ç§»
1. å‡†å¤‡JSONæ–‡ä»¶ï¼ˆç¬¬ä¸€æœŸæ ¼å¼ï¼‰
2. è¿è¡Œè¿ç§»è„šæœ¬
3. éªŒè¯ï¼šæ‰€æœ‰æ ‡æ³¨å¯¼å…¥æ•°æ®åº“
4. éªŒè¯ï¼šæ•°æ®å®Œæ•´æ€§

### ç«¯åˆ°ç«¯æµ‹è¯•

#### æµ‹è¯•7: WebSocketé€šä¿¡
1. å‰ç«¯å‘é€åˆ›å»ºæ ‡æ³¨æ¶ˆæ¯
2. åç«¯å¤„ç†å¹¶è¿”å›
3. éªŒè¯ï¼šæ•°æ®åº“æœ‰è®°å½•
4. å‰ç«¯å‘é€æ›´æ–°æ¶ˆæ¯
5. åç«¯å¤„ç†å¹¶è¿”å›
6. éªŒè¯ï¼šæ•°æ®åº“å·²æ›´æ–°
7. å‰ç«¯å‘é€åˆ é™¤æ¶ˆæ¯
8. åç«¯å¤„ç†å¹¶è¿”å›
9. éªŒè¯ï¼šæ•°æ®åº“è½¯åˆ é™¤

#### æµ‹è¯•8: å¤šPDFç®¡ç†
1. æ‰“å¼€PDF Aï¼Œåˆ›å»º5ä¸ªæ ‡æ³¨
2. æ‰“å¼€PDF Bï¼Œåˆ›å»º3ä¸ªæ ‡æ³¨
3. åˆ‡æ¢å›PDF A
4. éªŒè¯ï¼šä»…æ˜¾ç¤ºAçš„5ä¸ªæ ‡æ³¨
5. æŸ¥è¯¢ç»Ÿè®¡
6. éªŒè¯ï¼šæ€»å…±8ä¸ªæ ‡æ³¨ï¼Œ2ä¸ªPDF

### æ¥å£å®ç°

#### å‡½æ•°ï¼šcreate_annotation
```python
def create_annotation(data: dict) -> dict:
    """
    åˆ›å»ºæ ‡æ³¨

    å‚æ•°:
        data (dict): æ ‡æ³¨æ•°æ®
            - pdf_path (str): PDFè·¯å¾„
            - type (str): æ ‡æ³¨ç±»å‹
            - page_number (int): é¡µç 
            - data (dict): ç±»å‹ç‰¹å®šæ•°æ®

    è¿”å›:
        dict: åˆ›å»ºçš„æ ‡æ³¨ï¼ˆå«id, version, createdAtç­‰ï¼‰

    å¼‚å¸¸:
        ValueError: æ•°æ®éªŒè¯å¤±è´¥
    """
```

#### å‡½æ•°ï¼šupdate_annotation
```python
def update_annotation(annotation_id: str, changes: dict, expected_version: int) -> dict:
    """
    æ›´æ–°æ ‡æ³¨

    å‚æ•°:
        annotation_id (str): æ ‡æ³¨ID
        changes (dict): è¦æ›´æ–°çš„å­—æ®µ
        expected_version (int): æœŸæœ›çš„ç‰ˆæœ¬å·

    è¿”å›:
        dict: æ›´æ–°åçš„æ ‡æ³¨

    å¼‚å¸¸:
        VersionConflictError: ç‰ˆæœ¬å†²çª
        NotFoundError: æ ‡æ³¨ä¸å­˜åœ¨
    """
```

#### å‡½æ•°ï¼šload_annotations
```python
def load_annotations(pdf_path: str, page_number: int = None) -> list:
    """
    åŠ è½½æ ‡æ³¨

    å‚æ•°:
        pdf_path (str): PDFè·¯å¾„
        page_number (int, optional): é¡µç ï¼ˆNoneè¡¨ç¤ºå…¨éƒ¨ï¼‰

    è¿”å›:
        List[dict]: æ ‡æ³¨åˆ—è¡¨ï¼ˆå«è¯„è®ºï¼‰
    """
```

### ç±»å®ç°

#### ç±»ï¼šAnnotationRepository
```python
class AnnotationRepository:
    def create(self, annotation: dict) -> dict
    def find_by_id(self, annotation_id: str) -> dict
    def find_by_pdf_path(self, pdf_path: str) -> list
    def update(self, annotation_id: str, changes: dict, version: int) -> tuple
    def soft_delete(self, annotation_id: str) -> bool
```

#### ç±»ï¼šAnnotationService
```python
class AnnotationService:
    def create_annotation(self, data: dict) -> dict
    def update_annotation(self, annotation_id: str, changes: dict, version: int) -> dict
    def delete_annotation(self, annotation_id: str) -> bool
    def load_annotations(self, pdf_path: str, page_number: int = None) -> list
    def add_comment(self, annotation_id: str, content: str) -> dict
```

### äº‹ä»¶è§„èŒƒ

#### WebSocketæ¶ˆæ¯ï¼šannotation:create
- **è¯·æ±‚**: `{ type: 'annotation:create', data: { pdfPath, type, pageNumber, data } }`
- **å“åº”**: `{ type: 'annotation:created', data: { annotation } }`
- **é”™è¯¯**: `{ type: 'annotation:create:error', data: { error } }`

#### WebSocketæ¶ˆæ¯ï¼šannotation:update
- **è¯·æ±‚**: `{ type: 'annotation:update', data: { id, changes, version } }`
- **å“åº”**: `{ type: 'annotation:updated', data: { annotation } }`
- **å†²çª**: `{ type: 'annotation:update:conflict', data: { id, currentVersion } }`

## å®ç°è®¡åˆ’

### Phase 1: æ•°æ®åº“è®¾è®¡å’Œè¿ç§»ï¼ˆ4å°æ—¶ï¼‰
- [ ] è®¾è®¡è¡¨ç»“æ„ï¼ˆannotations, comments, historyï¼‰
- [ ] ç¼–å†™è¿ç§»è„šæœ¬ï¼ˆ001, 002ï¼‰
- [ ] å®ç°MigrationService
- [ ] æµ‹è¯•è¿ç§»
- [ ] æäº¤commit

### Phase 2: Repositoryå±‚ï¼ˆ6å°æ—¶ï¼‰
- [ ] å®ç°DatabaseConnection
- [ ] å®ç°AnnotationRepository
- [ ] å®ç°CommentRepository
- [ ] å®ç°HistoryRepository
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æäº¤commit

### Phase 3: Serviceå±‚ï¼ˆ8å°æ—¶ï¼‰
- [ ] å®ç°AnnotationService
- [ ] å®ç°CommentService
- [ ] å®ç°ä¹è§‚é”æœºåˆ¶
- [ ] å®ç°å†å²è®°å½•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æäº¤commit

### Phase 4: WebSocket Handlerï¼ˆ6å°æ—¶ï¼‰
- [ ] å®ç°AnnotationHandler
- [ ] å¤„ç†åˆ›å»º/æ›´æ–°/åˆ é™¤æ¶ˆæ¯
- [ ] å¤„ç†è¯„è®ºæ¶ˆæ¯
- [ ] å¤„ç†åŠ è½½æ¶ˆæ¯
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æäº¤commit

### Phase 5: å¤‡ä»½å’Œæ¢å¤ï¼ˆ4å°æ—¶ï¼‰
- [ ] å®ç°BackupService
- [ ] å®ç°è‡ªåŠ¨å¤‡ä»½å®šæ—¶ä»»åŠ¡
- [ ] å®ç°æ¢å¤åŠŸèƒ½
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æäº¤commit

### Phase 6: æ•°æ®è¿ç§»å·¥å…·ï¼ˆ4å°æ—¶ï¼‰
- [ ] å®ç°JSONåˆ°æ•°æ®åº“çš„è¿ç§»è„šæœ¬
- [ ] å®ç°æ•°æ®éªŒè¯
- [ ] å®ç°è¿›åº¦æŠ¥å‘Š
- [ ] æµ‹è¯•è¿ç§»1000+æ ‡æ³¨
- [ ] æäº¤commit

### Phase 7: é«˜çº§åŠŸèƒ½ï¼ˆ6å°æ—¶ï¼‰
- [ ] å®ç°å†å²æŸ¥çœ‹å’Œæ¢å¤
- [ ] å®ç°æ•°æ®å¯¼å‡ºï¼ˆJSON/Markdown/CSVï¼‰
- [ ] å®ç°æ•°æ®å¯¼å…¥
- [ ] å®ç°ç»Ÿè®¡åŠŸèƒ½
- [ ] æäº¤commit

### Phase 8: æ€§èƒ½ä¼˜åŒ–ï¼ˆ4å°æ—¶ï¼‰
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
- [ ] å®ç°æŸ¥è¯¢ç¼“å­˜
- [ ] å®ç°æ‡’åŠ è½½
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] æäº¤commit

### Phase 9: ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ6å°æ—¶ï¼‰
- [ ] æµ‹è¯•å®Œæ•´CRUDæµç¨‹
- [ ] æµ‹è¯•å¹¶å‘å†²çª
- [ ] æµ‹è¯•å¤‡ä»½æ¢å¤
- [ ] æµ‹è¯•æ•°æ®è¿ç§»
- [ ] æµ‹è¯•WebSocketé€šä¿¡
- [ ] æäº¤commit

### Phase 10: æ–‡æ¡£å’Œéƒ¨ç½²ï¼ˆ2å°æ—¶ï¼‰
- [ ] ç¼–å†™README.md
- [ ] ç¼–å†™APIæ–‡æ¡£
- [ ] ç¼–å†™éƒ¨ç½²æŒ‡å—
- [ ] æœ€ç»ˆæµ‹è¯•
- [ ] æäº¤æœ€ç»ˆcommit

**æ€»é¢„è®¡æ—¶é—´**: 50å°æ—¶

## é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ•°æ®è¿ç§»å¤±è´¥ | ğŸ”´ é«˜ | è¯¦ç»†æµ‹è¯•ï¼Œå¤‡ä»½æ—§æ•°æ®ï¼Œæ”¯æŒå›æ»š |
| å¹¶å‘å†²çªå¤æ‚ | ğŸŸ¡ ä¸­ | ä½¿ç”¨æˆç†Ÿçš„ä¹è§‚é”æ–¹æ¡ˆï¼Œè¯¦ç»†æµ‹è¯• |
| æ€§èƒ½é—®é¢˜ | ğŸŸ¡ ä¸­ | å»ºç«‹ç´¢å¼•ï¼Œå®ç°ç¼“å­˜ï¼Œæ€§èƒ½æµ‹è¯• |
| å¤‡ä»½æ–‡ä»¶è¿‡å¤§ | ğŸŸ¢ ä½ | å‹ç¼©å¤‡ä»½æ–‡ä»¶ï¼Œæ¸…ç†æ—§å¤‡ä»½ |
| SQLiteé™åˆ¶ | ğŸŸ¢ ä½ | å•ç”¨æˆ·åœºæ™¯è¶³å¤Ÿï¼Œæœªæ¥å¯è¿ç§»PostgreSQL |
| æ•°æ®åº“é” | ğŸŸ¡ ä¸­ | ä½¿ç”¨WALæ¨¡å¼ï¼Œä¼˜åŒ–äº‹åŠ¡ |

## åç»­ç‰ˆæœ¬è§„åˆ’ï¼ˆä¸åœ¨ç¬¬ä¸‰æœŸå®ç°ï¼‰

### ç¬¬å››æœŸåŠŸèƒ½ï¼ˆé«˜çº§æŸ¥è¯¢ï¼‰
- å…¨æ–‡æœç´¢ï¼ˆä½¿ç”¨FTS5ï¼‰
- é«˜çº§ç­›é€‰ï¼ˆå¤šæ¡ä»¶ç»„åˆï¼‰
- æ•°æ®åˆ†æå’ŒæŠ¥å‘Š
- æ ‡æ³¨å…³ç³»å›¾è°±

### ç¬¬äº”æœŸåŠŸèƒ½ï¼ˆåä½œå’ŒåŒæ­¥ï¼‰
- å¤šç”¨æˆ·æ”¯æŒ
- äº‘ç«¯åŒæ­¥
- å®æ—¶åä½œ
- å†²çªè§£å†³ç­–ç•¥

## å‚è€ƒèµ„æ–™

### æ•°æ®åº“æ–‡æ¡£
- [SQLiteå®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [SQLite FTS5å…¨æ–‡æœç´¢](https://www.sqlite.org/fts5.html)
- [SQLite WALæ¨¡å¼](https://www.sqlite.org/wal.html)

### é¡¹ç›®æ–‡æ¡£
- [æ ‡æ³¨æ ç¬¬ä¸€æœŸè§„æ ¼è¯´æ˜](../20251002213000-pdf-annotation-sidebar/v001-spec.md)
- [æ ‡æ³¨æ ç¬¬äºŒæœŸè§„æ ¼è¯´æ˜](../20251004030600-pdf-annotation-sidebar-phase2/v001-spec.md)

### è®¾è®¡å‚è€ƒ
- [Notionæ•°æ®åº“æ¶æ„](https://www.notion.so)
- [Evernoteæ ‡æ³¨ç³»ç»Ÿ](https://evernote.com)
- [Adobe Acrobatäº‘ç«¯åŒæ­¥](https://acrobat.adobe.com)
