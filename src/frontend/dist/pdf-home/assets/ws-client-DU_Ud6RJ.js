(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();function ie(s,e){te(s,e),e.add(s)}function ee(s,e,t){te(s,e),e.set(s,t)}function te(s,e){if(e.has(s))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Y(s,e){return s.get(g(s,e))}function H(s,e,t){return s.set(g(s,e),t),t}function g(s,e,t){if(typeof s=="function"?s===e:s.has(e))return arguments.length<3?e:t;throw new TypeError("Private element is not present on this object")}const p={DEBUG:"debug",INFO:"info",WARN:"warn",ERROR:"error"};var J=new WeakMap,P=new WeakMap,m=new WeakSet;class j{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"App",t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:p.INFO;ie(this,m),ee(this,J,void 0),ee(this,P,void 0),H(J,this,e),H(P,this,t)}setLogLevel(e){Object.values(p).includes(e)?H(P,this,e):console.error(`[Logger] Invalid log level: ${e}`)}getLogLevel(){return Y(P,this)}debug(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];g(m,this,k).call(this,p.DEBUG,e,...r)}info(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];g(m,this,k).call(this,p.INFO,e,...r)}warn(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];g(m,this,k).call(this,p.WARN,e,...r)}error(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];g(m,this,k).call(this,p.ERROR,e,...r)}event(e,t){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const n=g(m,this,oe).call(this,r);this.info(`Event [${e}]: ${t} ${n}`)}}function k(s,e){const t=[p.DEBUG,p.INFO,p.WARN,p.ERROR];if(t.indexOf(s)<t.indexOf(Y(P,this)))return;const n=`[${new Date().toISOString()}] [${Y(J,this)}] [${s.toUpperCase()}]`,a=console[s]||console.log;for(var o=arguments.length,l=new Array(o>2?o-2:0),d=2;d<o;d++)l[d-2]=arguments[d];if(l.length>0){const W=l.map(C=>g(m,this,ae).call(this,C));a(n,e,...W)}else a(n,e)}function ae(s){if(s==null||typeof s=="string"||typeof s=="number"||typeof s=="boolean")return s;if(s instanceof Error)return{name:s.name,message:s.message,stack:s.stack};if(typeof s=="object")try{return g(m,this,Z).call(this,s,3)}catch(e){return`[Object serialization failed: ${e.message}]`}return s}function Z(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:new Set;if(e<=0)return"[Max depth reached]";if(s==null||typeof s!="object")return s;if(t.has(s))return"[Circular reference]";if(t.add(s),Array.isArray(s)){const o=s.slice(0,10).map(l=>g(m,this,Z).call(this,l,e-1,t));return s.length>10&&o.push(`[... and ${s.length-10} more items]`),t.delete(s),o}const r={},n=Object.keys(s).slice(0,20);for(const o of n)try{r[o]=g(m,this,Z).call(this,s[o],e-1,t)}catch(l){r[o]=`[Error serializing: ${l.message}]`}const a=Object.keys(s).length;return a>20&&(r["..."]=`[and ${a-20} more properties]`),t.delete(s),r}function oe(s){if(s==null||typeof s=="string"||typeof s=="number"||typeof s=="boolean")return String(s);if(typeof s=="object")try{return g(m,this,ce).call(this,s,3)}catch(e){return`[Object: ${e.message}]`}return String(s)}function ce(s){const e=new WeakSet,t=(r,n)=>{if(r.startsWith("_")||r.startsWith("#"))return"[Internal Property]";if(n instanceof Error)return{name:n.name,message:n.message};if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular Reference]";e.add(n)}return n};try{return JSON.stringify(s,t,2)}catch(r){return`[Serialization Error: ${r.message}]`}}function le(s,e){se(s,e),e.add(s)}function U(s,e,t){se(s,e),e.set(s,t)}function se(s,e){if(e.has(s))throw new TypeError("Cannot initialize the same private elements twice on an object")}function u(s,e){return s.get(_(s,e))}function B(s,e,t){return s.set(_(s,e),t),t}function _(s,e,t){if(typeof s=="function"?s===e:s.has(e))return arguments.length<3?e:t;throw new TypeError("Private element is not present on this object")}class N{static validate(e){if(typeof e!="string"||!e)return!1;const t=e.split(":");return t.length===3&&t.every(r=>r.length>0)}static getValidationError(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e!="string"||!e)return`事件名称必须是非空字符串，但收到了：${e}${_(N,this,G).call(this,t)}`;const r=e.split(":");return r.length!==3?`事件名称 '${e}' 格式不正确，应为 {module}:{action}:{status}${_(N,this,G).call(this,t)}`:r.some(n=>n.length===0)?`事件名称 '${e}' 的各个部分不能为空${_(N,this,G).call(this,t)}`:null}}function G(s){const{subscriberId:e,actorId:t}=s,r=[];return e&&r.push(`订阅者ID: ${e}`),t&&r.push(`执行者ID: ${t}`),r.length>0?` [${r.join(", ")}]`:""}var v=new WeakMap,$=new WeakMap,h=new WeakMap,V=new WeakMap,q=new WeakSet;class ue{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};le(this,q),U(this,v,{}),U(this,$,!0),U(this,h,void 0),U(this,V,1),B($,this,e.enableValidation!==!1),B(h,this,new j("EventBus")),e.logLevel&&u(h,this).setLogLevel(e.logLevel),u(h,this).info(`事件总线已初始化，验证模式: ${u($,this)}, 日志级别: ${e.logLevel||"INFO"}`)}on(e,t){var r,n;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const o=a.subscriberId||_(q,this,K).call(this)||`sub_${B(V,this,(r=u(V,this),n=r++,r)),n}`,l=a.actorId||_(q,this,K).call(this);if(u($,this)){const d=N.getValidationError(e,{subscriberId:o,actorId:l});if(d)throw u(h,this).error(`事件订阅失败: ${d}, 事件名: ${e}`),new Error(`无效的事件名称: ${d}`)}return u(v,this)[e]||(u(v,this)[e]=new Map),u(v,this)[e].set(o,t),u(h,this).event(`${e}`,"订阅",{subscriberId:o,actorId:l}),()=>this.off(e,o)}off(e,t){const r=u(v,this)[e];if(!r)return;let n=null;if(typeof t=="function"){for(const[a,o]of r.entries())if(o===t){r.delete(a),n=a;break}}else r.has(t)&&(r.delete(t),n=t);n!==null&&(r.size===0&&delete u(v,this)[e],u(h,this).event(`${e} (取消订阅 by ${n})`))}emit(e,t){const n=(arguments.length>2&&arguments[2]!==void 0?arguments[2]:{}).actorId||_(q,this,K).call(this);if(u($,this)){const o=N.getValidationError(e,{actorId:n});if(o){u(h,this).error(`事件发布被阻止: ${o}`,{event:e,data:t});return}}const a=u(v,this)[e];if(a&&a.size>0){u(h,this).event(`${e} (发布 by ${n||"unknown"})`,"发布",{actorId:n,subscriberCount:a.size,data:t});for(const[o,l]of a.entries())try{l(t)}catch(d){u(h,this).error(`事件回调执行出错: ${d.message}`,{event:e,subscriberId:o,actorId:n,error:d})}}}once(e,t){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const n=a=>{this.off(e,n),t(a)};return this.on(e,n,r)}destroy(){u(h,this).info("正在销毁事件总线，清除所有订阅..."),B(v,this,{}),u(h,this).info("事件总线已销毁。")}}function K(){try{const t=(new Error().stack||"").split(`
`).map(r=>r.trim()).filter(Boolean);for(let r=1;r<t.length;r++){const n=t[r];if(!/event-bus\.js|EventBus\./i.test(n)){const a=n.match(/at\s+(.*)\s+\((.*):(\d+):(\d+)\)$/)||n.match(/at\s+(.*):(\d+):(\d+)$/);if(a){const o=a[1],l=a[2]||a[1],d=a[3]||a[2];return`${o}:${d}`}return n}}return null}catch{return null}}new ue({enableValidation:!0});const we={INITIALIZATION:{STARTED:"app:initialization:started",COMPLETED:"app:initialization:completed",FAILED:"app:initialization:failed"}},de={ERROR:{OCCURRED:"system:error:occurred"}},T={CONNECTION:{ESTABLISHED:"websocket:connection:established",CLOSED:"websocket:connection:closed",ERROR:"websocket:connection:error",FAILED:"websocket:connection:failed"},MESSAGE:{SEND:"websocket:message:send",SEND_FAILED:"websocket:message:send_failed"},RECONNECT:{FAILED:"websocket:reconnect:failed"}},ve={LIST:{UPDATED:"pdf:list:updated"},ADD:{REQUESTED:"pdf:add:requested",STARTED:"pdf:add:started",FAILED:"pdf:add:failed",COMPLETED:"pdf:add:completed"},REMOVE:{REQUESTED:"pdf:remove:requested",STARTED:"pdf:remove:started",FAILED:"pdf:remove:failed",COMPLETED:"pdf:remove:completed"},BATCH:{REQUESTED:"pdf:batch:requested",STARTED:"pdf:batch:started",FAILED:"pdf:batch:failed",COMPLETED:"pdf:batch:completed"},DELETE:{REQUESTED:"pdf:delete:requested"},OPEN:{REQUESTED:"pdf:open:requested",STARTED:"pdf:open:started",FAILED:"pdf:open:failed",COMPLETED:"pdf:open:completed"},ERROR:{OCCURRED:"pdf:error:occurred"}},he={ERROR:{SHOW:"ui:error:show"},SUCCESS:{SHOW:"ui:success:show"},SELECTION:{CHANGED:"ui:selection:changed"}},D={PDF_LIST_UPDATED:"websocket:message:updated",PDF_LIST:"websocket:message:list",PDF_LIST_RECEIVED:"websocket:message:received",LOAD_PDF_FILE:"websocket:message:load_pdf_file",SUCCESS:"websocket:message:success",ERROR:"websocket:message:error",RESPONSE:"websocket:message:response",UNKNOWN:"websocket:message:unknown"},fe={GET_PDF_LIST:"get_pdf_list",REMOVE_PDF:"remove_pdf",OPEN_PDF:"open_pdf",REQUEST_FILE_SELECTION:"request_file_selection",PDF_DETAIL_REQUEST:"pdf_detail_request"},w={BUSINESS:"business",NETWORK:"network",SYSTEM:"system"};class Q extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:w.SYSTEM,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;super(e),this.name="AppError",this.type=t,this.code=r,this.timestamp=new Date().toISOString()}}class De{constructor(e){this.eventBus=e,this.logger=new j("ErrorHandler")}handleError(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const r={message:e.message,stack:e.stack,type:e.type||w.SYSTEM,code:e.code||null,context:t,timestamp:new Date().toISOString()};this.logger.error(`错误发生在 [${t}]: ${e.message}`,e),this.eventBus.emit(de.ERROR.OCCURRED,r,{actorId:"ErrorHandler"}),this.showUserFriendlyError(e)}showUserFriendlyError(e){let t="操作失败，请稍后重试",r=e.type||w.SYSTEM;switch(r){case w.BUSINESS:t=e.message||"业务逻辑错误";break;case w.NETWORK:t="网络连接失败，请检查网络设置";break;case w.SYSTEM:t="系统错误，请联系管理员";break}this.eventBus.emit(he.ERROR.SHOW,{message:t,type:r},{actorId:"ErrorHandler"})}createBusinessError(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return new Q(e,w.BUSINESS,t)}createNetworkError(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return new Q(e,w.NETWORK,t)}createSystemError(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return new Q(e,w.SYSTEM,t)}}class _e{static createElement(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;const n=document.createElement(e);return Object.entries(t).forEach(a=>{let[o,l]=a;o==="className"?n.className=l:o==="innerHTML"?n.innerHTML=l:n.setAttribute(o,l)}),r&&(r instanceof Node?n.appendChild(r):n.textContent=r),n}static findElement(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:document).querySelector(e)}static findAllElements(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:document).querySelectorAll(e)}static getElementById(e){return document.getElementById(e)}static addClass(e,t){(Array.isArray(e)?e:e instanceof NodeList?Array.from(e):[e]).forEach(n=>n==null?void 0:n.classList.add(t))}static removeClass(e,t){(Array.isArray(e)?e:e instanceof NodeList?Array.from(e):[e]).forEach(n=>n==null?void 0:n.classList.remove(t))}static toggleClass(e,t,r){e==null||e.classList.toggle(t,r)}static hasClass(e,t){return(e==null?void 0:e.classList.contains(t))||!1}static show(e){(Array.isArray(e)?e:e instanceof NodeList?Array.from(e):[e]).forEach(r=>{r&&(r.style.display="")})}static hide(e){(Array.isArray(e)?e:e instanceof NodeList?Array.from(e):[e]).forEach(r=>{r&&(r.style.display="none")})}static isVisible(e){return!!e&&e.offsetParent!==null}static appendChild(e,t){e==null||e.appendChild(t)}static empty(e){e&&(e.innerHTML="")}static setHTML(e,t){e&&(e.innerHTML=t)}static showError(e){try{const t=document.getElementById("global-error");if(t){t.textContent=e,t.style.display="";return}}catch{}try{console.error(e)}catch{}}static showSuccess(e){try{const t=document.getElementById("global-success");if(t){t.textContent=e,t.style.display="";return}}catch{}try{console.info(e)}catch{}}static getAttribute(e,t){return e==null?void 0:e.getAttribute(t)}static closest(e,t){return e==null?void 0:e.closest(t)}static addEventListener(e,t,r){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};(e instanceof NodeList?Array.from(e):[e]).forEach(o=>o==null?void 0:o.addEventListener(t,r,n))}static removeEventListener(e,t,r){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};(e instanceof NodeList?Array.from(e):[e]).forEach(o=>o==null?void 0:o.removeEventListener(t,r,n))}}function ge(s,e){ne(s,e),e.add(s)}function E(s,e,t){ne(s,e),e.set(s,t)}function ne(s,e){if(e.has(s))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(s,e){return s.get(I(s,e))}function S(s,e,t){return s.set(I(s,e),t),t}function I(s,e,t){if(typeof s=="function"?s===e:s.has(e))return arguments.length<3?e:t;throw new TypeError("Private element is not present on this object")}var x=new WeakMap,y=new WeakMap,c=new WeakMap,f=new WeakMap,M=new WeakMap,b=new WeakMap,X=new WeakMap,re=new WeakMap,F=new WeakMap,O=new WeakMap,z=new WeakMap,L=new WeakSet;class be{constructor(e,t){ge(this,L),E(this,x,void 0),E(this,y,void 0),E(this,c,void 0),E(this,f,null),E(this,M,!1),E(this,b,0),E(this,X,5),E(this,re,1e3),E(this,F,[]),E(this,O,new Map),E(this,z,new Map),S(x,this,e),S(y,this,t),S(c,this,new j("WSClient")),I(L,this,Ee).call(this)}connect(){try{i(c,this).info(`Connecting to WebSocket server: ${i(x,this)}`),S(f,this,new WebSocket(i(x,this))),I(L,this,me).call(this)}catch(e){i(c,this).error("Failed to initiate WebSocket connection.",e),i(y,this).emit(T.CONNECTION.FAILED,e,{actorId:"WSClient"})}}disconnect(){i(f,this)&&(i(c,this).info("Disconnecting WebSocket."),i(f,this).close(1e3,"Client initiated disconnect."),S(f,this,null),S(M,this,!1))}isConnected(){var e;return i(M,this)&&((e=i(f,this))===null||e===void 0?void 0:e.readyState)===WebSocket.OPEN}send(e){let{type:t,data:r={}}=e;const n={type:t,data:r,timestamp:Date.now()};if(this.isConnected())try{i(f,this).send(JSON.stringify(n)),i(c,this).debug(`Sent message: ${t}`)}catch(a){i(c,this).error(`Failed to send message: ${t}`,a),i(y,this).emit(T.MESSAGE.SEND_FAILED,{type:t,error:a},{actorId:"WSClient"})}else i(F,this).push(n),i(c,this).debug(`Message queued, connection not available: ${t}`)}_generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_buildPDFDetailRequestMessage(e,t){return{type:fe.PDF_DETAIL_REQUEST,request_id:t,timestamp:Date.now(),data:{pdf_id:e}}}_handlePDFDetailResponse(e){const{request_id:t,data:r,error:n}=e;if(i(O,this).has(t)){const{resolve:a,reject:o}=i(O,this).get(t);i(O,this).delete(t),i(z,this).delete(t),n?o(new Error(n.message||"PDF详情请求失败")):a(r)}}async sendPDFDetailRequest(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3;const n=this._generateRequestId(),a=this._buildPDFDetailRequestMessage(e,n);return new Promise((o,l)=>{let d=0;const W=()=>{if(!this.isConnected()){C(new Error("WebSocket连接未建立"));return}const R=setTimeout(()=>{C(new Error("PDF详情请求超时"))},t);i(O,this).set(n,{resolve:A=>{clearTimeout(R),o(A)},reject:A=>{clearTimeout(R),l(A)}});try{i(f,this).send(JSON.stringify(a)),i(c,this).debug(`PDF详情请求已发送: ${n}`,a)}catch(A){clearTimeout(R),C(A)}},C=R=>{d<r?(d++,i(z,this).set(n,d),i(c,this).warn(`PDF详情请求失败，第${d}次重试: ${R.message}`),setTimeout(()=>{W()},1e3*d)):(i(O,this).delete(n),i(z,this).delete(n),l(new Error(`PDF详情请求失败，已重试${r}次: ${R.message}`)))};W()})}}function Ee(){i(y,this).on(T.MESSAGE.SEND,s=>{i(c,this).info(`Received request to send message: ${JSON.stringify(s,null,2)}`),this.send(s)},{subscriberId:"WSClient"})}function me(){i(f,this).onopen=()=>{i(c,this).info("WebSocket connection established."),S(M,this,!0),S(b,this,0),i(y,this).emit(T.CONNECTION.ESTABLISHED,void 0,{actorId:"WSClient"}),I(L,this,ye).call(this)},i(f,this).onmessage=s=>I(L,this,pe).call(this,s.data),i(f,this).onclose=()=>{i(c,this).warn("WebSocket connection closed."),S(M,this,!1),i(y,this).emit(T.CONNECTION.CLOSED,void 0,{actorId:"WSClient"}),I(L,this,Se).call(this)},i(f,this).onerror=s=>{i(c,this).error("WebSocket connection error.",s),i(y,this).emit(T.CONNECTION.ERROR,s,{actorId:"WSClient"})}}function pe(s){try{const e=JSON.parse(s);i(c,this).debug(`Received message: ${e.type}`,e);let t=null;switch(e.type){case"pdf_list_updated":t=D.PDF_LIST_UPDATED;break;case"pdf_list":t=D.PDF_LIST;break;case"load_pdf_file":t=D.LOAD_PDF_FILE;break;case"pdf_detail_response":t=D.RESPONSE,this._handlePDFDetailResponse(e);break;case"success":t=D.SUCCESS;break;case"error":t=D.ERROR;break;case"response":t=D.RESPONSE;break;default:t=D.UNKNOWN,i(c,this).warn(`Unknown message type: ${e.type}`)}t?(i(c,this).debug(`Routing message to event: ${t}`),i(y,this).emit(t,e,{actorId:"WSClient"})):i(c,this).warn(`No target event found for message type: ${e.type}`)}catch(e){i(c,this).error("Failed to parse incoming WebSocket message.",e)}}function Se(){var s;if(i(b,this)>=i(X,this)){i(c,this).error("Max WebSocket reconnect attempts reached."),i(y,this).emit(T.RECONNECT.FAILED,void 0,{actorId:"WSClient"});return}S(b,this,(s=i(b,this),s++,s)),i(c,this).info(`Attempting to reconnect (${i(b,this)}/${i(X,this)})...`),setTimeout(()=>this.connect(),i(re,this)*i(b,this))}function ye(){for(i(c,this).info(`Flushing ${i(F,this).length} queued messages.`);i(F,this).length>0;){const s=i(F,this).shift();this.send({type:s.type,data:s.data})}}export{we as A,_e as D,ue as E,j as L,ve as P,de as S,he as U,T as W,fe as a,D as b,p as c,De as d,be as e};
