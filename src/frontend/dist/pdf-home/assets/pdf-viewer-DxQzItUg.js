import{L as se,D as ke,E as ut,c as gt,d as pt,e as ft,b as mt}from"./ws-client-DU_Ud6RJ.js";const l={FILE:{LOAD:{REQUESTED:"pdf-viewer:file:load-requested",SUCCESS:"pdf-viewer:file:load-success",FAILED:"pdf-viewer:file:load-failed",PROGRESS:"pdf-viewer:file:load-progress",RETRY:"pdf-viewer:file:load-retry"},CLOSE:"pdf-viewer:file:close",INFO_REQUESTED:"pdf-viewer:file:info:requested",INFO_RESPONSE:"pdf-viewer:file:info:response"},NAVIGATION:{PREVIOUS:"pdf-viewer:navigation:previous",NEXT:"pdf-viewer:navigation:next",GOTO:"pdf-viewer:navigation:goto",CHANGED:"pdf-viewer:navigation:changed",TOTAL_PAGES_UPDATED:"pdf-viewer:navigation:total-pages-updated"},ZOOM:{IN:"pdf-viewer:zoom:in",OUT:"pdf-viewer:zoom:out",FIT_WIDTH:"pdf-viewer:zoom:fit-width",FIT_HEIGHT:"pdf-viewer:zoom:fit-height",ACTUAL_SIZE:"pdf-viewer:zoom:actual-size",CHANGED:"pdf-viewer:zoom:changed"},RENDER:{PAGE_REQUESTED:"pdf-viewer:render-page:requested",PAGE_COMPLETED:"pdf-viewer:render-page:completed",PAGE_FAILED:"pdf-viewer:render-page:failed",QUALITY_CHANGED:"pdf-viewer:render:quality:changed"},TEXT:{SELECTED:"pdf-viewer:text:selected",SEARCH_REQUESTED:"pdf-viewer:text:search:requested",SEARCH_RESULT:"pdf-viewer:text:search:result",SEARCH_COMPLETED:"pdf-viewer:text:search:completed"},BOOKMARK:{ADD:"pdf-viewer:bookmark:add",REMOVE:"pdf-viewer:bookmark:remove",GOTO:"pdf-viewer:bookmark:goto",LIST_UPDATED:"pdf-viewer:bookmark:list:updated"},UI:{TOOLBAR_TOGGLE:"pdf-viewer:ui:toolbar-toggle",SIDEBAR_TOGGLE:"pdf-viewer:ui:sidebar:toggle",THUMBNAIL_TOGGLE:"pdf-viewer:ui:thumbnail:toggle",RESIZED:"pdf-viewer:ui:resized",FULLSCREEN_TOGGLE:"pdf-viewer:ui:fullscreen:toggle"},STATE:{INITIALIZED:"pdf-viewer:state:initialized",DESTROYED:"pdf-viewer:state:destroyed",ERROR:"pdf-viewer:state:error",LOADING:"pdf-viewer:state:loading"}},vt="modulepreload",wt=function(t){return"/pdf-home/"+t},je={},Pt=function(e,i,c){let m=Promise.resolve();if(i&&i.length>0){document.getElementsByTagName("link");const p=document.querySelector("meta[property=csp-nonce]"),v=(p==null?void 0:p.nonce)||(p==null?void 0:p.getAttribute("nonce"));m=Promise.allSettled(i.map(W=>{if(W=wt(W),W in je)return;je[W]=!0;const Ae=W.endsWith(".css"),ht=Ae?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${W}"]${ht}`))return;const X=document.createElement("link");if(X.rel=Ae?"stylesheet":vt,Ae||(X.as="script"),X.crossOrigin="",X.href=W,v&&X.setAttribute("nonce",v),document.head.appendChild(X),Ae)return new Promise((dt,ct)=>{X.addEventListener("load",dt),X.addEventListener("error",()=>ct(new Error(`Unable to preload CSS for ${W}`)))})}))}function y(p){const v=new Event("vite:preloadError",{cancelable:!0});if(v.payload=p,window.dispatchEvent(v),!v.defaultPrevented)throw p}return m.then(p=>{for(const v of p||[])v.status==="rejected"&&y(v.reason);return e().catch(y)})};function Et(t,e){Ye(t,e),e.add(t)}function Ee(t,e,i){Ye(t,e),e.set(t,i)}function Ye(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function n(t,e){return t.get(ae(t,e))}function Ie(t,e,i){return t.set(ae(t,e),i),i}function ae(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}const _={workerSrc:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",cMapUrl:null,cMapPacked:!1,withCredentials:!1,maxImageSize:-1,disableAutoFetch:!1,disableStream:!1,disableRange:!1,isEvalSupported:!0,useSystemFonts:!1};var ye=new WeakMap,u=new WeakMap,j=new WeakMap,F=new WeakMap,L=new WeakMap,pe=new WeakSet;class It{constructor(e){Et(this,pe),Ee(this,ye,void 0),Ee(this,u,void 0),Ee(this,j,null),Ee(this,F,null),Ee(this,L,new Map),Ie(ye,this,e),Ie(u,this,new se("PDFManager"))}async initialize(){try{n(u,this).info("Initializing PDF Manager...");const e={enabled:!1};n(u,this).info("Loading PDF.js library..."),Ie(j,this,await Pt(()=>import("./pdf-BZO4ESo3.js").then(i=>i.p),[])),n(j,this)&&n(u,this).info("PDF.js library loaded successfully",{version:n(j,this).version,build:n(j,this).build}),n(j,this).GlobalWorkerOptions.workerSrc=_.workerSrc,n(u,this).info("PDF.js worker configured",{workerSrc:_.workerSrc}),n(u,this).info("PDF Manager initialized successfully")}catch(e){throw n(u,this).error("Failed to initialize PDF Manager:",e),n(ye,this).emit(l.STATE.ERROR,{module:"PDFManager",error:e.message},{actorId:"PDFManager"}),e}}async loadPDF(e){const m=e&&e.filename?e.filename:null;if(!e.url&&m&&(e.url=`/pdfs/${encodeURIComponent(m)}`,n(u,this).debug(`Constructed proxy URL for filename ${m}: ${e.url}`)),!n(j,this)){n(u,this).warn("PDF.js library not loaded yet, attempting to initialize before loading PDF");try{await this.initialize()}catch(y){n(u,this).error("Failed to initialize PDFManager before load:",y)}}for(let y=1;y<=3;y++)try{n(u,this).info(`Loading PDF document (attempt ${y}):`,m||e.url),this.cleanup();let p;if(e.url)n(u,this).info("Loading PDF from URL:",e.url),p=await ae(pe,this,yt).call(this,e.url);else if(e.arrayBuffer)n(u,this).info("Loading PDF from ArrayBuffer"),p=await ae(pe,this,Xe).call(this,e.arrayBuffer);else if(e.blob)n(u,this).info("Loading PDF from Blob"),p=await ae(pe,this,_t).call(this,e.blob);else throw new Error("Unsupported file data format");Ie(F,this,p),n(L,this).clear(),n(u,this).info(`PDF document loaded successfully. Pages: ${p.numPages}`);const v=this.getDocumentInfo();return n(u,this).info("Document information:",v),p}catch(p){if(n(u,this).error(`Failed to load PDF document on attempt ${y}:`,p),y<3){try{n(ye,this).emit(l.FILE.LOAD.RETRY,{filename:m,attempt:y},{actorId:"PDFManager"})}catch(v){n(u,this).warn("Failed to emit retry event:",v)}await new Promise(v=>setTimeout(v,500));continue}n(u,this).warn("PDF加载失败，已达到最大重试次数（3次），不再重试",{filename:m});try{n(ye,this).emit(l.FILE.LOAD.FAILED,{filename:m,error:p&&p.message?p.message:String(p),attempts:3},{actorId:"PDFManager"})}catch(v){n(u,this).warn("Failed to emit load failed event:",v)}throw p}}async getPage(e){if(!n(F,this))throw new Error("No PDF document loaded");if(e<1||e>n(F,this).numPages)throw new Error(`Invalid page number: ${e}`);if(n(L,this).has(e))return n(u,this).debug(`Returning page ${e} from cache`),n(L,this).get(e);try{n(u,this).debug(`Loading page ${e}`);const i=await n(F,this).getPage(e);return n(L,this).set(e,i),i}catch(i){throw n(u,this).error(`Failed to get page ${e}:`,i),i}}getDocumentInfo(){return n(F,this)?{numPages:n(F,this).numPages}:null}async preloadPages(e,i){if(!n(F,this))return;const c=n(F,this).numPages,m=Math.max(1,e),y=Math.min(c,i);n(u,this).debug(`Preloading pages ${m} to ${y}`);const p=[];for(let v=m;v<=y;v++)n(L,this).has(v)||p.push(this.getPage(v).catch(W=>{n(u,this).warn(`Failed to preload page ${v}:`,W)}));await Promise.all(p),n(u,this).debug(`Preloaded ${p.length} pages`)}cleanupCache(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3;if(!n(F,this)||n(L,this).size===0)return;const i=ae(pe,this,Ft).call(this);if(!i)return;const c=new Set;for(let m=Math.max(1,i-e);m<=Math.min(n(F,this).numPages,i+e);m++)c.add(m);for(const[m,y]of n(L,this).entries())c.has(m)||(n(L,this).delete(m),y.cleanup&&y.cleanup());n(u,this).debug(`Cache cleaned. Kept ${c.size} pages`)}cleanup(){n(u,this).info("Cleaning up PDF resources");for(const[,e]of n(L,this).entries())e.cleanup&&e.cleanup();n(L,this).clear(),n(F,this)&&(n(F,this).destroy().catch(e=>{n(u,this).warn("Error destroying PDF document:",e)}),Ie(F,this,null))}destroy(){n(u,this).info("Destroying PDF Manager"),this.cleanup()}getCurrentDocument(){return n(F,this)}getCacheStats(){return{totalCached:n(L,this).size,cachedPages:Array.from(n(L,this).keys())}}}async function yt(t){return n(u,this).debug("Loading PDF from URL:",t),await n(j,this).getDocument({url:t,withCredentials:_.withCredentials,maxImageSize:_.maxImageSize,disableAutoFetch:_.disableAutoFetch,disableStream:_.disableStream,disableRange:_.disableRange,isEvalSupported:_.isEvalSupported,useSystemFonts:_.useSystemFonts}).promise}async function Xe(t){return n(u,this).debug("Loading PDF from ArrayBuffer"),await n(j,this).getDocument({data:t,withCredentials:_.withCredentials,maxImageSize:_.maxImageSize,disableAutoFetch:_.disableAutoFetch,disableStream:_.disableStream,disableRange:_.disableRange,isEvalSupported:_.isEvalSupported,useSystemFonts:_.useSystemFonts}).promise}async function _t(t){n(u,this).debug("Loading PDF from Blob");const e=await t.arrayBuffer();return await ae(pe,this,Xe).call(this,e)}function Ft(){return null}function Mt(t,e){Je(t,e),e.add(t)}function I(t,e,i){Je(t,e),e.set(t,i)}function Je(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function a(t,e){return t.get(A(t,e))}function ie(t,e,i){return t.set(A(t,e),i),i}function A(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var x=new WeakMap,O=new WeakMap,P=new WeakMap,$e=new WeakMap,w=new WeakMap,bt=new WeakMap,Ct=new WeakMap,Lt=new WeakMap,We=new WeakMap,Ue=new WeakMap,St=new WeakMap,kt=new WeakMap,Be=new WeakMap,Ne=new WeakMap,Dt=new WeakMap,At=new WeakMap,Tt=new WeakMap,zt=new WeakMap,$=new WeakSet;class Ot{constructor(e){Mt(this,$),I(this,x,void 0),I(this,O,void 0),I(this,P,null),I(this,$e,null),I(this,w,null),I(this,bt,1),I(this,Ct,[]),I(this,Lt,!1),I(this,We,null),I(this,Ue,null),I(this,St,null),I(this,kt,null),I(this,Be,null),I(this,Ne,null),I(this,Dt,null),I(this,At,null),I(this,Tt,null),I(this,zt,null),ie(x,this,e),ie(O,this,new se("UIManagerCore"))}async initialize(){try{a(O,this).info("Initializing UI Manager Core..."),A($,this,$t).call(this),A($,this,Rt).call(this),A($,this,xt).call(this),a(O,this).info("UI Manager Core initialized successfully")}catch(e){throw a(O,this).error("Failed to initialize UI Manager Core:",e),e}}getContainerWidth(){return a(w,this)?a(w,this).clientWidth:0}getContainerHeight(){return a(w,this)?a(w,this).clientHeight:0}showLoading(e){a(w,this)&&(e?ke.addClass(a(w,this),"loading"):ke.removeClass(a(w,this),"loading"))}cleanup(){a(O,this).info("Cleaning up UI resources"),a(P,this)&&(a(P,this).width=0,a(P,this).height=0,a(P,this).parentNode&&a(P,this).parentNode.removeChild(a(P,this))),ie(P,this,null),ie($e,this,null),a(w,this)&&(a(w,this).innerHTML="",ke.removeClass(a(w,this),"loading"),ke.removeClass(a(w,this),"error"))}destroy(){a(O,this).info("Destroying UI Manager Core"),this.cleanup(),window.removeEventListener("resize",A($,this,He)),document.removeEventListener("keydown",A($,this,et)),a(P,this)&&a(P,this).removeEventListener("wheel",A($,this,tt)),a(We,this)&&a(We,this).removeEventListener("click",()=>{}),a(Ue,this)&&a(Ue,this).removeEventListener("click",()=>{}),a(Be,this)&&a(Be,this).removeEventListener("click",()=>{}),a(Ne,this)&&a(Ne,this).removeEventListener("click",()=>{})}getContainer(){return a(w,this)}getCanvas(){return a(P,this)}getContext(){return a($e,this)}}function $t(){if(ie(w,this,ke.getElementById("pdf-container")),!a(w,this))throw new Error("PDF viewer container not found");const t=a(w,this).querySelector("#pdf-canvas");t instanceof HTMLCanvasElement?(ie(P,this,t),a(P,this).classList.add("pdf-canvas"),a(O,this).debug("Reusing existing canvas element")):(ie(P,this,document.createElement("canvas")),a(P,this).id="pdf-canvas",a(P,this).className="pdf-canvas",a(P,this).style.display="block",Object.assign(a(P,this).style,{margin:"0 auto",display:"block",background:"#f0f0f0",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"}),a(w,this).appendChild(a(P,this)),a(O,this).debug("Canvas element created and appended")),ie($e,this,a(P,this).getContext("2d"))}function Rt(){window.addEventListener("resize",()=>A($,this,He).call(this)),document.addEventListener("keydown",t=>A($,this,et).call(this,t)),a(P,this).addEventListener("wheel",t=>A($,this,tt).call(this,t),{passive:!1})}function xt(){typeof ResizeObserver=="function"&&(new ResizeObserver(e=>{for(const i of e)i.target===a(w,this)&&A($,this,He).call(this)}).observe(a(w,this)),a(O,this).debug("ResizeObserver setup completed"))}function He(){a(O,this).debug("Container resized"),a(x,this).emit(l.UI.RESIZED,{width:a(w,this).clientWidth,height:a(w,this).clientHeight},{actorId:"UIManagerCore"})}function et(t){if(!(t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"))switch(t.key){case"ArrowLeft":case"PageUp":t.preventDefault(),a(x,this).emit(l.NAVIGATION.PREVIOUS,null,{actorId:"UIManagerCore"});break;case"ArrowRight":case"PageDown":t.preventDefault(),a(x,this).emit(l.NAVIGATION.NEXT,null,{actorId:"UIManagerCore"});break;case"+":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),a(x,this).emit(l.ZOOM.IN,null,{actorId:"UIManagerCore"}));break;case"-":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),a(x,this).emit(l.ZOOM.OUT,null,{actorId:"UIManagerCore"}));break;case"0":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),a(x,this).emit(l.ZOOM.ACTUAL_SIZE,null,{actorId:"UIManagerCore"}));break;case"Escape":t.preventDefault(),a(x,this).emit(l.FILE.CLOSE,null,{actorId:"UIManagerCore"});break}}function tt(t){(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.deltaY<0?a(x,this).emit(l.ZOOM.IN,null,{actorId:"UIManagerCore"}):a(x,this).emit(l.ZOOM.OUT,null,{actorId:"UIManagerCore"}))}function Wt(t,e){it(t,e),e.add(t)}function G(t,e,i){it(t,e),e.set(t,i)}function it(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function h(t,e){return t.get(ve(t,e))}function M(t,e,i){return t.set(ve(t,e),i),i}function ve(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var le=new WeakMap,re=new WeakMap,q=new WeakMap,Q=new WeakMap,we=new WeakMap,Pe=new WeakMap,K=new WeakMap,Y=new WeakMap,oe=new WeakMap,_e=new WeakSet;class Ut{constructor(e){Wt(this,_e),G(this,le,void 0),G(this,re,void 0),G(this,q,null),G(this,Q,null),G(this,we,null),G(this,Pe,null),G(this,K,null),G(this,Y,null),G(this,oe,1),M(le,this,e),M(re,this,new se("UIZoomControls"))}async setupZoomControls(e){try{if(h(re,this).debug("Setting up zoom controls..."),M(q,this,document.getElementById("zoom-in")),M(Q,this,document.getElementById("zoom-out")),M(we,this,document.getElementById("zoom-level")),M(Pe,this,document.getElementById("page-info")),M(K,this,document.getElementById("prev-page")),M(Y,this,document.getElementById("next-page")),!h(q,this)||!h(Q,this)||!h(we,this)||!h(Pe,this)||!h(K,this)||!h(Y,this))throw new Error("Zoom control elements not found");h(q,this).addEventListener("click",()=>{h(le,this).emit(l.ZOOM.IN,null,{actorId:"UIZoomControls"})}),h(Q,this).addEventListener("click",()=>{h(le,this).emit(l.ZOOM.OUT,null,{actorId:"UIZoomControls"})}),h(K,this).addEventListener("click",()=>{h(le,this).emit(l.NAVIGATION.PREVIOUS,null,{actorId:"UIZoomControls"})}),h(Y,this).addEventListener("click",()=>{h(le,this).emit(l.NAVIGATION.NEXT,null,{actorId:"UIZoomControls"})}),ve(_e,this,qe).call(this),ve(_e,this,Qe).call(this,1,1),h(re,this).debug("Zoom controls setup completed")}catch(i){throw h(re,this).error("Failed to setup zoom controls:",i),i}}applyZoomAnimation(e){e&&(e.classList.add("zoom-animation"),setTimeout(()=>{e.classList.remove("zoom-animation")},300))}applyPageTransitionAnimation(e){e&&(e.classList.add("page-transition"),setTimeout(()=>{e.classList.remove("page-transition")},200))}setScale(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;M(oe,this,Math.max(.5,Math.min(3,e))),ve(_e,this,qe).call(this),i&&this.applyZoomAnimation(i),h(re,this).debug(`Scale set to: ${h(oe,this)}`)}updatePageInfo(e,i){let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;ve(_e,this,Qe).call(this,e,i),c&&this.applyPageTransitionAnimation(c)}getScale(){return h(oe,this)}destroy(){h(re,this).info("Destroying Zoom Controls"),h(q,this)&&h(q,this).removeEventListener("click",()=>{}),h(Q,this)&&h(Q,this).removeEventListener("click",()=>{}),h(K,this)&&h(K,this).removeEventListener("click",()=>{}),h(Y,this)&&h(Y,this).removeEventListener("click",()=>{}),M(q,this,null),M(Q,this,null),M(we,this,null),M(Pe,this,null),M(K,this,null),M(Y,this,null)}}function qe(){if(h(we,this)){const t=Math.round(h(oe,this)*100);h(we,this).textContent=`${t}%`,h(q,this)&&(h(q,this).disabled=h(oe,this)>=3),h(Q,this)&&(h(Q,this).disabled=h(oe,this)<=.5)}}function Qe(t,e){h(Pe,this)&&(h(Pe,this).textContent=`${t} / ${e}`,h(K,this)&&(h(K,this).disabled=t<=1),h(Y,this)&&(h(Y,this).disabled=t>=e))}function he(t,e,i){Bt(t,e),e.set(t,i)}function Bt(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function d(t,e){return t.get(st(t,e))}function Z(t,e,i){return t.set(st(t,e),i),i}function st(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Te=new WeakMap,de=new WeakMap,T=new WeakMap,U=new WeakMap,V=new WeakMap,S=new WeakMap;class Nt{constructor(e){he(this,Te,void 0),he(this,de,void 0),he(this,T,null),he(this,U,null),he(this,V,null),he(this,S,null),Z(Te,this,e),Z(de,this,new se("UIProgressError"))}setupProgressAndErrorUI(e){Z(T,this,e);const i=document.createElement("div");i.className="pdf-progress-container",i.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
      z-index: 1000;
      display: none;
    `,Z(U,this,document.createElement("div")),d(U,this).className="pdf-progress-bar",d(U,this).style.cssText=`
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    `;const c=document.createElement("div");c.className="pdf-progress-fill",c.style.cssText=`
      width: 0%;
      height: 100%;
      background: #007bff;
      border-radius: 4px;
      transition: width 0.3s ease;
    `,d(U,this).appendChild(c),Z(V,this,document.createElement("div")),d(V,this).className="pdf-progress-text",d(V,this).style.cssText=`
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    `,d(V,this).textContent="加载中... 0%",i.appendChild(d(V,this)),i.appendChild(d(U,this)),Z(S,this,document.createElement("div")),d(S,this).className="pdf-error-container",d(S,this).style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 1001;
      display: none;
    `,d(T,this).appendChild(i),d(T,this).appendChild(d(S,this)),d(de,this).debug("Progress and error UI setup completed")}updateProgress(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"加载中...";if(d(U,this)&&d(V,this)){const c=d(U,this).querySelector(".pdf-progress-fill");c&&(c.style.width=`${e}%`),d(V,this).textContent=`${i} ${e}%`;const m=d(U,this).parentElement;m&&(m.style.display="block")}}hideProgress(){const e=d(T,this).querySelector(".pdf-progress-container");e&&(e.style.display="none")}showError(e){d(de,this).error("UI Error:",e),this.hideProgress(),d(S,this).innerHTML=`
      <div style="margin-bottom: 16px;">
        <h3 style="color: #dc3545; margin: 0 0 8px 0; font-size: 18px;">加载失败</h3>
        <p style="color: #6c757d; margin: 0 0 16px 0; font-size: 14px; line-height: 1.4;">
          ${e.userMessage||e.error}
        </p>
        ${e.retryable?`
          <button id="pdf-retry-btn" style="
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
          ">重试</button>
        `:""}
        <button id="pdf-close-btn" style="
          background: #6c757d;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
        ">关闭</button>
      </div>
    `,d(S,this).style.display="block";const i=document.getElementById("pdf-retry-btn");i&&(i.onclick=()=>{d(Te,this).emit(l.FILE.LOAD.RETRY,e.file,{actorId:"UIProgressError"}),this.hideError()});const c=document.getElementById("pdf-close-btn");c&&(c.onclick=()=>{this.hideError(),d(Te,this).emit(l.FILE.CLOSE,null,{actorId:"UIProgressError"})})}hideError(){d(S,this).style.display="none",d(S,this).innerHTML=""}showSimpleError(e){d(de,this).error("UI Error:",e),d(T,this)&&(d(T,this).innerHTML=`
        <div class="pdf-error">
          <h3>加载失败</h3>
          <p>${e}</p>
          <button onclick="window.location.reload()">重新加载</button>
        </div>
      `)}destroy(){if(d(de,this).info("Destroying Progress and Error UI"),d(T,this)){const e=d(T,this).querySelector(".pdf-progress-container");e&&d(T,this).removeChild(e),d(S,this)&&d(S,this).parentNode&&d(T,this).removeChild(d(S,this))}Z(U,this,null),Z(V,this,null),Z(S,this,null)}}function Gt(t,e){rt(t,e),e.add(t)}function Fe(t,e,i){rt(t,e),e.set(t,i)}function rt(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function f(t,e){return t.get(Re(t,e))}function N(t,e,i){return t.set(Re(t,e),i),i}function Re(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var z=new WeakMap,R=new WeakMap,fe=new WeakMap,ee=new WeakMap,De=new WeakMap,Ge=new WeakSet;class Zt{constructor(){Gt(this,Ge),Fe(this,z,void 0),Fe(this,R,null),Fe(this,fe,null),Fe(this,ee,[]),Fe(this,De,!1),N(z,this,new se("UICanvasRender"))}initialize(e){N(R,this,e),N(fe,this,e.getContext("2d")),f(z,this).debug("Canvas renderer initialized")}async renderPage(e,i){try{f(z,this).debug(`Rendering page with viewport: ${i.width}x${i.height}`),Re(Ge,this,Vt).call(this,i.width,i.height),await e.render({canvasContext:f(fe,this),viewport:i}).promise,f(z,this).debug("Page rendered successfully")}catch(c){throw f(z,this).error("Failed to render page:",c),c}}addToRenderQueue(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;f(ee,this).push({task:e,priority:i}),f(ee,this).sort((c,m)=>m.priority-c.priority),Re(Ge,this,Ht).call(this)}clearRenderQueue(){N(ee,this,[]),f(z,this).debug("Render queue cleared")}getCanvas(){return f(R,this)}getContext(){return f(fe,this)}cleanup(){f(z,this).info("Cleaning up Canvas resources"),f(R,this)&&(f(R,this).width=0,f(R,this).height=0),N(R,this,null),N(fe,this,null),N(ee,this,[]),N(De,this,!1)}destroy(){f(z,this).info("Destroying Canvas Renderer"),this.cleanup()}}function Vt(t,e){const i=window.devicePixelRatio||1;f(R,this).style.width=`${t}px`,f(R,this).style.height=`${e}px`,f(R,this).width=Math.floor(t*i),f(R,this).height=Math.floor(e*i),f(fe,this).scale(i,i),f(z,this).debug(`Canvas resized to ${t}x${e} (dpr: ${i})`)}async function Ht(){if(!(f(De,this)||f(ee,this).length===0)){N(De,this,!0);try{for(;f(ee,this).length>0;){const{task:t}=f(ee,this).shift();await t.render()}}catch(t){f(z,this).error("Error processing render queue:",t)}finally{N(De,this,!1)}}}function ce(t,e,i){jt(t,e),e.set(t,i)}function jt(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function g(t,e){return t.get(nt(t,e))}function B(t,e,i){return t.set(nt(t,e),i),i}function nt(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Ke=new WeakMap,ue=new WeakMap,b=new WeakMap,J=new WeakMap,H=new WeakMap,ne=new WeakMap;class qt{constructor(e){ce(this,Ke,void 0),ce(this,ue,void 0),ce(this,b,void 0),ce(this,J,void 0),ce(this,H,void 0),ce(this,ne,void 0),B(Ke,this,e),B(ue,this,new se("UIManager")),B(b,this,new Ot(e)),B(J,this,new Ut(e)),B(H,this,new Nt(e)),B(ne,this,new Zt)}async initialize(){try{g(ue,this).info("Initializing UI Manager..."),await g(b,this).initialize();const e=g(b,this).getContainer(),i=g(b,this).getCanvas();await g(J,this).setupZoomControls(e),g(H,this).setupProgressAndErrorUI(e),g(ne,this).initialize(i),g(ue,this).info("UI Manager initialized successfully")}catch(e){throw g(ue,this).error("Failed to initialize UI Manager:",e),e}}async renderPage(e,i){return g(ne,this).renderPage(e,i)}updateProgress(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"加载中...";g(H,this).updateProgress(e,i)}hideProgress(){g(H,this).hideProgress()}showError(e){g(H,this).showError(e)}hideError(){g(H,this).hideError()}setScale(e){const i=g(b,this).getCanvas();g(J,this).setScale(e,i)}updatePageInfo(e,i){const c=g(b,this).getCanvas();g(J,this).updatePageInfo(e,i,c)}getScale(){return g(J,this).getScale()}getContainerWidth(){return g(b,this).getContainerWidth()}getContainerHeight(){return g(b,this).getContainerHeight()}showLoading(e){g(b,this).showLoading(e)}getCanvas(){return g(b,this).getCanvas()}getContext(){return g(b,this).getContext()}cleanup(){g(b,this).cleanup(),g(ne,this).cleanup()}destroy(){g(ue,this).info("Destroying UI Manager"),g(b,this).destroy(),g(J,this).destroy(),g(H,this).destroy(),g(ne,this).destroy(),B(b,this,null),B(J,this,null),B(H,this,null),B(ne,this,null)}}function Qt(t,e){at(t,e),e.add(t)}function k(t,e,i){at(t,e),e.set(t,i)}function at(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function o(t,e){return t.get(xe(t,e))}function C(t,e,i){return t.set(xe(t,e),i),i}function xe(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var E=new WeakMap,D=new WeakMap,te=new WeakMap,Me=new WeakMap,be=new WeakMap,Ce=new WeakMap,ze=new WeakMap,Le=new WeakMap,Se=new WeakMap,Oe=new WeakMap,me=new WeakMap,ge=new WeakMap,Ze=new WeakSet;class Kt{constructor(){Qt(this,Ze),k(this,E,void 0),k(this,D,void 0),k(this,te,void 0),k(this,Me,void 0),k(this,be,void 0),k(this,Ce,!1),k(this,ze,null),k(this,Le,1),k(this,Se,0),k(this,Oe,1),k(this,me,null),k(this,ge,[]),C(E,this,new se("PDFViewerApp")),C(D,this,new ut({enableValidation:!0,logLevel:gt.INFO})),C(te,this,new pt(o(D,this))),C(Me,this,new It(o(D,this))),C(be,this,new qt(o(D,this))),C(me,this,new ft("ws://localhost:8765",o(D,this))),o(E,this).info("PDFViewerApp instance created")}async initialize(){try{o(E,this).info("Initializing PDF Viewer App..."),xe(Ze,this,Yt).call(this),xe(Ze,this,Xt).call(this),await o(Me,this).initialize(),await o(be,this).initialize(),C(Ce,this,!0),o(E,this).info("PDF Viewer App initialized successfully."),o(D,this).emit(l.STATE.INITIALIZED,void 0,{actorId:"PDFViewerApp"})}catch(e){throw o(E,this).error("Application initialization failed.",e),o(te,this).handleError(e,"App.initialize"),e}}onInitialized(){o(E,this).info("Processing queued WebSocket messages:",o(ge,this).length),o(ge,this).forEach(e=>this.handleWebSocketMessage(e)),C(ge,this,[])}handleWebSocketMessage(e){const{type:i,data:c}=e;if(!o(Ce,this)){o(E,this).warn("Viewer not initialized yet, queuing WebSocket message:",e.type),o(ge,this).push(e);return}switch(i){case"load_pdf_file":this.handleLoadPdfFileMessage(c);break;default:o(E,this).debug(`Received unhandled WebSocket message type: ${i}`);break}}handleLoadPdfFileMessage(e){let i=null;e&&e.filename&&e.url?(e.file_path?i={file_path:e.file_path,filename:e.filename,url:e.url}:e.fileId&&(i={filename:e.filename,url:e.url,fileId:e.fileId}),i?(o(E,this).info(`Received load PDF file request: ${e.filename}`),o(D,this).emit(l.FILE.LOAD.REQUESTED,i,{actorId:"WebSocket"})):o(E,this).warn("Invalid load_pdf_file message format:",e)):o(E,this).warn("Invalid load_pdf_file message format (missing required fields):",e)}destroy(){o(E,this).info("Destroying PDF Viewer App..."),o(me,this)&&o(me,this).disconnect(),o(Me,this).destroy(),o(be,this).destroy(),o(D,this).destroy(),o(E,this).info("PDF Viewer App destroyed."),o(D,this).emit(l.STATE.DESTROYED,void 0,{actorId:"PDFViewerApp"})}getState(){return{initialized:o(Ce,this),currentFile:o(ze,this),currentPage:o(Le,this),totalPages:o(Se,this),zoomLevel:o(Oe,this)}}getEventBus(){return o(D,this)}loadPDFDocument(e){C(Se,this,e.numPages),C(Le,this,1)}handlePDFLoadError(e){o(te,this).handleError(e,"PDFLoad")}get logger(){return o(E,this)}get eventBus(){return o(D,this)}get errorHandler(){return o(te,this)}get pdfManager(){return o(Me,this)}get uiManager(){return o(be,this)}get initialized(){return o(Ce,this)}get currentFile(){return o(ze,this)}set currentFile(e){C(ze,this,e)}get currentPage(){return o(Le,this)}set currentPage(e){C(Le,this,e)}get totalPages(){return o(Se,this)}set totalPages(e){C(Se,this,e)}get zoomLevel(){return o(Oe,this)}set zoomLevel(e){C(Oe,this,e)}get wsClient(){return o(me,this)}get messageQueue(){return o(ge,this)}}function Yt(){window.addEventListener("unhandledrejection",t=>{o(E,this).error("Unhandled Promise Rejection:",t.reason),o(te,this).handleError(t.reason,"UnhandledPromiseRejection")}),window.addEventListener("error",t=>{o(E,this).error("Global Error:",t.error),o(te,this).handleError(t.error,"GlobalError")})}function Xt(){try{o(E,this).info("Initializing WebSocket connection..."),o(me,this).connect(),o(E,this).info("WebSocket connection initialized successfully.")}catch(t){o(E,this).error("Failed to initialize WebSocket connection:",t),o(te,this).handleError(t,"WebSocketInitialization")}}function Jt(t,e,i){ei(t,e),e.set(t,i)}function ei(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(t,e){return t.get(ot(t,e))}function ti(t,e,i){return t.set(ot(t,e),i),i}function ot(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var s=new WeakMap;class ii{constructor(e){Jt(this,s,void 0),ti(s,this,e)}setupEventListeners(){r(s,this).eventBus.on(mt.LOAD_PDF_FILE,e=>{r(s,this).handleWebSocketMessage(e)}),r(s,this).eventBus.on(l.FILE.LOAD.REQUESTED,e=>{this.handleFileLoadRequested(e)}),r(s,this).eventBus.on(l.NAVIGATION.GOTO,e=>{this.handleNavigationGoto(e)}),r(s,this).eventBus.on(l.NAVIGATION.PREVIOUS,()=>{this.handleNavigationPrevious()}),r(s,this).eventBus.on(l.NAVIGATION.NEXT,()=>{this.handleNavigationNext()}),r(s,this).eventBus.on(l.ZOOM.IN,()=>{this.handleZoomIn()}),r(s,this).eventBus.on(l.ZOOM.OUT,()=>{this.handleZoomOut()}),r(s,this).eventBus.on(l.ZOOM.FIT_WIDTH,()=>{this.handleZoomFitWidth()}),r(s,this).eventBus.on(l.ZOOM.FIT_HEIGHT,()=>{this.handleZoomFitHeight()}),r(s,this).eventBus.on(l.ZOOM.ACTUAL_SIZE,()=>{this.handleZoomActualSize()}),r(s,this).eventBus.on(l.ZOOM.CHANGED,e=>{this.handleZoomChanged(e)}),r(s,this).eventBus.on(l.FILE.CLOSE,()=>{this.handleFileClose()}),r(s,this).eventBus.on(l.FILE.LOAD.PROGRESS,e=>{this.handleFileLoadProgress(e)}),r(s,this).eventBus.on(l.STATE.INITIALIZED,r(s,this).onInitialized.bind(r(s,this)))}async handleFileLoadRequested(e){try{r(s,this).logger.info("Handling file load request:",e),r(s,this).currentFile&&await this.handleFileClose(),r(s,this).uiManager.showLoading(!0),r(s,this).uiManager.updateProgress(0,"开始加载"),e.file_path&&(r(s,this).logger.info("Detected file_path in request, constructing proxy URL"),e.url=`/pdfs/${encodeURIComponent(e.filename)}`);const i=await r(s,this).pdfManager.loadPDF(e);r(s,this).currentFile=e,r(s,this).totalPages=i.numPages,r(s,this).uiManager.hideProgress(),r(s,this).uiManager.showLoading(!1),r(s,this).eventBus.emit(l.FILE.LOAD.SUCCESS,{file:e,totalPages:r(s,this).totalPages},{actorId:"PDFViewerApp"}),r(s,this).eventBus.emit(l.NAVIGATION.TOTAL_PAGES_UPDATED,r(s,this).totalPages,{actorId:"PDFViewerApp"}),r(s,this).uiManager.updatePageInfo(1,r(s,this).totalPages),await this.renderPage(1)}catch(i){r(s,this).logger.error("Failed to load PDF file:",i),r(s,this).uiManager.hideProgress(),r(s,this).uiManager.showLoading(!1),r(s,this).uiManager.showError(i),r(s,this).eventBus.emit(l.FILE.LOAD.FAILED,{error:i.message,file:e},{actorId:"PDFViewerApp"}),r(s,this).errorHandler.handleError(i,"PDFLoad")}}async handleNavigationGoto(e){const i=parseInt(e.pageNumber);i>=1&&i<=r(s,this).totalPages&&(r(s,this).currentPage=i,await this.renderPage(i),r(s,this).eventBus.emit(l.NAVIGATION.CHANGED,{currentPage:r(s,this).currentPage,totalPages:r(s,this).totalPages},{actorId:"PDFViewerApp"}),r(s,this).uiManager.updatePageInfo(r(s,this).currentPage,r(s,this).totalPages))}async handleNavigationPrevious(){r(s,this).currentPage>1&&(r(s,this).currentPage--,await this.renderPage(r(s,this).currentPage),r(s,this).eventBus.emit(l.NAVIGATION.CHANGED,{currentPage:r(s,this).currentPage,totalPages:r(s,this).totalPages},{actorId:"PDFViewerApp"}),r(s,this).uiManager.updatePageInfo(r(s,this).currentPage,r(s,this).totalPages))}async handleNavigationNext(){r(s,this).currentPage<r(s,this).totalPages&&(r(s,this).currentPage++,await this.renderPage(r(s,this).currentPage),r(s,this).eventBus.emit(l.NAVIGATION.CHANGED,{currentPage:r(s,this).currentPage,totalPages:r(s,this).totalPages},{actorId:"PDFViewerApp"}),r(s,this).uiManager.updatePageInfo(r(s,this).currentPage,r(s,this).totalPages))}async renderPage(e){try{r(s,this).eventBus.emit(l.RENDER.PAGE_REQUESTED,{pageNumber:e,totalPages:r(s,this).totalPages},{actorId:"PDFViewerApp"});const i=await r(s,this).pdfManager.getPage(e),c=i.getViewport({scale:r(s,this).zoomLevel});await r(s,this).uiManager.renderPage(i,c),r(s,this).eventBus.emit(l.RENDER.PAGE_COMPLETED,{pageNumber:e,viewport:c},{actorId:"PDFViewerApp"})}catch(i){r(s,this).logger.error(`Failed to render page ${e}:`,i),r(s,this).eventBus.emit(l.RENDER.PAGE_FAILED,{pageNumber:e,error:i.message},{actorId:"PDFViewerApp"}),r(s,this).errorHandler.handleError(i,"PageRender")}}handleZoomIn(){r(s,this).zoomLevel=Math.min(r(s,this).zoomLevel+.25,3),this.applyZoom()}handleZoomOut(){r(s,this).zoomLevel=Math.max(r(s,this).zoomLevel-.25,.5),this.applyZoom()}async handleZoomFitWidth(){if(r(s,this).currentFile&&r(s,this).currentPage>0){const e=await r(s,this).pdfManager.getPage(r(s,this).currentPage),i=r(s,this).uiManager.getContainerWidth(),c=e.getViewport({scale:1});r(s,this).zoomLevel=i/c.width,this.applyZoom()}}async handleZoomFitHeight(){if(r(s,this).currentFile&&r(s,this).currentPage>0){const e=await r(s,this).pdfManager.getPage(r(s,this).currentPage),i=r(s,this).uiManager.getContainerHeight(),c=e.getViewport({scale:1});r(s,this).zoomLevel=i/c.height,this.applyZoom()}}handleZoomActualSize(){r(s,this).zoomLevel=1,this.applyZoom()}async applyZoom(){r(s,this).currentFile&&r(s,this).currentPage>0&&(r(s,this).eventBus.emit(l.ZOOM.CHANGED,{zoomLevel:r(s,this).zoomLevel},{actorId:"PDFViewerApp"}),r(s,this).uiManager.setScale(r(s,this).zoomLevel),await this.renderPage(r(s,this).currentPage))}handleZoomChanged(e){e&&e.zoomLevel&&(r(s,this).zoomLevel=e.zoomLevel,r(s,this).logger.debug(`Zoom level changed to: ${r(s,this).zoomLevel}`))}handleFileLoadProgress(e){r(s,this).logger.debug(`File load progress: ${e.percent}%`),r(s,this).uiManager.updateProgress(e.percent,"加载中")}async handleFileLoadRetry(e){r(s,this).logger.info("Retrying file load:",e),r(s,this).uiManager.hideError(),r(s,this).eventBus.emit(l.FILE.LOAD.REQUESTED,e,{actorId:"PDFViewerApp"})}async handleFileClose(){r(s,this).logger.info("Closing current PDF file"),r(s,this).pdfManager.cleanup(),r(s,this).uiManager.cleanup(),r(s,this).currentFile=null,r(s,this).currentPage=1,r(s,this).totalPages=0,r(s,this).zoomLevel=1,r(s,this).eventBus.emit(l.STATE.LOADING,!1,{actorId:"PDFViewerApp"})}}function si(t,e,i){ri(t,e),e.set(t,i)}function ri(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function ni(t,e){return t.get(lt(t,e))}function ai(t,e,i){return t.set(lt(t,e),i),i}function lt(t,e,i){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Ve=new WeakMap;class oi extends Kt{constructor(){super(),si(this,Ve,void 0),ai(Ve,this,new ii(this))}async initialize(){try{this.logger.info("Initializing PDF Viewer App..."),ni(Ve,this).setupEventListeners(),await super.initialize(),this.logger.info("PDF Viewer App initialized successfully.")}catch(e){throw this.logger.error("Application initialization failed.",e),this.errorHandler.handleError(e,"App.initialize"),e}}}document.addEventListener("DOMContentLoaded",async()=>{const t=new oi,e=new se("pdf-viewer/main.js");e.info("PDF.js will be loaded dynamically by PDFManager"),e.info("Starting PDFViewer App initialization..."),await t.initialize(),window.pdfViewerApp={getState:()=>t.getState(),destroy:()=>t.destroy(),_internal:t},e.info("PDFViewer App initialized successfully"),window.PDF_PATH&&(e.info(`Found injected PDF path: ${window.PDF_PATH}`),t.getEventBus().emit(l.FILE.LOAD.REQUESTED,{filename:window.PDF_PATH},{actorId:"Launcher"}))});
