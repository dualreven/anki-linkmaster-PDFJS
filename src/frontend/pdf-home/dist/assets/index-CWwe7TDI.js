(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function a(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(t){if(t.ep)return;t.ep=!0;const o=a(t);fetch(t.href,o)}})();var S=require("../common/event/event-bus.js"),T=y(require("./table-wrapper.js")),f=require("../common/event/event-constants.js"),v=D(require("../common/utils/logger.js")),W=require("../common/error/error-handler.js"),F=require("./ui-manager.js"),C=y(require("../common/pdf/pdf-manager.js")),N=y(require("../common/ws/ws-client.js"));function D(r,i){if(typeof WeakMap=="function")var a=new WeakMap,n=new WeakMap;return(D=function(t,o){if(!o&&t&&t.__esModule)return t;var c,d,g={__proto__:null,default:t};if(t===null||typeof t!="object"&&typeof t!="function")return g;if(c=o?n:a){if(c.has(t))return c.get(t);c.set(t,g)}for(const h in t)h!=="default"&&{}.hasOwnProperty.call(t,h)&&((d=(c=Object.defineProperty)&&Object.getOwnPropertyDescriptor(t,h))&&(d.get||d.set)?c(g,h,d):g[h]=t[h]);return g})(r,i)}function y(r){return r&&r.__esModule?r:{default:r}}function O(r,i){M(r,i),i.add(r)}function p(r,i,a){M(r,i),i.set(r,a)}function M(r,i){if(i.has(r))throw new TypeError("Cannot initialize the same private elements twice on an object")}function e(r,i){return r.get(P(r,i))}function u(r,i,a){return r.set(P(r,i),a),a}function P(r,i,a){if(typeof r=="function"?r===i:r.has(i))return arguments.length<3?i:a;throw new TypeError("Private element is not present on this object")}var s=new WeakMap,l=new WeakMap,b=new WeakMap,w=new WeakMap,m=new WeakMap,E=new WeakMap,_=new WeakMap,A=new WeakSet;class H{constructor(){O(this,A),p(this,s,void 0),p(this,l,void 0),p(this,b,void 0),p(this,w,void 0),p(this,m,void 0),p(this,E,void 0),p(this,_,!1),u(s,this,new v.default("PDFHomeApp")),u(l,this,new S.EventBus({enableValidation:!0,logLevel:v.LogLevel.DEBUG})),u(b,this,new W.ErrorHandler(e(l,this))),u(w,this,new N.default("ws://localhost:8765",e(l,this))),u(m,this,new C.default(e(l,this))),u(E,this,new F.UIManager(e(l,this)))}async initialize(){try{e(s,this).info("Initializing PDF Home App..."),P(A,this,I).call(this);const i=document.querySelector("#pdf-table-container");i?(this.tableWrapper=new T.default(i,{columns:[{formatter:"rowSelection",titleFormatter:"rowSelection",titleFormatterParams:{rowRange:"active"},hozAlign:"center",headerSort:!1,width:50,cellClick:function(a,n){a.stopPropagation()}},{title:"File",field:"filename",widthGrow:2},{title:"Title",field:"title",widthGrow:3},{title:"Pages",field:"page_count",hozAlign:"center",width:80},{title:"Cards",field:"cards_count",hozAlign:"center",width:80}],selectable:!0,layout:"fitColumns"}),this.tableWrapper&&this.tableWrapper.tabulator?e(s,this).info("诊断: 已直接在底层 Tabulator 实例上绑定 'rowSelectionChanged' 和 'cellClick' 事件。"):e(s,this).error("诊断失败: 无法访问到 this.tableWrapper.tabulator！这说明 TableWrapper 初始化可能失败了。"),setTimeout(()=>{this.tableWrapper&&this.tableWrapper.tabulator&&(this.tableWrapper.tabulator.on("rowSelectionChanged",(a,n)=>{console.log("行选择发生变化:",a,n);try{const t=Array.isArray(a)?a.map(o=>o.id||o.filename):[];e(l,this).emit(f.UI_EVENTS.SELECTION.CHANGED,t,{actorId:"PDFHomeApp"})}catch(t){e(s,this).warn("Error handling rowSelectionChanged",t),e(l,this).emit(f.SYSTEM_EVENTS.ERROR.OCCURRED,{type:"table_error",message:t.message,details:{context:"rowSelectionChanged",error:t}})}}),this.tableWrapper.tabulator.on("rowClick",(a,n)=>{console.log("行被点击:",n.getData()),n.isSelected()?n.deselect():n.select()}),this.tableWrapper.tabulator.on("cellClick",(a,n)=>{const t=n.getElement(),o=a.target.closest("button[data-action]");if(o){a.stopPropagation();const c=o.getAttribute("data-action"),d=n.getRow().getData();c==="open"?e(l,this).emit(f.PDF_MANAGEMENT_EVENTS.OPEN.REQUESTED,d.id||d.filename):c==="delete"&&confirm("确定要删除这个PDF文件吗？")&&e(l,this).emit(f.PDF_MANAGEMENT_EVENTS.REMOVE.REQUESTED,d.id||d.filename)}}),e(s,this).info("Tabulator 事件绑定完成"))},100),e(l,this).on(f.PDF_MANAGEMENT_EVENTS.LIST.UPDATED,a=>{try{const n=Array.isArray(a)?a.map(t=>({...t})):[];e(s,this).info(`pdf:list:updated received, count=${n.length}`),n.length>0&&e(s,this).debug("sample item:",n[0]),this.tableWrapper?this.tableWrapper.setData(n):e(s,this).warn("TableWrapper not initialized when pdf:list:updated received")}catch(n){e(s,this).error("Failed to update table wrapper data",n)}},{subscriberId:"PDFHomeApp"}),e(E,this).pdfTable=this.tableWrapper):e(s,this).warn("Table container #pdf-table-container not found; skipping TableWrapper init"),await e(m,this).initialize(),await e(w,this).connect(),await e(E,this).initialize(),u(_,this,!0),e(s,this).info("PDF Home App initialized successfully."),e(l,this).emit(f.APP_EVENTS.INITIALIZATION.COMPLETED,void 0,{actorId:"PDFHomeApp"})}catch(i){e(s,this).error("Application initialization failed.",i),e(b,this).handleError(i,"App.initialize")}}destroy(){e(s,this).info("Destroying PDF Home App..."),e(m,this).destroy(),e(E,this).destroy(),e(w,this).disconnect(),e(l,this).destroy(),e(s,this).info("PDF Home App destroyed.")}getState(){return{initialized:e(_,this),websocketConnected:e(w,this).isConnected(),pdfCount:e(m,this).getPDFs().length}}getEventBus(){return e(l,this)}}function I(){window.addEventListener("unhandledrejection",r=>{e(s,this).error("Unhandled Promise Rejection:",r.reason),e(b,this).handleError(r.reason,"UnhandledPromiseRejection")}),window.addEventListener("error",r=>{e(s,this).error("Global Error:",r.error),e(b,this).handleError(r.error,"GlobalError")})}document.addEventListener("DOMContentLoaded",async()=>{const r=new H,i=new v.default("pdf-home/index.js");try{await r.initialize(),window.app={getState:()=>r.getState(),destroy:()=>r.destroy(),_internal:r},i.info("PDF Home App started. Use window.app.getState() for status.")}catch(a){i.error("Failed to start PDF Home App:",a)}});
