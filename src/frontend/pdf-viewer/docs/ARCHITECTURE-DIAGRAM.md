# PDF Viewer 架构图

## 1. Feature插件架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        PDF Viewer 应用                           │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              main.js (应用入口)                         │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   │                                             │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │       app-bootstrap-feature.js (Feature启动器)         │    │
│  │  - 创建SimpleDependencyContainer                       │    │
│  │  - 注册Features                                        │    │
│  │  - 解析依赖                                            │    │
│  │  - 按顺序安装                                          │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   │                                             │
│                   │  依赖解析顺序:                              │
│                   │  app-core → pdf-manager → ui-manager       │
│                   │                                             │
│         ┌─────────┼─────────┬─────────────────┐               │
│         │         │         │                 │               │
│         ▼         ▼         ▼                 ▼               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐  ┌──────────┐       │
│  │app-core  │ │pdf-mgr   │ │ui-mgr    │  │其他      │       │
│  │Feature   │ │Feature   │ │Feature   │  │Features  │       │
│  └──────────┘ └──────────┘ └──────────┘  └──────────┘       │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 2. Feature模块详细结构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Feature: app-core                          │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  EventBus           - 全局事件总线                    │      │
│  │  WebSocketClient    - WebSocket客户端连接            │      │
│  │  Logger             - 日志系统                       │      │
│  │  ConsoleBridge      - 控制台-WebSocket桥接           │      │
│  └──────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Feature: pdf-manager                         │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  PDFManager         - PDF管理主控制器                │      │
│  │    ├─ PDFLoader           - PDF加载器                │      │
│  │    ├─ PDFDocumentManager  - 文档管理                 │      │
│  │    └─ PageCacheManager    - 页面缓存                 │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
│  监听事件: FILE.LOAD.REQUESTED                                  │
│  发出事件: FILE.LOAD.SUCCESS, FILE.LOAD.FAILED                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     Feature: ui-manager                         │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  UIManagerCore      - UI管理核心                     │      │
│  │    ├─ PDFViewerManager    - PDF渲染引擎             │      │
│  │    ├─ BookmarkManager     - 书签管理                │      │
│  │    ├─ UIZoomControls      - 缩放控件                │      │
│  │    ├─ UILayoutControls    - 布局控件                │      │
│  │    ├─ DOMElementManager   - DOM管理                 │      │
│  │    ├─ KeyboardHandler     - 键盘处理                │      │
│  │    └─ TextLayerManager    - 文本层管理              │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
│  监听事件: FILE.LOAD.SUCCESS, ZOOM.*, NAVIGATION.*             │
│  发出事件: 无（直接调用PDFViewerManager）                       │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 事件驱动流程图

```
┌───────────────────────────────────────────────────────────────────┐
│                         事件总线 (EventBus)                        │
│                                                                    │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│   │  发布者       │    │  事件总线     │    │  订阅者       │      │
│   └──────────────┘    └──────────────┘    └──────────────┘      │
│          │                    │                    │              │
│          │ emit(event)        │                    │              │
│          ├───────────────────►│                    │              │
│          │                    │ notify(subscribers)│              │
│          │                    ├───────────────────►│              │
│          │                    │                    │ handle()     │
│          │                    │                    └─────┐        │
│          │                    │                          │        │
│          │                    │◄─────────────────────────┘        │
│          │                    │  可能emit新事件                   │
│          │◄───────────────────┤                                   │
│          │  事件链式传播       │                                   │
│                                                                    │
└───────────────────────────────────────────────────────────────────┘
```

## 4. PDF加载流程详图

```
用户操作/自动加载
       │
       ▼
┌─────────────────┐
│  发出事件:       │
│  FILE.LOAD.     │
│  REQUESTED      │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  PDFManager监听并处理        │
│  1. loadPDF(fileData)       │
│  2. PDFLoader.loadFromURL() │
│  3. 重试逻辑(最多3次)        │
└────────┬────────────────────┘
         │
         ├─ 成功 ────────────┐
         │                   ▼
         │         ┌──────────────────┐
         │         │  发出事件:        │
         │         │  FILE.LOAD.      │
         │         │  SUCCESS         │
         │         │  {pdfDocument}   │
         │         └────────┬─────────┘
         │                  │
         │                  ▼
         │         ┌──────────────────────┐
         │         │ UIManagerCore监听并处理│
         │         │ 1. 加载到PDFViewer   │
         │         │ 2. 初始化页码显示     │
         │         │ 3. 启用UI控件        │
         │         └──────────────────────┘
         │
         └─ 失败 ───────────┐
                            ▼
                   ┌──────────────────┐
                   │  发出事件:        │
                   │  FILE.LOAD.      │
                   │  FAILED          │
                   │  {error}         │
                   └──────────────────┘
```

## 5. 用户交互事件流（以"下一页"为例）

```
┌──────────────────────────────────────────────────────────────┐
│                    用户点击"下一页"按钮                        │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   UIZoomControls              │
         │   监听#next-page的click事件    │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   EventBus.emit(              │
         │     'NAVIGATION.NEXT'         │
         │   )                           │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   UIManagerCore               │
         │   监听NAVIGATION.NEXT事件      │
         │   执行:                       │
         │   pdfViewerManager.          │
         │     currentPageNumber = n+1  │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   PDFViewerManager            │
         │   设置PDF.js的currentPageNumber│
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   PDF.js                      │
         │   触发pagechanging事件         │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   PDFViewerManager            │
         │   桥接PDF.js事件到EventBus    │
         │   EventBus.emit(              │
         │     'PAGE.CHANGING',          │
         │     {pageNumber}              │
         │   )                           │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   UIManagerCore               │
         │   监听PAGE.CHANGING事件        │
         │   uiZoomControls.            │
         │     updatePageInfo(page)     │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────────────┐
         │   UIZoomControls              │
         │   更新页码输入框显示           │
         │   更新页码文本显示             │
         └───────────────────────────────┘
```

## 6. 缩放功能事件流

```
用户点击"放大"按钮
       │
       ▼
UIZoomControls.onClick
       │
       ▼
EventBus.emit('ZOOM.IN')
       │
       ▼
UIManagerCore监听ZOOM.IN
       │
       ├─ 计算: newScale = currentScale + 0.25
       │
       ▼
pdfViewerManager.currentScale = newScale
       │
       ▼
PDFViewerManager设置PDF.js的scale
       │
       ▼
PDF.js触发scalechanging事件
       │
       ▼
PDFViewerManager桥接
EventBus.emit('ZOOM.CHANGING', {scale})
       │
       ▼
UIManagerCore监听ZOOM.CHANGING
       │
       ▼
uiZoomControls.setScale(scale)
       │
       ▼
更新缩放百分比显示 (如 "125%")
```

## 7. 依赖关系图

```
┌────────────────────────────────────────────────────────────┐
│                      依赖层次                               │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  第1层: 基础设施                                            │
│  ┌──────────────────────────────────────────┐             │
│  │  SimpleDependencyContainer               │             │
│  │  FeatureRegistry                         │             │
│  └──────────────────────────────────────────┘             │
│                       │                                    │
│                       ▼                                    │
│  第2层: 核心Feature                                         │
│  ┌──────────────────────────────────────────┐             │
│  │  app-core Feature                        │             │
│  │  ├─ EventBus                             │             │
│  │  ├─ WebSocketClient                      │             │
│  │  └─ Logger                               │             │
│  └──────────────────────────────────────────┘             │
│                       │                                    │
│          ┌────────────┴────────────┐                      │
│          ▼                         ▼                      │
│  第3层: 功能Features                                        │
│  ┌─────────────┐         ┌─────────────┐                 │
│  │pdf-manager  │         │ ui-manager  │                 │
│  │Feature      │         │ Feature     │                 │
│  │(依赖app-core)│         │(依赖app-core)│                 │
│  │             │         │             │                 │
│  └─────────────┘         └─────────────┘                 │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

## 8. 核心组件协作图

```
┌────────────────────────────────────────────────────────────────┐
│                         核心组件协作                            │
└────────────────────────────────────────────────────────────────┘

                   ┌─────────────────┐
                   │   EventBus      │
                   │  (事件中心)      │
                   └────────┬────────┘
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
          ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  PDFManager  │  │UIManagerCore │  │BookmarkMgr   │
│              │  │              │  │              │
│ - loadPDF    │  │ - initialize │  │ - loadBookmark│
│ - getPage    │  │ - setup      │  │ - navigate   │
└──────┬───────┘  └──────┬───────┘  └──────────────┘
       │                 │
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│  PDFLoader   │  │PDFViewerMgr  │
│              │  │              │
│ - loadURL    │  │ - render     │
│ - loadBlob   │  │ - zoom       │
└──────────────┘  │ - navigate   │
                  └──────┬───────┘
                         │
                         ▼
                  ┌──────────────┐
                  │   PDF.js     │
                  │  (渲染引擎)   │
                  └──────────────┘
```

## 9. 文件组织原则

```
功能模块化
    │
    ├── features/          # Feature插件（新架构）
    │   ├── app-core/     # 每个Feature独立目录
    │   ├── pdf-manager/
    │   └── ui-manager/
    │
    ├── 传统模块/          # 传统模块（旧架构）
    │   ├── pdf/          # 按功能分组
    │   ├── ui/
    │   ├── bookmark/
    │   └── handlers/
    │
    └── 基础设施/
        ├── bootstrap/    # 启动引导
        ├── container/    # 依赖注入
        └── common/       # 通用工具
```

---

**图表版本**: v1.0.0
**最后更新**: 2025-10-02
