<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>EventBusäº‹ä»¶è¿½è¸ªæ—¥å¿—æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #569cd6; }
        h2 { color: #4ec9b0; margin-top: 30px; }
        .section {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log-output {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }
        .log-info { color: #9cdcfe; }
        .log-debug { color: #8a8a8a; }
        .log-event { color: #dcdcaa; }
        .log-warn { color: #ce9178; }
        .log-error { color: #f48771; }
        .trace-id { color: #b5cea8; font-weight: bold; }
        .event-name { color: #c586c0; }
        .timestamp { color: #608b4e; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #1177bb; }
        .tree-view {
            margin-left: 20px;
            border-left: 2px solid #3e3e42;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” EventBusäº‹ä»¶è¿½è¸ªæ—¥å¿—æ¼”ç¤º</h1>

        <div class="section">
            <h2>ğŸ“‹ æ§åˆ¶é¢æ¿</h2>
            <button onclick="demo1()">æ¼”ç¤º1: ç®€å•äº‹ä»¶é“¾</button>
            <button onclick="demo2()">æ¼”ç¤º2: çº§è”äº‹ä»¶</button>
            <button onclick="demo3()">æ¼”ç¤º3: å¹¶è¡Œäº‹ä»¶</button>
            <button onclick="showStats()">æ˜¾ç¤ºç»Ÿè®¡</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š å®æ—¶æ—¥å¿—è¾“å‡º</h2>
            <div id="logOutput" class="log-output"></div>
        </div>

        <div class="section">
            <h2>ğŸŒ² è°ƒç”¨é“¾æ ‘å½¢è§†å›¾</h2>
            <div id="treeOutput" class="log-output"></div>
        </div>

        <div class="section">
            <h2>ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</h2>
            <div id="statsOutput" class="log-output"></div>
        </div>
    </div>

    <script type="module">
        import { EventBus } from './common/event/event-bus-with-tracing.js';

        // åˆ›å»ºå¯ç”¨è¿½è¸ªçš„EventBus
        const eventBus = new EventBus({
            enableTracing: true,
            moduleName: 'DemoModule',
            maxTraceSize: 100,
            enablePerformanceTracking: true
        });

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function log(level, message, data) {
            const logDiv = document.getElementById('logOutput');
            const time = new Date().toISOString().substr(11, 12);
            const levelClass = `log-${level}`;

            let logLine = `<span class="timestamp">[${time}]</span> <span class="${levelClass}">[${level.toUpperCase()}]</span> ${message}`;

            if (data) {
                logLine += '\n' + JSON.stringify(data, null, 2);
            }

            logDiv.innerHTML += logLine + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // é‡å†™console.logä»¥æ•è·EventBusçš„å†…éƒ¨æ—¥å¿—
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');

            // è§£æEventBusæ—¥å¿—æ ¼å¼
            if (message.includes('[EventBus]')) {
                const match = message.match(/\[EventBus\]\s*\[(\w+)\]\s*(.*)/);
                if (match) {
                    log(match[1].toLowerCase(), match[2]);
                }
            }
        };

        // æ¼”ç¤º1: ç®€å•äº‹ä»¶é“¾
        window.demo1 = function() {
            log('info', '=== æ¼”ç¤º1: ç®€å•äº‹ä»¶é“¾ ===');

            // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
            eventBus.on('user:click:button', (data, traceInfo) => {
                log('event', `å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶`, {
                    data,
                    traceInfo: {
                        messageId: traceInfo.messageId,
                        traceId: traceInfo.traceId
                    }
                });

                // è§¦å‘åç»­äº‹ä»¶
                eventBus.emit('api:request:start', { url: '/api/data' }, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            eventBus.on('api:request:start', (data, traceInfo) => {
                log('event', `å¼€å§‹APIè¯·æ±‚`, {
                    url: data.url,
                    traceId: traceInfo.traceId
                });

                // æ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚
                setTimeout(() => {
                    eventBus.emit('api:request:success', {
                        url: data.url,
                        result: 'OK'
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, 100);
            });

            eventBus.on('api:request:success', (data, traceInfo) => {
                log('event', `APIè¯·æ±‚æˆåŠŸ`, {
                    result: data.result,
                    traceId: traceInfo.traceId
                });

                // æ˜¾ç¤ºè°ƒç”¨é“¾
                showTraceTree(traceInfo.traceId);
            });

            // è§¦å‘åˆå§‹äº‹ä»¶
            const result = eventBus.emit('user:click:button', { buttonId: 'btn-1' });
            log('info', `äº‹ä»¶å‘å¸ƒç»“æœ:`, result);
        };

        // æ¼”ç¤º2: çº§è”äº‹ä»¶
        window.demo2 = function() {
            log('info', '=== æ¼”ç¤º2: çº§è”äº‹ä»¶ï¼ˆPDFæ‰“å¼€æµç¨‹ï¼‰===');

            // PDFåˆ—è¡¨åŒå‡»
            eventBus.on('pdf:list:dblclick', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:list:dblclick</span> - ç”¨æˆ·åŒå‡»PDF: ${data.filename}`, {
                    traceId: `<span class="trace-id">${traceInfo.traceId}</span>`
                });

                eventBus.emit('pdf:open:requested', data, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            // PDFæ‰“å¼€è¯·æ±‚
            eventBus.on('pdf:open:requested', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:open:requested</span> - è¯·æ±‚æ‰“å¼€PDF`, {
                    filename: data.filename,
                    messageId: traceInfo.messageId
                });

                // è§¦å‘WebSocketæ¶ˆæ¯
                eventBus.emit('websocket:send:message', {
                    type: 'open_pdf',
                    filename: data.filename
                }, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            // WebSocketå‘é€
            eventBus.on('websocket:send:message', (data, traceInfo) => {
                log('event', `<span class="event-name">websocket:send:message</span> - å‘é€åˆ°åç«¯`, {
                    type: data.type
                });

                setTimeout(() => {
                    eventBus.emit('pdf:open:success', {
                        filename: data.filename,
                        windowId: 'win-123'
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, 200);
            });

            // PDFæ‰“å¼€æˆåŠŸ
            eventBus.on('pdf:open:success', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:open:success</span> - PDFå·²æ‰“å¼€`, {
                    windowId: data.windowId
                });

                // æ˜¾ç¤ºå®Œæ•´è°ƒç”¨é“¾
                showTraceTree(traceInfo.traceId);
            });

            // è§¦å‘äº‹ä»¶
            const result = eventBus.emit('pdf:list:dblclick', {
                filename: 'test-document.pdf'
            });
            log('info', `è°ƒç”¨é“¾ID: <span class="trace-id">${result.traceId}</span>`);
        };

        // æ¼”ç¤º3: å¹¶è¡Œäº‹ä»¶
        window.demo3 = function() {
            log('info', '=== æ¼”ç¤º3: å¹¶è¡Œäº‹ä»¶å¤„ç† ===');

            eventBus.on('batch:process:start', (data, traceInfo) => {
                log('event', `æ‰¹å¤„ç†å¼€å§‹: ${data.items.length} ä¸ªé¡¹ç›®`);

                // å¹¶è¡Œå¤„ç†æ¯ä¸ªé¡¹ç›®
                data.items.forEach((item, index) => {
                    eventBus.emit('item:process:start', {
                        item,
                        index
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                });
            });

            eventBus.on('item:process:start', (data, traceInfo) => {
                log('debug', `å¤„ç†é¡¹ç›® ${data.index}: ${data.item}`);

                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                const delay = Math.random() * 300;
                setTimeout(() => {
                    eventBus.emit('item:process:complete', {
                        item: data.item,
                        index: data.index,
                        processingTime: delay
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, delay);
            });

            let completedCount = 0;
            eventBus.on('item:process:complete', (data, traceInfo) => {
                completedCount++;
                log('debug', `é¡¹ç›® ${data.index} å®Œæˆ (${data.processingTime.toFixed(0)}ms)`);

                if (completedCount === 5) {
                    showTraceTree(traceInfo.traceId);
                    completedCount = 0;
                }
            });

            // è§¦å‘æ‰¹å¤„ç†
            const result = eventBus.emit('batch:process:start', {
                items: ['Item-A', 'Item-B', 'Item-C', 'Item-D', 'Item-E']
            });
        };

        // æ˜¾ç¤ºè°ƒç”¨é“¾æ ‘
        function showTraceTree(traceId) {
            const tree = eventBus.getTraceTree(traceId);
            if (!tree) {
                log('warn', 'æœªæ‰¾åˆ°è°ƒç”¨é“¾');
                return;
            }

            const treeDiv = document.getElementById('treeOutput');
            treeDiv.innerHTML = `<strong>è°ƒç”¨é“¾ ${traceId}:</strong>\n`;
            treeDiv.innerHTML += `å¼€å§‹æ—¶é—´: ${new Date(tree.startTime).toISOString()}\n`;
            treeDiv.innerHTML += `æ€»è€—æ—¶: ${tree.totalDuration}ms\n\n`;
            treeDiv.innerHTML += 'æ¶ˆæ¯æ ‘:\n';
            treeDiv.innerHTML += formatTreeNode(tree.messages, 0);
        }

        // æ ¼å¼åŒ–æ ‘èŠ‚ç‚¹
        function formatTreeNode(nodes, level) {
            let output = '';
            const indent = '  '.repeat(level);

            nodes.forEach(node => {
                const status = node.hasErrors ? 'âŒ' : 'âœ…';
                const time = node.executionTime ? `(${node.executionTime}ms)` : '';
                output += `${indent}${status} ${node.event} ${time}\n`;

                if (node.executionResults) {
                    node.executionResults.forEach(result => {
                        const resultStatus = result.success ? 'âœ“' : 'âœ—';
                        output += `${indent}  ${resultStatus} ${result.subscriberId}: ${result.executionTime}ms\n`;
                    });
                }

                if (node.children && node.children.length > 0) {
                    output += formatTreeNode(node.children, level + 1);
                }
            });

            return output;
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        window.showStats = function() {
            const stats = eventBus.getStats();
            const statsDiv = document.getElementById('statsOutput');

            statsDiv.innerHTML = '<strong>æ€§èƒ½ç»Ÿè®¡:</strong>\n';
            statsDiv.innerHTML += JSON.stringify(stats, null, 2);
        };

        // æ¸…ç©ºæ—¥å¿—
        window.clearLogs = function() {
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('treeOutput').innerHTML = '';
            document.getElementById('statsOutput').innerHTML = '';
            log('info', 'æ—¥å¿—å·²æ¸…ç©º');
        };

        // åˆå§‹åŒ–
        log('info', 'EventBusäº‹ä»¶è¿½è¸ªæ¼”ç¤ºå·²å°±ç»ª');
        log('info', 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹ä¸åŒçš„äº‹ä»¶è¿½è¸ªåœºæ™¯');
    </script>
</body>
</html>