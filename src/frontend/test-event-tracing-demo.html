<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>EventBus事件追踪日志演示</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #569cd6; }
        h2 { color: #4ec9b0; margin-top: 30px; }
        .section {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log-output {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }
        .log-info { color: #9cdcfe; }
        .log-debug { color: #8a8a8a; }
        .log-event { color: #dcdcaa; }
        .log-warn { color: #ce9178; }
        .log-error { color: #f48771; }
        .trace-id { color: #b5cea8; font-weight: bold; }
        .event-name { color: #c586c0; }
        .timestamp { color: #608b4e; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #1177bb; }
        .tree-view {
            margin-left: 20px;
            border-left: 2px solid #3e3e42;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 EventBus事件追踪日志演示</h1>

        <div class="section">
            <h2>📋 控制面板</h2>
            <button onclick="demo1()">演示1: 简单事件链</button>
            <button onclick="demo2()">演示2: 级联事件</button>
            <button onclick="demo3()">演示3: 并行事件</button>
            <button onclick="showStats()">显示统计</button>
            <button onclick="clearLogs()">清空日志</button>
        </div>

        <div class="section">
            <h2>📊 实时日志输出</h2>
            <div id="logOutput" class="log-output"></div>
        </div>

        <div class="section">
            <h2>🌲 调用链树形视图</h2>
            <div id="treeOutput" class="log-output"></div>
        </div>

        <div class="section">
            <h2>📈 性能统计</h2>
            <div id="statsOutput" class="log-output"></div>
        </div>
    </div>

    <script type="module">
        import { EventBus } from './common/event/event-bus-with-tracing.js';

        // 创建启用追踪的EventBus
        const eventBus = new EventBus({
            enableTracing: true,
            moduleName: 'DemoModule',
            maxTraceSize: 100,
            enablePerformanceTracking: true
        });

        // 日志输出函数
        function log(level, message, data) {
            const logDiv = document.getElementById('logOutput');
            const time = new Date().toISOString().substr(11, 12);
            const levelClass = `log-${level}`;

            let logLine = `<span class="timestamp">[${time}]</span> <span class="${levelClass}">[${level.toUpperCase()}]</span> ${message}`;

            if (data) {
                logLine += '\n' + JSON.stringify(data, null, 2);
            }

            logDiv.innerHTML += logLine + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 重写console.log以捕获EventBus的内部日志
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');

            // 解析EventBus日志格式
            if (message.includes('[EventBus]')) {
                const match = message.match(/\[EventBus\]\s*\[(\w+)\]\s*(.*)/);
                if (match) {
                    log(match[1].toLowerCase(), match[2]);
                }
            }
        };

        // 演示1: 简单事件链
        window.demo1 = function() {
            log('info', '=== 演示1: 简单事件链 ===');

            // 注册事件处理器
            eventBus.on('user:click:button', (data, traceInfo) => {
                log('event', `处理按钮点击事件`, {
                    data,
                    traceInfo: {
                        messageId: traceInfo.messageId,
                        traceId: traceInfo.traceId
                    }
                });

                // 触发后续事件
                eventBus.emit('api:request:start', { url: '/api/data' }, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            eventBus.on('api:request:start', (data, traceInfo) => {
                log('event', `开始API请求`, {
                    url: data.url,
                    traceId: traceInfo.traceId
                });

                // 模拟异步请求
                setTimeout(() => {
                    eventBus.emit('api:request:success', {
                        url: data.url,
                        result: 'OK'
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, 100);
            });

            eventBus.on('api:request:success', (data, traceInfo) => {
                log('event', `API请求成功`, {
                    result: data.result,
                    traceId: traceInfo.traceId
                });

                // 显示调用链
                showTraceTree(traceInfo.traceId);
            });

            // 触发初始事件
            const result = eventBus.emit('user:click:button', { buttonId: 'btn-1' });
            log('info', `事件发布结果:`, result);
        };

        // 演示2: 级联事件
        window.demo2 = function() {
            log('info', '=== 演示2: 级联事件（PDF打开流程）===');

            // PDF列表双击
            eventBus.on('pdf:list:dblclick', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:list:dblclick</span> - 用户双击PDF: ${data.filename}`, {
                    traceId: `<span class="trace-id">${traceInfo.traceId}</span>`
                });

                eventBus.emit('pdf:open:requested', data, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            // PDF打开请求
            eventBus.on('pdf:open:requested', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:open:requested</span> - 请求打开PDF`, {
                    filename: data.filename,
                    messageId: traceInfo.messageId
                });

                // 触发WebSocket消息
                eventBus.emit('websocket:send:message', {
                    type: 'open_pdf',
                    filename: data.filename
                }, {
                    parentTraceId: traceInfo.traceId,
                    parentMessageId: traceInfo.messageId
                });
            });

            // WebSocket发送
            eventBus.on('websocket:send:message', (data, traceInfo) => {
                log('event', `<span class="event-name">websocket:send:message</span> - 发送到后端`, {
                    type: data.type
                });

                setTimeout(() => {
                    eventBus.emit('pdf:open:success', {
                        filename: data.filename,
                        windowId: 'win-123'
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, 200);
            });

            // PDF打开成功
            eventBus.on('pdf:open:success', (data, traceInfo) => {
                log('event', `<span class="event-name">pdf:open:success</span> - PDF已打开`, {
                    windowId: data.windowId
                });

                // 显示完整调用链
                showTraceTree(traceInfo.traceId);
            });

            // 触发事件
            const result = eventBus.emit('pdf:list:dblclick', {
                filename: 'test-document.pdf'
            });
            log('info', `调用链ID: <span class="trace-id">${result.traceId}</span>`);
        };

        // 演示3: 并行事件
        window.demo3 = function() {
            log('info', '=== 演示3: 并行事件处理 ===');

            eventBus.on('batch:process:start', (data, traceInfo) => {
                log('event', `批处理开始: ${data.items.length} 个项目`);

                // 并行处理每个项目
                data.items.forEach((item, index) => {
                    eventBus.emit('item:process:start', {
                        item,
                        index
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                });
            });

            eventBus.on('item:process:start', (data, traceInfo) => {
                log('debug', `处理项目 ${data.index}: ${data.item}`);

                // 模拟处理时间
                const delay = Math.random() * 300;
                setTimeout(() => {
                    eventBus.emit('item:process:complete', {
                        item: data.item,
                        index: data.index,
                        processingTime: delay
                    }, {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    });
                }, delay);
            });

            let completedCount = 0;
            eventBus.on('item:process:complete', (data, traceInfo) => {
                completedCount++;
                log('debug', `项目 ${data.index} 完成 (${data.processingTime.toFixed(0)}ms)`);

                if (completedCount === 5) {
                    showTraceTree(traceInfo.traceId);
                    completedCount = 0;
                }
            });

            // 触发批处理
            const result = eventBus.emit('batch:process:start', {
                items: ['Item-A', 'Item-B', 'Item-C', 'Item-D', 'Item-E']
            });
        };

        // 显示调用链树
        function showTraceTree(traceId) {
            const tree = eventBus.getTraceTree(traceId);
            if (!tree) {
                log('warn', '未找到调用链');
                return;
            }

            const treeDiv = document.getElementById('treeOutput');
            treeDiv.innerHTML = `<strong>调用链 ${traceId}:</strong>\n`;
            treeDiv.innerHTML += `开始时间: ${new Date(tree.startTime).toISOString()}\n`;
            treeDiv.innerHTML += `总耗时: ${tree.totalDuration}ms\n\n`;
            treeDiv.innerHTML += '消息树:\n';
            treeDiv.innerHTML += formatTreeNode(tree.messages, 0);
        }

        // 格式化树节点
        function formatTreeNode(nodes, level) {
            let output = '';
            const indent = '  '.repeat(level);

            nodes.forEach(node => {
                const status = node.hasErrors ? '❌' : '✅';
                const time = node.executionTime ? `(${node.executionTime}ms)` : '';
                output += `${indent}${status} ${node.event} ${time}\n`;

                if (node.executionResults) {
                    node.executionResults.forEach(result => {
                        const resultStatus = result.success ? '✓' : '✗';
                        output += `${indent}  ${resultStatus} ${result.subscriberId}: ${result.executionTime}ms\n`;
                    });
                }

                if (node.children && node.children.length > 0) {
                    output += formatTreeNode(node.children, level + 1);
                }
            });

            return output;
        }

        // 显示统计信息
        window.showStats = function() {
            const stats = eventBus.getStats();
            const statsDiv = document.getElementById('statsOutput');

            statsDiv.innerHTML = '<strong>性能统计:</strong>\n';
            statsDiv.innerHTML += JSON.stringify(stats, null, 2);
        };

        // 清空日志
        window.clearLogs = function() {
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('treeOutput').innerHTML = '';
            document.getElementById('statsOutput').innerHTML = '';
            log('info', '日志已清空');
        };

        // 初始化
        log('info', 'EventBus事件追踪演示已就绪');
        log('info', '点击上方按钮查看不同的事件追踪场景');
    </script>
</body>
</html>