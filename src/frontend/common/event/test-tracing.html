<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventBus 消息追踪功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background-color 0.2s;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        #console {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .demo-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 EventBus 消息追踪功能测试</h1>

        <div class="test-section">
            <h2>自动化测试</h2>
            <button id="runTests" class="button">运行完整测试套件</button>
            <button id="clearConsole" class="button">清空控制台</button>
        </div>

        <div class="demo-section">
            <h2>🎯 交互式演示</h2>
            <p>这些按钮演示EventBus追踪功能的实际使用：</p>

            <button id="demoBasic" class="button">基础追踪演示</button>
            <button id="demoCascade" class="button">级联事件演示</button>
            <button id="demoError" class="button">错误追踪演示</button>
            <button id="demoPerformance" class="button">性能分析演示</button>

            <div id="demoStatus"></div>
        </div>

        <div id="console"></div>
    </div>

    <script type="module">
        // 劫持console.log以显示在页面上
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;

        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : '📝';
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = (...args) => {
            originalError(...args);
            appendToConsole(args.join(' '), 'error');
        };

        // 导入测试模块
        import { runMessageTracingTests } from './test-message-tracing.js';
        import { EventBus } from './event-bus-with-tracing.js';

        // 运行测试按钮
        document.getElementById('runTests').addEventListener('click', async () => {
            const button = document.getElementById('runTests');
            button.disabled = true;
            button.textContent = '运行中...';

            try {
                const success = await runMessageTracingTests();
                button.className = success ? 'button success' : 'button danger';
                button.textContent = success ? '✅ 测试通过' : '❌ 测试失败';
            } catch (error) {
                console.error('测试运行失败:', error);
                button.className = 'button danger';
                button.textContent = '❌ 运行错误';
            }

            setTimeout(() => {
                button.disabled = false;
                button.className = 'button';
                button.textContent = '运行完整测试套件';
            }, 3000);
        });

        // 清空控制台
        document.getElementById('clearConsole').addEventListener('click', () => {
            consoleDiv.textContent = '';
        });

        // 创建演示用的EventBus
        const demoEventBus = new EventBus({
            enableTracing: true,
            moduleName: 'DemoModule',
            maxTraceSize: 50
        });

        // 状态显示
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('demoStatus');
            statusDiv.innerHTML = `<div class="status ${isSuccess ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // 基础追踪演示
        document.getElementById('demoBasic').addEventListener('click', () => {
            console.log('\n🎯 === 基础追踪演示 ===');

            // 设置订阅者
            demoEventBus.on('demo:basic:event', (data, traceInfo) => {
                console.log(`收到事件数据:`, data);
                console.log(`追踪信息:`, traceInfo);
            });

            // 发布事件
            const result = demoEventBus.emit('demo:basic:event', {
                message: '这是一个基础演示',
                timestamp: Date.now()
            });

            console.log(`发布结果:`, result);

            // 获取追踪记录
            const trace = demoEventBus.getMessageTrace(result.messageId);
            console.log(`完整追踪记录:`, trace);

            showStatus('✅ 基础追踪演示完成，查看控制台输出');
        });

        // 级联事件演示
        document.getElementById('demoCascade').addEventListener('click', () => {
            console.log('\n🔗 === 级联事件演示 ===');

            // 第一级事件
            demoEventBus.on('demo:parent:event', (data, traceInfo) => {
                console.log(`父事件处理: ${data.message}`);

                // 触发子事件
                demoEventBus.emit('demo:child:event',
                    { message: '这是子事件', parent: data.message },
                    {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    }
                );
            });

            // 第二级事件
            demoEventBus.on('demo:child:event', (data, traceInfo) => {
                console.log(`子事件处理: ${data.message}`);

                // 触发孙子事件
                demoEventBus.emit('demo:grandchild:event',
                    { message: '这是孙子事件', grandparent: data.parent },
                    {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    }
                );
            });

            // 第三级事件
            demoEventBus.on('demo:grandchild:event', (data, traceInfo) => {
                console.log(`孙子事件处理: ${data.message}`);
                console.log(`完整追踪信息:`, traceInfo);
            });

            // 启动事件链
            const result = demoEventBus.emit('demo:parent:event', {
                message: '这是父事件'
            });

            // 等待所有事件处理完成后显示调用链树
            setTimeout(() => {
                const tree = demoEventBus.getTraceTree(result.traceId);
                console.log(`📊 调用链树:`, tree);

                console.log('\n🌳 调用链可视化:');
                function printTree(messages, indent = 0) {
                    messages.forEach(msg => {
                        console.log('  '.repeat(indent) + `├─ ${msg.event} (${msg.executionTime}ms)`);
                        if (msg.children.length > 0) {
                            printTree(msg.children, indent + 1);
                        }
                    });
                }
                if (tree && tree.messages) {
                    printTree(tree.messages);
                }
            }, 100);

            showStatus('✅ 级联事件演示完成，查看控制台中的调用链树');
        });

        // 错误追踪演示
        document.getElementById('demoError').addEventListener('click', () => {
            console.log('\n💥 === 错误追踪演示 ===');

            // 正常订阅者
            demoEventBus.on('demo:error:event', (data) => {
                console.log(`正常处理器: ${data.message}`);
            });

            // 会出错的订阅者
            demoEventBus.on('demo:error:event', (data) => {
                throw new Error('这是一个演示错误');
            });

            // 另一个正常订阅者
            demoEventBus.on('demo:error:event', (data) => {
                console.log(`另一个正常处理器: ${data.message}`);
            });

            // 发布事件
            const result = demoEventBus.emit('demo:error:event', {
                message: '测试错误处理'
            });

            // 获取追踪记录查看错误
            const trace = demoEventBus.getMessageTrace(result.messageId);
            console.log(`📊 执行结果统计:`);
            console.log(`  - 总订阅者: ${trace.executionResults.length}`);
            console.log(`  - 成功执行: ${trace.executionResults.filter(r => r.success).length}`);
            console.log(`  - 执行失败: ${trace.executionResults.filter(r => !r.success).length}`);

            const errors = trace.executionResults.filter(r => !r.success);
            if (errors.length > 0) {
                console.log(`❌ 错误详情:`, errors);
            }

            showStatus('✅ 错误追踪演示完成，可以看到错误被正确捕获和记录');
        });

        // 性能分析演示
        document.getElementById('demoPerformance').addEventListener('click', () => {
            console.log('\n⚡ === 性能分析演示 ===');

            // 快速订阅者
            demoEventBus.on('demo:perf:event', (data) => {
                // 立即返回
            });

            // 慢速订阅者
            demoEventBus.on('demo:perf:event', (data) => {
                // 模拟50ms的处理时间
                const start = Date.now();
                while (Date.now() - start < 50) {
                    // 忙等待
                }
            });

            // 中等速度订阅者
            demoEventBus.on('demo:perf:event', (data) => {
                // 模拟20ms的处理时间
                const start = Date.now();
                while (Date.now() - start < 20) {
                    // 忙等待
                }
            });

            // 发布多个事件进行性能测试
            console.log('发布5个性能测试事件...');
            for (let i = 0; i < 5; i++) {
                demoEventBus.emit('demo:perf:event', {
                    iteration: i + 1,
                    timestamp: Date.now()
                });
            }

            // 获取性能统计
            setTimeout(() => {
                const stats = demoEventBus.getStats('demo:perf:event');
                console.log(`📊 性能统计报告:`);
                console.log(`  - 总消息数: ${stats.totalMessages}`);
                console.log(`  - 平均执行时间: ${stats.averageExecutionTime.toFixed(2)}ms`);
                console.log(`  - 最大执行时间: ${stats.maxExecutionTime}ms`);
                console.log(`  - 最小执行时间: ${stats.minExecutionTime}ms`);
                console.log(`  - 错误率: ${(stats.errorRate * 100).toFixed(2)}%`);
                console.log(`  - 总执行次数: ${stats.totalExecutions}`);

                // 获取追踪器状态
                const status = demoEventBus.getTracingStatus();
                console.log(`📈 追踪器状态:`, status);
            }, 100);

            showStatus('✅ 性能分析演示完成，查看控制台中的详细性能报告');
        });

        // 初始化消息
        console.log('🚀 EventBus 消息追踪功能测试页面已加载');
        console.log('点击上方按钮开始测试或演示功能');
        console.log('');
    </script>
</body>
</html>