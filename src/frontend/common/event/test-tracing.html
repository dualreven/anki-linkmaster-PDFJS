<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventBus æ¶ˆæ¯è¿½è¸ªåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background-color 0.2s;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        #console {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .demo-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª EventBus æ¶ˆæ¯è¿½è¸ªåŠŸèƒ½æµ‹è¯•</h1>

        <div class="test-section">
            <h2>è‡ªåŠ¨åŒ–æµ‹è¯•</h2>
            <button id="runTests" class="button">è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶</button>
            <button id="clearConsole" class="button">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>

        <div class="demo-section">
            <h2>ğŸ¯ äº¤äº’å¼æ¼”ç¤º</h2>
            <p>è¿™äº›æŒ‰é’®æ¼”ç¤ºEventBusè¿½è¸ªåŠŸèƒ½çš„å®é™…ä½¿ç”¨ï¼š</p>

            <button id="demoBasic" class="button">åŸºç¡€è¿½è¸ªæ¼”ç¤º</button>
            <button id="demoCascade" class="button">çº§è”äº‹ä»¶æ¼”ç¤º</button>
            <button id="demoError" class="button">é”™è¯¯è¿½è¸ªæ¼”ç¤º</button>
            <button id="demoPerformance" class="button">æ€§èƒ½åˆ†ææ¼”ç¤º</button>

            <div id="demoStatus"></div>
        </div>

        <div id="console"></div>
    </div>

    <script type="module">
        // åŠ«æŒconsole.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;

        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'ğŸ“';
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = (...args) => {
            originalError(...args);
            appendToConsole(args.join(' '), 'error');
        };

        // å¯¼å…¥æµ‹è¯•æ¨¡å—
        import { runMessageTracingTests } from './test-message-tracing.js';
        import { EventBus } from './event-bus-with-tracing.js';

        // è¿è¡Œæµ‹è¯•æŒ‰é’®
        document.getElementById('runTests').addEventListener('click', async () => {
            const button = document.getElementById('runTests');
            button.disabled = true;
            button.textContent = 'è¿è¡Œä¸­...';

            try {
                const success = await runMessageTracingTests();
                button.className = success ? 'button success' : 'button danger';
                button.textContent = success ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•å¤±è´¥';
            } catch (error) {
                console.error('æµ‹è¯•è¿è¡Œå¤±è´¥:', error);
                button.className = 'button danger';
                button.textContent = 'âŒ è¿è¡Œé”™è¯¯';
            }

            setTimeout(() => {
                button.disabled = false;
                button.className = 'button';
                button.textContent = 'è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶';
            }, 3000);
        });

        // æ¸…ç©ºæ§åˆ¶å°
        document.getElementById('clearConsole').addEventListener('click', () => {
            consoleDiv.textContent = '';
        });

        // åˆ›å»ºæ¼”ç¤ºç”¨çš„EventBus
        const demoEventBus = new EventBus({
            enableTracing: true,
            moduleName: 'DemoModule',
            maxTraceSize: 50
        });

        // çŠ¶æ€æ˜¾ç¤º
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('demoStatus');
            statusDiv.innerHTML = `<div class="status ${isSuccess ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // åŸºç¡€è¿½è¸ªæ¼”ç¤º
        document.getElementById('demoBasic').addEventListener('click', () => {
            console.log('\nğŸ¯ === åŸºç¡€è¿½è¸ªæ¼”ç¤º ===');

            // è®¾ç½®è®¢é˜…è€…
            demoEventBus.on('demo:basic:event', (data, traceInfo) => {
                console.log(`æ”¶åˆ°äº‹ä»¶æ•°æ®:`, data);
                console.log(`è¿½è¸ªä¿¡æ¯:`, traceInfo);
            });

            // å‘å¸ƒäº‹ä»¶
            const result = demoEventBus.emit('demo:basic:event', {
                message: 'è¿™æ˜¯ä¸€ä¸ªåŸºç¡€æ¼”ç¤º',
                timestamp: Date.now()
            });

            console.log(`å‘å¸ƒç»“æœ:`, result);

            // è·å–è¿½è¸ªè®°å½•
            const trace = demoEventBus.getMessageTrace(result.messageId);
            console.log(`å®Œæ•´è¿½è¸ªè®°å½•:`, trace);

            showStatus('âœ… åŸºç¡€è¿½è¸ªæ¼”ç¤ºå®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º');
        });

        // çº§è”äº‹ä»¶æ¼”ç¤º
        document.getElementById('demoCascade').addEventListener('click', () => {
            console.log('\nğŸ”— === çº§è”äº‹ä»¶æ¼”ç¤º ===');

            // ç¬¬ä¸€çº§äº‹ä»¶
            demoEventBus.on('demo:parent:event', (data, traceInfo) => {
                console.log(`çˆ¶äº‹ä»¶å¤„ç†: ${data.message}`);

                // è§¦å‘å­äº‹ä»¶
                demoEventBus.emit('demo:child:event',
                    { message: 'è¿™æ˜¯å­äº‹ä»¶', parent: data.message },
                    {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    }
                );
            });

            // ç¬¬äºŒçº§äº‹ä»¶
            demoEventBus.on('demo:child:event', (data, traceInfo) => {
                console.log(`å­äº‹ä»¶å¤„ç†: ${data.message}`);

                // è§¦å‘å­™å­äº‹ä»¶
                demoEventBus.emit('demo:grandchild:event',
                    { message: 'è¿™æ˜¯å­™å­äº‹ä»¶', grandparent: data.parent },
                    {
                        parentTraceId: traceInfo.traceId,
                        parentMessageId: traceInfo.messageId
                    }
                );
            });

            // ç¬¬ä¸‰çº§äº‹ä»¶
            demoEventBus.on('demo:grandchild:event', (data, traceInfo) => {
                console.log(`å­™å­äº‹ä»¶å¤„ç†: ${data.message}`);
                console.log(`å®Œæ•´è¿½è¸ªä¿¡æ¯:`, traceInfo);
            });

            // å¯åŠ¨äº‹ä»¶é“¾
            const result = demoEventBus.emit('demo:parent:event', {
                message: 'è¿™æ˜¯çˆ¶äº‹ä»¶'
            });

            // ç­‰å¾…æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆåæ˜¾ç¤ºè°ƒç”¨é“¾æ ‘
            setTimeout(() => {
                const tree = demoEventBus.getTraceTree(result.traceId);
                console.log(`ğŸ“Š è°ƒç”¨é“¾æ ‘:`, tree);

                console.log('\nğŸŒ³ è°ƒç”¨é“¾å¯è§†åŒ–:');
                function printTree(messages, indent = 0) {
                    messages.forEach(msg => {
                        console.log('  '.repeat(indent) + `â”œâ”€ ${msg.event} (${msg.executionTime}ms)`);
                        if (msg.children.length > 0) {
                            printTree(msg.children, indent + 1);
                        }
                    });
                }
                if (tree && tree.messages) {
                    printTree(tree.messages);
                }
            }, 100);

            showStatus('âœ… çº§è”äº‹ä»¶æ¼”ç¤ºå®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸­çš„è°ƒç”¨é“¾æ ‘');
        });

        // é”™è¯¯è¿½è¸ªæ¼”ç¤º
        document.getElementById('demoError').addEventListener('click', () => {
            console.log('\nğŸ’¥ === é”™è¯¯è¿½è¸ªæ¼”ç¤º ===');

            // æ­£å¸¸è®¢é˜…è€…
            demoEventBus.on('demo:error:event', (data) => {
                console.log(`æ­£å¸¸å¤„ç†å™¨: ${data.message}`);
            });

            // ä¼šå‡ºé”™çš„è®¢é˜…è€…
            demoEventBus.on('demo:error:event', (data) => {
                throw new Error('è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºé”™è¯¯');
            });

            // å¦ä¸€ä¸ªæ­£å¸¸è®¢é˜…è€…
            demoEventBus.on('demo:error:event', (data) => {
                console.log(`å¦ä¸€ä¸ªæ­£å¸¸å¤„ç†å™¨: ${data.message}`);
            });

            // å‘å¸ƒäº‹ä»¶
            const result = demoEventBus.emit('demo:error:event', {
                message: 'æµ‹è¯•é”™è¯¯å¤„ç†'
            });

            // è·å–è¿½è¸ªè®°å½•æŸ¥çœ‹é”™è¯¯
            const trace = demoEventBus.getMessageTrace(result.messageId);
            console.log(`ğŸ“Š æ‰§è¡Œç»“æœç»Ÿè®¡:`);
            console.log(`  - æ€»è®¢é˜…è€…: ${trace.executionResults.length}`);
            console.log(`  - æˆåŠŸæ‰§è¡Œ: ${trace.executionResults.filter(r => r.success).length}`);
            console.log(`  - æ‰§è¡Œå¤±è´¥: ${trace.executionResults.filter(r => !r.success).length}`);

            const errors = trace.executionResults.filter(r => !r.success);
            if (errors.length > 0) {
                console.log(`âŒ é”™è¯¯è¯¦æƒ…:`, errors);
            }

            showStatus('âœ… é”™è¯¯è¿½è¸ªæ¼”ç¤ºå®Œæˆï¼Œå¯ä»¥çœ‹åˆ°é”™è¯¯è¢«æ­£ç¡®æ•è·å’Œè®°å½•');
        });

        // æ€§èƒ½åˆ†ææ¼”ç¤º
        document.getElementById('demoPerformance').addEventListener('click', () => {
            console.log('\nâš¡ === æ€§èƒ½åˆ†ææ¼”ç¤º ===');

            // å¿«é€Ÿè®¢é˜…è€…
            demoEventBus.on('demo:perf:event', (data) => {
                // ç«‹å³è¿”å›
            });

            // æ…¢é€Ÿè®¢é˜…è€…
            demoEventBus.on('demo:perf:event', (data) => {
                // æ¨¡æ‹Ÿ50msçš„å¤„ç†æ—¶é—´
                const start = Date.now();
                while (Date.now() - start < 50) {
                    // å¿™ç­‰å¾…
                }
            });

            // ä¸­ç­‰é€Ÿåº¦è®¢é˜…è€…
            demoEventBus.on('demo:perf:event', (data) => {
                // æ¨¡æ‹Ÿ20msçš„å¤„ç†æ—¶é—´
                const start = Date.now();
                while (Date.now() - start < 20) {
                    // å¿™ç­‰å¾…
                }
            });

            // å‘å¸ƒå¤šä¸ªäº‹ä»¶è¿›è¡Œæ€§èƒ½æµ‹è¯•
            console.log('å‘å¸ƒ5ä¸ªæ€§èƒ½æµ‹è¯•äº‹ä»¶...');
            for (let i = 0; i < 5; i++) {
                demoEventBus.emit('demo:perf:event', {
                    iteration: i + 1,
                    timestamp: Date.now()
                });
            }

            // è·å–æ€§èƒ½ç»Ÿè®¡
            setTimeout(() => {
                const stats = demoEventBus.getStats('demo:perf:event');
                console.log(`ğŸ“Š æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š:`);
                console.log(`  - æ€»æ¶ˆæ¯æ•°: ${stats.totalMessages}`);
                console.log(`  - å¹³å‡æ‰§è¡Œæ—¶é—´: ${stats.averageExecutionTime.toFixed(2)}ms`);
                console.log(`  - æœ€å¤§æ‰§è¡Œæ—¶é—´: ${stats.maxExecutionTime}ms`);
                console.log(`  - æœ€å°æ‰§è¡Œæ—¶é—´: ${stats.minExecutionTime}ms`);
                console.log(`  - é”™è¯¯ç‡: ${(stats.errorRate * 100).toFixed(2)}%`);
                console.log(`  - æ€»æ‰§è¡Œæ¬¡æ•°: ${stats.totalExecutions}`);

                // è·å–è¿½è¸ªå™¨çŠ¶æ€
                const status = demoEventBus.getTracingStatus();
                console.log(`ğŸ“ˆ è¿½è¸ªå™¨çŠ¶æ€:`, status);
            }, 100);

            showStatus('âœ… æ€§èƒ½åˆ†ææ¼”ç¤ºå®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸­çš„è¯¦ç»†æ€§èƒ½æŠ¥å‘Š');
        });

        // åˆå§‹åŒ–æ¶ˆæ¯
        console.log('ğŸš€ EventBus æ¶ˆæ¯è¿½è¸ªåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•æˆ–æ¼”ç¤ºåŠŸèƒ½');
        console.log('');
    </script>
</body>
</html>