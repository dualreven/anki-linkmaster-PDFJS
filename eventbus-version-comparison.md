# EventBus ç‰ˆæœ¬å¯¹æ¯”åˆ†ææŠ¥å‘Š

## ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | event-bus.js (åŸç‰ˆ) | event-bus-with-tracing.js (è¿½è¸ªç‰ˆ) |
|------|-------------------|-----------------------------------|
| æ–‡ä»¶å¤§å° | 201è¡Œ | 534è¡Œ |
| åŸºç¡€åŠŸèƒ½ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| æ¶ˆæ¯è¿½è¸ª | âŒ æ—  | âœ… æœ‰ï¼ˆé»˜è®¤å…³é—­ï¼‰ |
| APIå…¼å®¹æ€§ | - | âœ… 100%å…¼å®¹åŸç‰ˆ |
| æ€§èƒ½å½±å“ | åŸºå‡† | è¿½è¸ªå…³é—­æ—¶ï¼šæ— å½±å“<br>è¿½è¸ªå¼€å¯æ—¶ï¼šçº¦5-10mså¼€é”€ |

## ğŸ” ä¸»è¦å·®å¼‚

### 1. **å¯¼å…¥ä¾èµ–ä¸åŒ**
```javascript
// åŸç‰ˆ
import Logger, { LogLevel } from "../utils/logger.js";

// è¿½è¸ªç‰ˆ
import { getLogger } from "../utils/logger.js";
import { MessageTracer } from "./message-tracer.js";
```

### 2. **å¯¼å‡ºå†…å®¹å·®å¼‚**
```javascript
// åŸç‰ˆå¯¼å‡º
export class EventBus { ... }
export default new EventBus({ enableValidation: true });

// è¿½è¸ªç‰ˆå¯¼å‡ºï¼ˆæ›´ä¸°å¯Œï¼‰
export class EventBus { ... }
export const setGlobalEventBusLogger = ...
export const setGlobalEventBusValidation = ...
export const getEventBus = ...
export const getAllEventBuses = ...
export default getEventBus("App", { enableValidation: true });
```

### 3. **è¿½è¸ªç‰ˆæ–°å¢åŠŸèƒ½**
- âœ… **EventBusManagerç±»** - å…¨å±€ç®¡ç†å¤šä¸ªEventBuså®ä¾‹
- âœ… **æ¶ˆæ¯è¿½è¸ª** - å¯é€‰çš„è°ƒç”¨é“¾è¿½è¸ª
- âœ… **æ€§èƒ½ç»Ÿè®¡** - getStats() æ–¹æ³•
- âœ… **åŠ¨æ€æ§åˆ¶** - setTracing() è¿è¡Œæ—¶å¼€å…³
- âœ… **è°ƒç”¨é“¾åˆ†æ** - getTraceTree() æ–¹æ³•

### 4. **é»˜è®¤å®ä¾‹åˆ›å»ºæ–¹å¼ä¸åŒ**
```javascript
// åŸç‰ˆï¼šç›´æ¥åˆ›å»ºå®ä¾‹
export default new EventBus({ enableValidation: true });

// è¿½è¸ªç‰ˆï¼šé€šè¿‡ç®¡ç†å™¨åˆ›å»ºï¼ˆæ”¯æŒå•ä¾‹ï¼‰
export default getEventBus("App", { enableValidation: true });
```

## âœ… å¯ä»¥å®‰å…¨æ›¿æ¢çš„åŸå› 

### 1. **å®Œå…¨å‘åå…¼å®¹**
- æ‰€æœ‰åŸç‰ˆAPIéƒ½ä¿ç•™
- è¿½è¸ªåŠŸèƒ½é»˜è®¤å…³é—­ï¼Œä¸å½±å“ç°æœ‰è¡Œä¸º
- emit()è¿”å›å€¼åœ¨ä¸å¼€è¿½è¸ªæ—¶ä¿æŒä¸€è‡´

### 2. **å¯¼å…¥å…¼å®¹æ€§**
```javascript
// è¿™ä¸¤ç§å¯¼å…¥æ–¹å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ
import eventBus from './event-bus.js';  // é»˜è®¤å¯¼å‡º
import { EventBus } from './event-bus.js';  // å‘½åå¯¼å‡º
```

### 3. **è¡Œä¸ºä¸€è‡´æ€§**
è¿½è¸ªç‰ˆåœ¨ `enableTracing: false` æ—¶ï¼š
- ä¸åˆ›å»ºMessageTracerå®ä¾‹
- ä¸ç”ŸæˆmessageId
- ä¸è®°å½•è¿½è¸ªæ•°æ®
- æ‰§è¡Œè·¯å¾„ä¸åŸç‰ˆå®Œå…¨ç›¸åŒ

## âš ï¸ éœ€è¦æ³¨æ„çš„ç»†å¾®å·®å¼‚

### 1. **Loggerå¯¼å…¥æ–¹å¼**
- åŸç‰ˆï¼š`import Logger` (ç±»)
- è¿½è¸ªç‰ˆï¼š`import { getLogger }` (å‡½æ•°)
- **å½±å“**ï¼šå¦‚æœæœ‰ä»£ç ç›´æ¥ä½¿ç”¨Loggerç±»ï¼Œéœ€è¦è°ƒæ•´

### 2. **é»˜è®¤å®ä¾‹æ˜¯å•ä¾‹**
- åŸç‰ˆï¼šæ¯æ¬¡å¯¼å…¥åˆ›å»ºæ–°å®ä¾‹
- è¿½è¸ªç‰ˆï¼šé€šè¿‡EventBusManagerè¿”å›åŒä¸€å®ä¾‹
- **å½±å“**ï¼šæ›´å¥½çš„å†…å­˜ç®¡ç†ï¼Œä½†è¡Œä¸ºç•¥æœ‰ä¸åŒ

### 3. **é¢å¤–çš„å¯¼å‡ºå‡½æ•°**
- è¿½è¸ªç‰ˆå¤šäº†4ä¸ªå·¥å…·å‡½æ•°
- **å½±å“**ï¼šä¸ä¼šå†²çªï¼Œåè€Œæä¾›æ›´å¤šåŠŸèƒ½

## ğŸ¯ æ›¿æ¢å»ºè®®

### âœ… **å¯ä»¥å®‰å…¨æ›¿æ¢**

æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```bash
# 1. å¤‡ä»½åŸæ–‡ä»¶
cp src/frontend/common/event/event-bus.js src/frontend/common/event/event-bus.backup.js

# 2. æ›¿æ¢æ–‡ä»¶
cp src/frontend/common/event/event-bus-with-tracing.js src/frontend/common/event/event-bus.js

# 3. éªŒè¯å¯¼å…¥
# æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ä½¿ç”¨ Logger ç±»çš„åœ°æ–¹
grep -r "new Logger" src/frontend/

# 4. è¿è¡Œæµ‹è¯•
npm test
```

### æ›¿æ¢åçš„å¥½å¤„
1. **ç»Ÿä¸€ä»£ç åº“** - å‡å°‘ç»´æŠ¤ä¸¤ä¸ªç‰ˆæœ¬çš„è´Ÿæ‹…
2. **æŒ‰éœ€è°ƒè¯•** - éœ€è¦æ—¶å¯éšæ—¶å¼€å¯è¿½è¸ª
3. **æ›´å¥½çš„åŠŸèƒ½** - EventBusManageræä¾›æ›´å¥½çš„ç®¡ç†
4. **æ— æ€§èƒ½æŸå¤±** - é»˜è®¤å…³é—­è¿½è¸ªï¼Œæ€§èƒ½ä¸å—å½±å“

## ğŸ“‹ æ›¿æ¢æ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½åŸå§‹ event-bus.js
- [ ] æ£€æŸ¥Loggerä½¿ç”¨æ–¹å¼
- [ ] æ›¿æ¢æ–‡ä»¶
- [ ] è¿è¡Œå•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•pdf-homeæ¨¡å—
- [ ] æµ‹è¯•pdf-vieweræ¨¡å—
- [ ] éªŒè¯WebSocketé€šä¿¡
- [ ] ç¡®è®¤æ—¥å¿—è¾“å‡ºæ­£å¸¸

## ç»“è®º

**å¯ä»¥å®‰å…¨åœ°ç”¨è¿½è¸ªç‰ˆæ›¿æ¢åŸç‰ˆ**ï¼Œå› ä¸ºï¼š
1. APIå®Œå…¨å…¼å®¹
2. é»˜è®¤è¡Œä¸ºä¸€è‡´
3. æ— æ€§èƒ½å½±å“ï¼ˆè¿½è¸ªé»˜è®¤å…³é—­ï¼‰
4. æä¾›æ›´å¤šè°ƒè¯•èƒ½åŠ›

å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯Loggerå¯¼å…¥æ–¹å¼çš„ç»†å¾®å·®åˆ«ã€‚