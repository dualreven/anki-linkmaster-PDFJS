var N=(e,i)=>()=>(i||e((i={exports:{}}).exports,i),i.exports);var $=N(I=>{(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))O(f);new MutationObserver(f=>{for(const w of f)if(w.type==="childList")for(const v of w.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&O(v)}).observe(document,{childList:!0,subtree:!0});function d(f){const w={};return f.integrity&&(w.integrity=f.integrity),f.referrerPolicy&&(w.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?w.credentials="include":f.crossOrigin==="anonymous"?w.credentials="omit":w.credentials="same-origin",w}function O(f){if(f.ep)return;f.ep=!0;const w=d(f);fetch(f.href,w)}})();Object.defineProperty(I,"__esModule",{value:!0});I.PDFViewerApp=void 0;var S=require("../common/event/event-bus.js"),a=V(require("../common/event/pdf-viewer-constants.js")),L=V(require("../common/utils/logger.js")),G=require("../common/error/error-handler.js"),R=require("./pdf-manager.js"),C=require("./ui-manager.js");require("../common/ws/ws-client.js");var z=require("../common/event/event-constants.js");function V(e){return e&&e.__esModule?e:{default:e}}function W(e,i){y(e,i),i.add(e)}function g(e,i,d){y(e,i),i.set(e,d)}function y(e,i){if(i.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function t(e,i){return e.get(r(e,i))}function h(e,i,d){return e.set(r(e,i),d),d}function r(e,i,d){if(typeof e=="function"?e===i:e.has(i))return arguments.length<3?i:d;throw new TypeError("Private element is not present on this object")}var c=new WeakMap,s=new WeakMap,P=new WeakMap,E=new WeakMap,l=new WeakMap,_=new WeakMap,A=new WeakMap,o=new WeakMap,u=new WeakMap,p=new WeakMap,m=new WeakMap,n=new WeakSet;class T{constructor(){W(this,n),g(this,c,void 0),g(this,s,void 0),g(this,P,void 0),g(this,E,void 0),g(this,l,void 0),g(this,_,!1),g(this,A,null),g(this,o,1),g(this,u,0),g(this,p,1),g(this,m,null),h(c,this,new L.default("PDFViewerApp")),h(s,this,new S.EventBus({enableValidation:!0,logLevel:L.default.LogLevel.DEBUG})),h(P,this,new G.ErrorHandler(t(s,this))),h(E,this,new R.PDFManager(t(s,this))),h(l,this,new C.UIManager(t(s,this))),t(c,this).info("PDFViewerApp instance created")}async initialize(){try{t(c,this).info("Initializing PDF Viewer App..."),r(n,this,Z).call(this),r(n,this,H).call(this),await t(E,this).initialize(),await t(l,this).initialize(),h(_,this,!0),t(c,this).info("PDF Viewer App initialized successfully."),t(s,this).emit(a.default.STATE.INITIALIZED,void 0,{actorId:"PDFViewerApp"})}catch(i){throw t(c,this).error("Application initialization failed.",i),t(P,this).handleError(i,"App.initialize"),i}}destroy(){t(c,this).info("Destroying PDF Viewer App..."),t(m,this)&&t(m,this).disconnect(),t(E,this).destroy(),t(l,this).destroy(),t(s,this).destroy(),t(c,this).info("PDF Viewer App destroyed."),t(s,this).emit(a.default.STATE.DESTROYED,void 0,{actorId:"PDFViewerApp"})}getState(){return{initialized:t(_,this),currentFile:t(A,this),currentPage:t(o,this),totalPages:t(u,this),zoomLevel:t(p,this)}}getEventBus(){return t(s,this)}loadPDFDocument(i){h(u,this,i.numPages),h(o,this,1)}handlePDFLoadError(i){t(P,this).handleError(i,"PDFLoad")}}I.PDFViewerApp=T;function Z(){window.addEventListener("unhandledrejection",e=>{t(c,this).error("Unhandled Promise Rejection:",e.reason),t(P,this).handleError(e.reason,"UnhandledPromiseRejection")}),window.addEventListener("error",e=>{t(c,this).error("Global Error:",e.error),t(P,this).handleError(e.error,"GlobalError")})}function H(){t(s,this).on(a.default.FILE.LOAD.REQUESTED,e=>{r(n,this,U).call(this,e)}),t(s,this).on(a.default.FILE.INFO_REQUESTED,e=>{}),t(s,this).on(z.WEBSOCKET_EVENTS.MESSAGE.RECEIVED,e=>{}),t(s,this).on(a.default.NAVIGATION.GOTO,e=>{r(n,this,q).call(this,e)}),t(s,this).on(a.default.NAVIGATION.PREVIOUS,()=>{r(n,this,b).call(this)}),t(s,this).on(a.default.NAVIGATION.NEXT,()=>{r(n,this,k).call(this)}),t(s,this).on(a.default.ZOOM.IN,()=>{r(n,this,j).call(this)}),t(s,this).on(a.default.ZOOM.OUT,()=>{r(n,this,B).call(this)}),t(s,this).on(a.default.ZOOM.FIT_WIDTH,()=>{r(n,this,Q).call(this)}),t(s,this).on(a.default.ZOOM.FIT_HEIGHT,()=>{r(n,this,x).call(this)}),t(s,this).on(a.default.ZOOM.ACTUAL_SIZE,()=>{r(n,this,K).call(this)}),t(s,this).on(a.default.ZOOM.CHANGED,e=>{r(n,this,Y).call(this,e)}),t(s,this).on(a.default.FILE.CLOSE,()=>{r(n,this,M).call(this)}),t(s,this).on(a.default.FILE.LOAD.PROGRESS,e=>{r(n,this,X).call(this,e)}),t(s,this).on(a.default.FILE.LOAD.RETRY,e=>{r(n,this,J).call(this,e)})}async function U(e){try{t(c,this).info("Handling file load request:",e),t(A,this)&&await r(n,this,M).call(this),t(l,this).showLoading(!0),t(l,this).updateProgress(0,"开始加载");const i=await t(E,this).loadPDF(e);h(A,this,e),h(u,this,i.numPages),t(l,this).hideProgress(),t(l,this).showLoading(!1),t(s,this).emit(a.default.FILE.LOAD.SUCCESS,{file:e,totalPages:t(u,this)},{actorId:"PDFViewerApp"}),t(s,this).emit(a.default.NAVIGATION.TOTAL_PAGES_UPDATED,t(u,this),{actorId:"PDFViewerApp"}),t(l,this).updatePageInfo(1,t(u,this)),await r(n,this,D).call(this,1)}catch(i){t(c,this).error("Failed to load PDF file:",i),t(l,this).hideProgress(),t(l,this).showLoading(!1),t(l,this).showError(i),t(s,this).emit(a.default.FILE.LOAD.FAILED,{error:i.message,file:e},{actorId:"PDFViewerApp"}),t(P,this).handleError(i,"PDFLoad")}}async function q(e){const i=parseInt(e.pageNumber);i>=1&&i<=t(u,this)&&(h(o,this,i),await r(n,this,D).call(this,i),t(s,this).emit(a.default.NAVIGATION.CHANGED,{currentPage:t(o,this),totalPages:t(u,this)},{actorId:"PDFViewerApp"}),t(l,this).updatePageInfo(t(o,this),t(u,this)))}async function b(){if(t(o,this)>1){var e;h(o,this,(e=t(o,this),e--,e)),await r(n,this,D).call(this,t(o,this)),t(s,this).emit(a.default.NAVIGATION.CHANGED,{currentPage:t(o,this),totalPages:t(u,this)},{actorId:"PDFViewerApp"}),t(l,this).updatePageInfo(t(o,this),t(u,this))}}async function k(){if(t(o,this)<t(u,this)){var e;h(o,this,(e=t(o,this),e++,e)),await r(n,this,D).call(this,t(o,this)),t(s,this).emit(a.default.NAVIGATION.CHANGED,{currentPage:t(o,this),totalPages:t(u,this)},{actorId:"PDFViewerApp"}),t(l,this).updatePageInfo(t(o,this),t(u,this))}}async function D(e){try{t(s,this).emit(a.default.RENDER.PAGE_REQUESTED,{pageNumber:e,totalPages:t(u,this)},{actorId:"PDFViewerApp"});const i=await t(E,this).getPage(e),d=i.getViewport({scale:t(p,this)});await t(l,this).renderPage(i,d),t(s,this).emit(a.default.RENDER.PAGE_COMPLETED,{pageNumber:e,viewport:d},{actorId:"PDFViewerApp"})}catch(i){t(c,this).error(`Failed to render page ${e}:`,i),t(s,this).emit(a.default.RENDER.PAGE_FAILED,{pageNumber:e,error:i.message},{actorId:"PDFViewerApp"}),t(P,this).handleError(i,"PageRender")}}function j(){h(p,this,Math.min(t(p,this)+.25,3)),r(n,this,F).call(this)}function B(){h(p,this,Math.max(t(p,this)-.25,.5)),r(n,this,F).call(this)}async function Q(){if(t(A,this)&&t(o,this)>0){const e=await t(E,this).getPage(t(o,this)),i=t(l,this).getContainerWidth(),d=e.getViewport({scale:1});h(p,this,i/d.width),r(n,this,F).call(this)}}async function x(){if(t(A,this)&&t(o,this)>0){const e=await t(E,this).getPage(t(o,this)),i=t(l,this).getContainerHeight(),d=e.getViewport({scale:1});h(p,this,i/d.height),r(n,this,F).call(this)}}function K(){h(p,this,1),r(n,this,F).call(this)}async function F(){t(A,this)&&t(o,this)>0&&(t(s,this).emit(a.default.ZOOM.CHANGED,{zoomLevel:t(p,this)},{actorId:"PDFViewerApp"}),t(l,this).setScale(t(p,this)),await r(n,this,D).call(this,t(o,this)))}function Y(e){e&&e.zoomLevel&&(h(p,this,e.zoomLevel),t(c,this).debug(`Zoom level changed to: ${t(p,this)}`))}function X(e){t(c,this).debug(`File load progress: ${e.percent}%`),t(l,this).updateProgress(e.percent,"加载中")}async function J(e){t(c,this).info("Retrying file load:",e),t(l,this).hideError(),t(s,this).emit(a.default.FILE.LOAD.REQUESTED,e,{actorId:"PDFViewerApp"})}async function M(){t(c,this).info("Closing current PDF file"),t(E,this).cleanup(),t(l,this).cleanup(),h(A,this,null),h(o,this,1),h(u,this,0),h(p,this,1),t(s,this).emit(a.default.STATE.LOADING,!1,{actorId:"PDFViewerApp"})}document.addEventListener("DOMContentLoaded",async()=>{const e=new T,i=new L.default("pdf-viewer/main.js");try{await e.initialize(),window.pdfViewerApp={getState:()=>e.getState(),destroy:()=>e.destroy(),_internal:e},i.info("PDF Viewer App started. Use window.pdfViewerApp.getState() for status.")}catch(d){i.error("Failed to start PDF Viewer App:",d)}})});export default $();
