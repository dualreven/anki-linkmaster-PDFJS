---
基本规则:
   - 总是使用中文回复.
   - 询问用户时,请在控制台打印 `[Console]::Beep(1440, 500)` 提醒我来看

项目技术栈和开发工具:
   - 前端构建工具: Vite 5.0.0 (开发服务器 + 构建工具)
   - 前端框架: 原生JavaScript (支持ES6+ 语法)
   - 核心依赖: 
        * PDF.js 3.4.120 (PDF处理和渲染)
        * Tabulator Tables 5.4.4 (表格组件)
   - 开发工具:
        * Babel 7.28.3 (ES6+ 转译)
        * Jest 30.1.1 (单元测试)
        * ESLint 9.34.0 (代码检查)
        * TypeScript ESLint 8.41.0 (TypeScript 支持)
   - 构建配置:
        * Vite 配置支持 CommonJS 模块 (PDF.js 兼容)
        * Babel 配置支持私有类方法和属性
        * Jest 配置支持 jsdom 测试环境
   - 项目启动方式 (重要!):
        ⚠️ 严禁直接运行 npm run dev 或 python app.py 等命令!
        必须使用 ai-launcher.ps1 脚本来管理项目启动和停止:
        
        启动所有服务: .\ai-launcher.ps1 start
        检查服务状态: .\ai-launcher.ps1 status  
        查看运行日志: .\ai-launcher.ps1 logs
        停止所有服务: .\ai-launcher.ps1 stop
        
        项目包含的服务:
        - npm-dev server (端口 3000): 前端开发服务器
        - debug.py (端口 9222): Python 调试控制台
        - app.py: 主应用程序 (包含 WebSocket 服务器端口 8765)
        
        开发命令 (仅用于特殊情况的手动调试):
        * npm run dev: 启动开发服务器 (端口3000，根目录为 src/frontend/pdf-home)
        * npm run build: 构建生产版本 (输出到 src/frontend/pdf-home/dist)
        * npm run test: 运行测试套件 (Jest + jsdom 环境)
        * npm run preview: 预览构建结果

文件修改时的注意事项: 
   必须遵守和阅读开发规范: 每当你要修改一个模块时,你必须先阅读这个模块的开发规范, 通常他保存在 [模块名]/docs/SPEC 下面, 特别注意有个头文件 [模块名]/docs/SPEC/SPEC-HEAD-[模块名].yml 他记录了所有引用的规范, 必须先阅读规范, 然后遵守规范来修改和测试代码.
   与用户商量你的修改计划: 每次开始修改代码的任务前, 你必须先和用户商议讨论你的计划.
   修改前提交git创建分支: 通过用户的许可后, 先git commit, 然后创建分支, 保存快照, 然后再进行修改
   失败回滚git: 如果修改导致更恶劣的情况发生,应当立即退回修改
   成功提交git合并分支: 修改通过后, 通过用户的认可再commit, 再合并分支到来时的分支

开发工具和测试规范:
   代码质量检查: 修改完成后必须运行 `npm run test` 确保所有测试通过
   ESLint 检查: 代码必须通过 ESLint 检查，遵循项目代码规范
   Babel 转译支持: 项目支持 ES6+ 语法，包括私有类方法和属性
   模块导入规范: 使用 ES6 模块导入语法，但注意 PDF.js 等 CommonJS 模块的兼容性处理
   测试覆盖率: 新功能必须编写对应的单元测试，确保代码质量

debug代码时的注意事项:
   debug的逆向思维: 从与用户使用行为最近的代码开始检查bug, 比如表格渲染不正常, 则直接看表格渲染的问题, 确定表格渲染的正确性, 如果正常, 再回推别的问题. 

本项目的前后端通信原理（添加/删除）:
   概述: 本项目的添加/删除功能基于事件驱动与异步消息传递：UI 发出用户意图 → 本地事件总线分发 → 管理器组装并发送消息到后端 → 后端执行并返回结果/广播 → 前端接收并更新 UI。
   核心原则（高层）:
      - 明确责任链：UI 负责收集用户意图并触发本地事件；管理层负责把事件转为可靠的对外消息；网络层负责实际传输并报告传输结果；后端负责执行并在变更后广播状态更新。
      - 可追溯性：每次交互应带可追溯 metadata（调用者标识、唯一请求 id 或 trace token），便于从 UI 一端追溯到后端处理结果并排查问题。
      - 幂等与确认：对可能被重复发出的操作（删除、添加确认）设计为幂等或通过唯一请求 id 实现幂等保证；仅在收到明确成功确认后再更新关键本地状态或以广播结果为准。
      - 防御性更新：后端响应可能为空或为局部信息，前端不应盲目用空数组覆盖本地列表；遇到模糊响应时应主动拉取完整列表以重建一致性。
      - 向后兼容：在迁移期间前端应同时提交可辨识资源的多种标识（例如唯一 id 与可读名称），后端以唯一 id 为优先处理依据并兼容名称匹配作为回退。

   添加功能的典型底层流程（概念）:
      - 步骤：UI 请求文件选择或上传 → 前端通过事件触发管理器发送"请求选择/上传"的消息 → 后端（或本地托管进程）弹出选择器或接收上传并持久化 → 后端返回添加结果与摘要 → 管理器收到结果并触发本地列表刷新或广播。
      - 要点：添加常常是多步的（交互式选择 + 后端确认），需要 request_id/summary 来表明实际被添加的数量与失败项；若添加成功，应触发完整列表刷新或广播以保持视图一致。

   删除功能的典型底层流程（概念）:
      - 步骤：UI 发起删除（携带资源标识）→ 本地事件总线转发到管理器 → 管理器构建删除消息并通过网络发送到后端 → 后端执行删除并返回确认/失败详情 → 后端通常会广播更新后的列表或管理器在确认后请求完整列表。
      - 要点：删除应以唯一标识为主（id），但为兼容性可同时提交名称作为回退；删除必须有明确确认（成功/失败），前端在收到成功后再更新本地视图或等待后端广播。

代码工程化思想:
   传入变量应无外部副作用: 函数接受的参数应当是不可变的, 该变量作为副本传入, 外部修改该变量不会影响其在函数内部的状态.
   必须写注释: 不管是js还是py,编写任何函数都要先写文档,描述用法和输入输出.
   ES6+ 最佳实践: 使用 const/let 替代 var，使用箭头函数、解构赋值、模板字符串等现代语法
   异步编程: 使用 async/await 处理异步操作，避免回调地狱
   错误处理: 使用 try-catch 捕获异常，提供有意义的错误信息
   模块化: 合理组织代码结构，避免全局变量污染
   性能优化: 注意大文件的分块加载，避免阻塞主线程

AI 接管开发时的具体规则:

   1. 开发前的准备工作:
      - 必须先阅读要修改模块的 SPEC 文档，通常在 `[模块名]/docs/SPEC/` 目录下
      - 查看模块的结构图和接口文档，了解模块的职责和边界
      - 使用 `.\ai-launcher.ps1 status` 检查项目服务状态
      - 使用 `npm run test` 确保当前代码库状态正常
      - 使用 `git status` 查看当前工作目录状态，清理无关文件
      - ⚠️ 严禁直接运行 npm run dev 或 python app.py 等命令，必须使用 ai-launcher.ps1

   2. 任务规划和执行:
      - 使用 TodoWrite 工具创建具体的任务清单，每个任务都要有明确的完成标准
      - 按优先级排序：先修复阻塞问题，再实现新功能，最后优化
      - 每个任务都要有对应的测试计划，包括单元测试和集成测试
      - 复杂任务要分解为不超过30分钟的小任务

   3. 代码编写具体要求:
      - JavaScript 文件必须使用 ES6+ 语法，优先使用 const 和 let
      - 类的私有方法必须使用 # 前缀，私有属性使用 _ 前缀
      - 所有函数必须有 JSDoc 注释，说明参数、返回值和用途
      - 异步操作必须使用 async/await，并提供错误处理
      - 事件处理函数必须使用具名函数，便于调试
      - 禁止使用全局变量，所有数据都必须封装在类或模块中

   4. 测试和质量检查:
      - 修改代码后立即运行 `npm run test` 验证功能
      - 新功能必须编写对应的 Jest 测试用例
      - 测试覆盖率不能低于 80%
      - 使用 `node eslint.config.js` 或 `eslint` 检查代码风格，修复所有警告
      - 重要功能必须手动测试，包括边界情况和异常处理

   5. 版本控制操作流程:
      - 开始任务前：`git add . && git commit -m "snapshot before [任务描述]"`
      - 创建分支：`git checkout -b feature/[任务名称]`
      - 开发过程中：定期提交，每次提交都是一个完整的小功能
      - 完成后：`git push origin feature/[任务名称]` 并请求合并

   6. PDF.js 相关的特殊要求:
      - 使用 PDF.js 时必须处理加载状态和错误状态
      - PDF 渲染完成后必须清理资源，避免内存泄漏
      - 大文件必须分块加载，提供进度显示
      - PDF 操作必须有超时处理，避免长时间等待

   7. 表格组件 (Tabulator) 的使用规范:
      - 表格数据必须使用响应式设计，支持动态更新
      - 表格操作（增删改）必须有确认对话框
      - 大数据量表格必须实现虚拟滚动
      - 表格导出功能必须支持多种格式（CSV、Excel、PDF）

   8. WebSocket 通信规范:
      - WebSocket 连接必须自动重连机制
      - 消息发送必须有唯一 ID，用于匹配响应
      - 网络断开时必须有本地状态保存
      - 消息队列必须有防重复机制

   9. 调试和问题排查:
      - 使用 console.log 调试时必须包含明确的标识
      - 错误信息必须包含上下文，便于定位问题
      - 使用浏览器开发者工具检查性能和内存使用
      - 重要操作必须有日志记录，便于事后分析

   10. 文档和注释要求:
      - 所有新功能必须更新对应的文档
      - API 接口必须有详细的参数说明
      - 复杂逻辑必须有流程图或时序图
      - 配置项必须有默认值和取值范围说明

   11. 项目架构特点:
      - 前端根目录为 `src/frontend/pdf-home`，不是项目根目录
      - 后端使用 Python，位于 `src/backend/` 目录
      - 前后端通过 WebSocket 通信，有完整的消息协议
      - 使用事件总线架构，各模块通过事件解耦
      - 有完整的错误处理和日志记录系统

   12. 特殊文件和配置:
      - ESLint 使用现代配置格式 (`eslint.config.js`)
      - Jest 有专门的设置文件 (`jest.setup.js`)
      - Vite 配置了 CommonJS 支持以兼容 PDF.js
      - Babel 配置了测试环境的特殊处理
      - 项目使用 `.kilocode/` 目录进行 AI 开发配置

   13. 重要提醒 - 项目启动方式:
      - ⚠️ 必须使用 ai-launcher.ps1 脚本来管理项目启动和停止
      - 严禁直接运行 npm run dev 或 python app.py 等命令
      - 开发前：使用 `.\ai-launcher.ps1 start` 启动所有服务
      - 开发中：使用 `.\ai-launcher.ps1 status` 检查服务状态
      - 查看日志：使用 `.\ai-launcher.ps1 logs` 监控运行情况
      - 开发后：使用 `.\ai-launcher.ps1 stop` 停止所有服务
      - 原因：直接启动会导致终端阻塞，无法进行 AI 自动化开发