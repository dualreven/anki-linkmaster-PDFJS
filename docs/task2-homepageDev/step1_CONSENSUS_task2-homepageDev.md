# Anki LinkMaster PDFJS - task2-homepageDev 共识确认文档

## 1. 明确的需求描述和验收标准

### 需求描述
修复PDF主页的功能缺陷，确保能够正常地展示和管理PDF文件，重点解决无法导入PDF文件的问题。具体包括：

1. **PDF文件导入功能**：确保用户能够通过文件选择器选择本地PDF文件，并成功导入到应用程序中。
2. **PDF文件列表展示**：确保导入的PDF文件能够在页面上正确展示，并显示文件名称、大小等基本信息。
3. **PDF文件操作功能**：确保用户能够对PDF文件进行打开和删除操作。
4. **前后端通信**：确保前端与后端之间的WebSocket通信正常，能够正确处理各类消息。

### 验收标准
1. **功能测试**：
   - 用户可以通过文件选择器选择本地PDF文件
   - 选择文件后，文件能够成功添加到PDF列表中
   - PDF列表能够正确显示所有已添加的PDF文件
   - 用户可以点击删除按钮，从列表中移除PDF文件
   - 所有操作都能正常工作，无明显错误

2. **性能测试**：
   - PDF文件导入速度快，无明显卡顿
   - 列表刷新及时，响应迅速
   - WebSocket消息处理效率高，无明显延迟

3. **错误处理**：
   - 对于无效的PDF文件，能够给出明确的错误提示
   - 对于无法打开或删除的文件，能够给出相应的错误提示
   - 对于网络连接问题，能够给出相应的提示

## 2. 技术实现方案和技术约束

### 技术实现方案

1. **后端实现**：
   - 在 `AnkiLinkMasterApp` 类中，添加 `setup_websocket_handlers` 方法，连接 `websocket_server.message_received` 信号到消息处理函数
   - 实现 `handle_websocket_message` 方法，根据消息类型调用相应的处理函数
   - 实现 `handle_add_pdf`、`handle_get_pdf_list`、`handle_remove_pdf` 等方法，处理具体的PDF操作请求
   - 使用 `PDFManager` 类的方法完成实际的PDF操作
   - 通过 WebSocket 将操作结果返回给前端

2. **前端实现**：
   - 修复 `main.js` 中的 `removePDF` 方法，避免递归调用
   - 确保 `handleFileSelect` 方法能够正确处理浏览器环境下的文件路径
   - 优化PDF列表的渲染和更新逻辑
   - 完善错误处理和用户反馈机制

### 技术约束

1. **Python版本**：使用 Python 3.9+ 开发
2. **PyQt版本**：使用 PyQt6 框架
3. **前端技术**：使用 HTML5、CSS3 和 JavaScript 开发
4. **构建工具**：使用 Vite 构建前端项目
5. **通信协议**：使用 WebSocket 进行前后端实时通信
6. **浏览器兼容性**：确保在主流浏览器（Chrome、Firefox、Safari、Edge）上正常运行

## 3. 集成方案

1. **消息格式定义**：
   - 定义统一的消息格式，包括消息类型、操作数据和唯一标识符
   - 消息类型包括：`add_pdf`、`get_pdf_list`、`remove_pdf`、`error` 等

2. **后端集成**：
   - 在 `AnkiLinkMasterApp.run()` 方法中，添加对 `setup_websocket_handlers` 方法的调用
   - 确保 `PDFManager` 和 `WebSocketServer` 能够正确交互
   - 实现统一的错误处理机制，向上层传递错误信息

3. **前端集成**：
   - 确保 `PDFHomeManager` 类能够正确处理各种类型的 WebSocket 消息
   - 实现对PDF列表的动态更新
   - 完善用户交互界面，提供清晰的操作反馈

## 4. 任务边界限制

1. **时间限制**：
   - 代码修改和测试应在指定的时间范围内完成
   - 如有特殊情况，应及时与相关人员沟通

2. **资源限制**：
   - 仅使用项目中已有的技术和库，不引入新的依赖
   - 确保代码修改不会对现有功能造成负面影响

3. **范围限制**：
   - 仅修复PDF主页的功能缺陷，不涉及其他页面或功能
   - 不涉及PDF内容查看器的实现细节
   - 不涉及用户认证和权限管理
   - 不涉及PDF文件内容解析和提取功能

## 5. 不确定性解决方案

1. **文件上传机制**：
   - 在浏览器环境中，由于安全限制，无法直接获取文件的完整本地路径
   - 解决方案：前端将文件名称发送给后端，后端根据文件名称在指定目录中查找文件，或者前端使用 FileReader API 读取文件内容并发送给后端

2. **消息处理逻辑**：
   - 解决方案：在 `AnkiLinkMasterApp` 类中实现完整的消息处理逻辑，将 WebSocket 消息与 PDF 管理器的操作连接起来

3. **错误处理流程**：
   - 解决方案：定义统一的错误消息格式，前端根据错误类型显示相应的提示信息

4. **文件存储策略**：
   - 解决方案：根据 `PDFManager` 类的实现，使用用户选择的文件路径，或者在必要时复制到应用程序指定目录

## 6. 质量保证措施

1. **代码审查**：
   - 对所有修改的代码进行审查，确保代码质量和风格一致
   - 确保代码修改符合项目的整体架构和设计理念

2. **测试**：
   - 对修复的功能进行全面测试，包括正常操作和异常情况
   - 确保所有功能都能按照预期工作

3. **文档更新**：
   - 及时更新相关文档，确保文档与代码实现一致
   - 提供清晰的使用说明和API文档

通过以上措施，我们可以确保修复的功能能够正常工作，并且不会对现有功能造成负面影响。同时，我们也能够确保项目的代码质量和文档完整性。