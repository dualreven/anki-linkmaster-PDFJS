# 前端测试规范

## 概述
本项目前端基于vite + app.py + debug.py架构，利用热更新特性进行测试，通过debug-console-at-[端口号].log监控测试结果。

## 测试环境

### 技术栈
- **构建工具**：vite（支持热模块替换）
- **后端服务**：app.py（已自动启动）
- **调试工具**：debug.py（提供debug-console-at-[端口号].log）
- **监控方式**：实时查看debug-console-at-[端口号].log文件

### 环境状态
- vite dev server：通常已启动，无需AI操作
- app.py：后端服务已运行
- debug.py：调试工具已可用
- WebSocket：已建立连接

## 测试方法

### 1. 基于热更新的测试
**原理**：修改HTML/JS文件后，vite自动刷新页面
**步骤**：
1. 修改前端代码
2. 保存文件触发vite热更新
3. 观察debug-console-at-[端口号].log中的测试输出
4. 根据日志调整代码

### 2. 测试模块注入
**规范**：
- 测试模块统一放在 `src/frontend/test-modules/` 目录
- 文件名格式：`test-[功能]-[日期].js`
- 必须包含清理函数，避免副作用

**示例**：
```javascript
// 在页面中注入测试
const script = document.createElement('script');
script.type = 'module';
script.textContent = `
    import { runTest } from '/src/frontend/test-modules/test-feature.js';
    runTest();
`;
document.body.appendChild(script);
```

### 3. 控制台调试
**日志规范**：
- 所有测试输出使用 `[TEST]` 前缀
- 格式：`[TEST] [功能] [状态] [详情]`
- 实时监控：通过debug-console-at-[端口号].log查看

**示例输出**：
```
[19:26:15.684][LOG] [TEST] PDF主页测试开始
[19:26:16.103][LOG] [TEST] 测试完成: 4/4 通过
```

## 测试流程

### 1. 测试前检查
```javascript
// 检查环境状态
const checkEnv = () => ({
    viteReady: !!window.__vite_plugin_react_preamble_installed__,
    wsConnected: window.wsClient?.isConnected() || false,
    domReady: document.readyState === 'complete'
});
```

### 2. 功能测试
```javascript
// 测试PDF列表加载
export function testPDFList() {
    console.log('[TEST] 开始PDF列表测试');
    
    // 触发加载
    window.eventBus.emit('pdf:management:list_requested');
    
    // 监听结果
    window.eventBus.once('pdf:management:list_updated', (data) => {
        console.log('[TEST] PDF列表加载成功:', data.files.length);
    });
}
```

### 3. 清理工作
**必须执行**：
- 删除测试添加的DOM元素
- 移除测试注册的事件监听
- 清理测试产生的全局变量

## 测试工具

### 1. 环境检查工具
```javascript
// 快速环境检查
export function checkFrontendEnv() {
    return {
        timestamp: new Date().toISOString(),
        vite: !!window.__vite_plugin_react_preamble_installed__,
        eventBus: !!window.eventBus,
        ws: window.wsClient?.isConnected() || false,
        debug: true // debug-console-at-[端口号].log始终可用
    };
}
```

### 2. 测试模块模板
**位置**：`src/frontend/test-modules/test-[功能]-[日期].js`
**必需函数**：
- `runTest()` - 主测试函数
- `cleanup()` - 清理函数

## 调试指南

### 1. 查看测试输出
- 文件：`debug-console-at-[端口号].log`
- 搜索：`[TEST]` 前缀快速定位测试日志
- 实时监控：`tail -f debug-console-at-[端口号].log`

### 2. 常见问题
- **热更新失败**：检查vite配置
- **WebSocket断开**：查看网络状态
- **测试无输出**：确认debug-console-at-[端口号].log是否正常写入

### 3. 测试验证
```javascript
// 验证测试执行
const verifyTest = () => {
    const logs = document.querySelectorAll('.console-log');
    const testLogs = Array.from(logs).filter(log => 
        log.textContent.includes('[TEST]')
    );
    return testLogs.length > 0;
};
```

## 使用示例

### 完整测试流程
```javascript
// 1. 创建测试模块
createTestModule('pdf-home', () => {
    console.log('[TEST] PDF主页功能测试');
    // 测试代码
});

// 2. 注入测试
import('/src/frontend/test-modules/test-pdf-home.js').then(m => {
    m.runTest();
});

// 3. 查看结果
cat debug-console-at-[端口号].log | grep "[TEST]"
```