# PDF-Home模块重构需求理解文档

## 项目背景分析

### 当前实现状态
基于对现有代码的分析，当前pdf-home模块已实现为单文件原型（v1版本），文件路径：`src/frontend/pdf-home/index.js`（1275行）。

### 现有架构特征
- **单文件架构**：所有功能集中在一个1275行的JavaScript文件中
- **类继承模式**：使用ES6类继承（EventBus, Logger, ErrorHandler, WebSocketManager, PDFManager, UIManager, PDFHomeApp）
- **同步加载**：在DOMContentLoaded事件中直接实例化应用类
- **紧耦合**：各组件通过直接实例化和方法调用相互依赖

### 核心功能实现现状

#### 1. 事件系统（类EventBus）
- **实现位置**：index.js 1-80行
- **功能**：事件发布/订阅机制
- **问题**：作为类被实例化，与业务逻辑耦合

#### 2. 日志系统（类Logger）
- **实现位置**：index.js 82-200行
- **功能**：分级日志输出，模拟文件写入
- **问题**：每个模块独立创建Logger实例，配置分散

#### 3. 错误处理（类ErrorHandler + AppError）
- **实现位置**：index.js 202-300行
- **功能**：错误分类、统一处理、用户友好提示
- **问题**：与事件总线紧密耦合

#### 4. WebSocket通信（类WebSocketManager）
- **实现位置**：index.js 302-500行
- **功能**：连接管理、消息队列、重连机制
- **问题**：与事件总线直接耦合，URL硬编码

#### 5. PDF文件管理（类PDFManager）
- **实现位置**：index.js 502-750行
- **功能**：文件列表管理、CRUD操作、数据映射
- **问题**：与WebSocketManager直接依赖

#### 6. UI管理（类UIManager）
- **实现位置**：index.js 752-1200行
- **功能**：DOM操作、事件绑定、状态渲染
- **问题**：直接操作DOM，与业务逻辑混合

#### 7. 主应用类（类PDFHomeApp）
- **实现位置**：index.js 1202-1275行
- **功能**：组件初始化、全局错误处理
- **问题**：承担过多职责，成为上帝对象

## 需求边界确认

### 明确包含的重构范围
1. **架构重构**：从类继承改为组合模式
2. **加载机制**：从同步加载改为事件驱动异步加载
3. **模块分离**：将单文件拆分为独立模块文件
4. **职责分离**：清晰分离业务逻辑、UI逻辑、环境设置
5. **测试驱动**：为每个模块添加单元测试

### 明确排除的重构范围
1. **后端API**：保持现有WebSocket接口不变
2. **UI设计**：保持现有视觉设计和交互流程
3. **功能特性**：不添加新功能，仅重构现有功能
4. **技术栈**：继续使用原生JavaScript，不引入框架
5. **构建系统**：继续使用Vite构建系统

### 技术约束确认
- **QtWebEngine兼容性**：必须适配异步加载特性
- **API兼容性**：保持现有WebSocket消息格式
- **文件结构**：遵循已定义的版本目录规范
- **性能要求**：重构后性能不低于现有水平

## 需求理解

### 业务需求理解
基于现有代码分析，pdf-home模块的核心业务需求是：

1. **PDF文件管理**：提供PDF文件的添加、删除、列表展示功能
2. **实时通信**：通过WebSocket与后端保持实时数据同步
3. **用户交互**：提供直观的文件操作界面
4. **状态管理**：维护文件列表状态和用户操作状态
5. **错误处理**：友好的错误提示和恢复机制

### 技术需求理解

#### 1. 架构层面
- **从继承到组合**：将现有的类继承关系改为对象组合
- **从同步到异步**：适配QtWebEngine的异步加载特性
- **从集中到分散**：将单文件拆分为多个职责单一的模块

#### 2. 模块层面
- **事件驱动**：所有模块通过事件总线通信
- **依赖注入**：通过构造函数注入依赖，而非直接创建
- **接口抽象**：定义清晰的模块接口契约

#### 3. 测试层面
- **可测试性**：每个模块可独立测试
- **mock支持**：提供mock机制便于测试
- **覆盖率**：测试覆盖率>80%

## 疑问澄清

### 需要确认的关键决策点

#### 1. 模块粒度
**问题**：模块应该拆分到什么粒度？
- 选项A：按功能类型（事件、日志、网络、业务、UI）
- 选项B：按业务领域（PDF管理、WebSocket通信、界面渲染）
- 选项C：更细粒度（每个类一个文件）

#### 2. 状态管理策略
**问题**：如何处理模块间的状态共享？
- 选项A：继续事件驱动（当前方式）
- 选项B：引入轻量级状态容器
- 选项C：通过依赖注入共享状态

#### 3. 错误边界
**问题**：错误应该在哪个层级处理？
- 选项A：全局统一处理（当前方式）
- 选项B：模块内部处理
- 选项C：分层处理（模块+全局）

#### 4. 配置管理
**问题**：配置信息如何管理？
- 选项A：每个模块独立配置（当前方式）
- 选项B：集中配置对象
- 选项C：环境变量+配置文件

#### 5. 模块通信协议
**问题**：事件命名和payload格式是否需要标准化？
- 选项A：保持现有格式
- 选项B：制定更严格的规范
- 选项C：使用类型定义

### 技术实现疑问

#### 1. 异步加载实现
**问题**：如何确保QtWebEngine异步加载兼容性？
- 是否需要特定的加载顺序？
- 如何处理模块间的加载依赖？
- 是否需要提供降级方案？

#### 2. 热重载支持
**问题**：重构后如何支持开发时的热重载？
- 模块状态如何保持？
- 事件监听器如何清理？
- 如何避免内存泄漏？

#### 3. 版本迁移策略
**问题**：如何平滑迁移到新架构？
- 是否需要保留并行版本？
- 如何验证功能一致性？
- 回滚机制如何设计？

## 项目特性规范

### 功能特性清单
基于代码分析，当前已实现的功能特性：

#### 核心功能
- [x] PDF文件列表展示（支持分页、排序、搜索）
- [x] PDF文件添加（通过WebSocket触发文件选择）
- [x] PDF文件删除（支持批量删除）
- [x] PDF文件打开（支持本地文件和viewer打开）

#### 交互功能
- [x] 键盘快捷键（Ctrl+D调试面板，Ctrl+N添加文件）
- [x] 批量操作（全选、批量删除）
- [x] 实时状态显示（WebSocket连接状态、加载状态）
- [x] 用户友好的错误提示

#### 技术功能
- [x] WebSocket自动重连（最多5次，指数退避）
- [x] 消息队列（离线消息缓存）
- [x] 详细日志系统（debug/info/warn/error级别）
- [x] 全局错误处理（Promise rejection、全局错误）

#### 数据功能
- [x] 后端数据映射（统一数据格式）
- [x] 文件元数据展示（大小、日期、页数等）
- [x] 重要性标记（high/medium/low）
- [x] 统计信息（注释数、卡片数）

### 非功能特性
- [x] 性能：首次加载时间<2秒（当前单文件1275行）
- [x] 响应性：事件响应延迟<100ms
- [x] 可维护性：代码结构清晰，有详细注释
- [x] 可调试性：debug面板、详细日志、全局调试对象

### 待重构特性
- [ ] 架构：从类继承改为组合模式
- [ ] 加载：从同步改为异步事件驱动
- [ ] 模块：从单文件改为多文件模块
- [ ] 测试：从无测试改为TDD开发
- [ ] 依赖：从紧耦合改为松耦合