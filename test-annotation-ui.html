<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‡æ³¨UIæµ‹è¯• - Annotation UI Test</title>
  <link rel="stylesheet" href="src/frontend/pdf-viewer/features/annotation/components/annotation-sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      overflow: hidden;
    }

    main {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #fff;
    }

    .viewer-placeholder {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #999;
      transition: left 0.3s;
    }

    .viewer-placeholder.sidebar-open {
      left: 350px;
    }

    .viewer-placeholder h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }

    .test-controls {
      position: fixed;
      right: 20px;
      top: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10000;
      max-width: 300px;
    }

    .test-controls h3 {
      margin-bottom: 12px;
      font-size: 14px;
      color: #333;
    }

    .test-controls button {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .test-controls button:hover {
      background: #f5f5f5;
      border-color: #bbb;
    }

    .test-controls button:active {
      background: #e0e0e0;
    }

    .test-controls .info {
      font-size: 12px;
      color: #666;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    .test-controls .status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .test-controls .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .test-controls .status-indicator.off {
      background: #999;
    }
  </style>
</head>
<body>
  <main id="main-container">
    <div class="viewer-placeholder" id="viewer-placeholder">
      <h1>ğŸ“ æ ‡æ³¨åŠŸèƒ½UIæµ‹è¯•</h1>
      <p>ä½¿ç”¨å³ä¾§æ§åˆ¶é¢æ¿æµ‹è¯•æ ‡æ³¨ä¾§è¾¹æ </p>
    </div>
  </main>

  <div class="test-controls">
    <h3>ğŸ§ª æµ‹è¯•æ§åˆ¶é¢æ¿</h3>

    <div class="status">
      <div class="status-indicator off" id="sidebar-indicator"></div>
      <span>ä¾§è¾¹æ çŠ¶æ€: <span id="sidebar-status">å…³é—­</span></span>
    </div>

    <button onclick="testToggleSidebar()">åˆ‡æ¢ä¾§è¾¹æ </button>
    <button onclick="testAddScreenshot()">æ·»åŠ æˆªå›¾æ ‡æ³¨</button>
    <button onclick="testAddTextHighlight()">æ·»åŠ é€‰å­—æ ‡æ³¨</button>
    <button onclick="testAddComment()">æ·»åŠ æ‰¹æ³¨æ ‡æ³¨</button>
    <button onclick="testClearAll()">æ¸…ç©ºæ‰€æœ‰æ ‡æ³¨</button>
    <button onclick="testBatch()">æ‰¹é‡æ·»åŠ ï¼ˆ10ä¸ªï¼‰</button>

    <div class="info">
      <strong>å·²å®ç°åŠŸèƒ½ï¼š</strong><br>
      âœ… ä¾§è¾¹æ UI<br>
      âœ… å·¥å…·æŒ‰é’®<br>
      âœ… æ ‡æ³¨å¡ç‰‡<br>
      âœ… æ•°æ®æ¨¡å‹<br>
      <br>
      <strong>å¾…å®ç°ï¼š</strong><br>
      â³ å·¥å…·äº¤äº’é€»è¾‘<br>
      â³ æ ‡æ³¨ç®¡ç†å™¨<br>
      â³ PDFæ¸²æŸ“é›†æˆ
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥ä¾èµ–
    import { EventBus } from './src/frontend/common/event/event-bus.js';
    import { PDF_VIEWER_EVENTS } from './src/frontend/common/event/pdf-viewer-constants.js';
    import { AnnotationSidebarUI } from './src/frontend/pdf-viewer/features/annotation/components/annotation-sidebar-ui.js';
    import { Annotation, AnnotationType, HighlightColor } from './src/frontend/pdf-viewer/features/annotation/models/annotation.js';

    // åˆå§‹åŒ–EventBus
    const eventBus = new EventBus();
    window.eventBus = eventBus; // ä¾¿äºè°ƒè¯•

    // åˆå§‹åŒ–ä¾§è¾¹æ UI
    const sidebarUI = new AnnotationSidebarUI(eventBus, {
      container: document.getElementById('main-container')
    });
    sidebarUI.initialize();
    window.sidebarUI = sidebarUI; // ä¾¿äºè°ƒè¯•

    // å­˜å‚¨æ ‡æ³¨
    let annotations = [];
    window.annotations = annotations;

    // ç›‘å¬ä¾§è¾¹æ çŠ¶æ€å˜åŒ–
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.OPENED, () => {
      document.getElementById('sidebar-status').textContent = 'æ‰“å¼€';
      document.getElementById('sidebar-indicator').classList.remove('off');
      document.getElementById('viewer-placeholder').classList.add('sidebar-open');
    });

    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.CLOSED, () => {
      document.getElementById('sidebar-status').textContent = 'å…³é—­';
      document.getElementById('sidebar-indicator').classList.add('off');
      document.getElementById('viewer-placeholder').classList.remove('sidebar-open');
    });

    // ç›‘å¬å·¥å…·æ¿€æ´»
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.TOOL.ACTIVATE, (data) => {
      console.log('ğŸ”§ å·¥å…·å·²æ¿€æ´»:', data.tool);
    });

    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.TOOL.DEACTIVATE, () => {
      console.log('ğŸ”§ å·¥å…·å·²åœç”¨');
    });

    // ç›‘å¬æ ‡æ³¨è·³è½¬
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.JUMP_TO, (data) => {
      const annotation = annotations.find(a => a.id === data.id);
      if (annotation) {
        console.log('ğŸ“ è·³è½¬åˆ°æ ‡æ³¨:', annotation.type, 'é¡µç :', annotation.pageNumber);
        alert(`è·³è½¬åˆ°ç¬¬ ${annotation.pageNumber} é¡µçš„ ${annotation.getTypeIcon()} æ ‡æ³¨`);
      }
    });

    // æµ‹è¯•å‡½æ•°
    window.testToggleSidebar = () => {
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.TOGGLE, {});
    };

    window.testAddScreenshot = () => {
      const annotation = Annotation.createScreenshot(
        Math.floor(Math.random() * 50) + 1,
        { x: 100, y: 200, width: 300, height: 200 },
        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
        'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æˆªå›¾æ ‡æ³¨'
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('âœ… æ·»åŠ æˆªå›¾æ ‡æ³¨:', annotation.id);
    };

    window.testAddTextHighlight = () => {
      const texts = [
        'è¿™æ˜¯ä¸€æ®µé‡è¦çš„æ–‡æœ¬å†…å®¹ï¼Œéœ€è¦é«˜äº®æ ‡è®°ã€‚',
        'æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ã€‚',
        'æ·±åº¦å­¦ä¹ ç½‘ç»œå¯ä»¥è‡ªåŠ¨æå–ç‰¹å¾ã€‚',
        'Transformeræ¶æ„æ”¹å˜äº†NLPé¢†åŸŸã€‚',
        'æ³¨æ„åŠ›æœºåˆ¶æ˜¯æ·±åº¦å­¦ä¹ çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚'
      ];
      const colors = Object.values(HighlightColor);
      const text = texts[Math.floor(Math.random() * texts.length)];
      const color = colors[Math.floor(Math.random() * colors.length)];

      const annotation = Annotation.createTextHighlight(
        Math.floor(Math.random() * 50) + 1,
        text,
        [{ start: 0, end: text.length }],
        color,
        'è¿™æ˜¯ä¸€æ¡ç¬”è®°'
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('âœ… æ·»åŠ é€‰å­—æ ‡æ³¨:', annotation.id);
    };

    window.testAddComment = () => {
      const comments = [
        'è¿™é‡Œéœ€è¦è¿›ä¸€æ­¥ç ”ç©¶',
        'è¿™æ®µå†…å®¹æœ‰ç–‘é—®',
        'é‡ç‚¹å…³æ³¨è¿™éƒ¨åˆ†',
        'å’Œç¬¬3ç« çš„å†…å®¹æœ‰å…³è”',
        'è¿™ä¸ªæ¦‚å¿µå¾ˆé‡è¦'
      ];
      const comment = comments[Math.floor(Math.random() * comments.length)];

      const annotation = Annotation.createComment(
        Math.floor(Math.random() * 50) + 1,
        { x: 150, y: 300 },
        comment
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('âœ… æ·»åŠ æ‰¹æ³¨æ ‡æ³¨:', annotation.id);
    };

    window.testClearAll = () => {
      if (annotations.length === 0) {
        alert('æ²¡æœ‰æ ‡æ³¨å¯æ¸…ç©º');
        return;
      }

      if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${annotations.length} ä¸ªæ ‡æ³¨å—ï¼Ÿ`)) {
        return;
      }

      // é€ä¸ªåˆ é™¤
      [...annotations].forEach(annotation => {
        eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.DELETED, { id: annotation.id });
      });
      annotations = [];
      window.annotations = annotations;
      console.log('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ ‡æ³¨');
    };

    window.testBatch = () => {
      console.log('ğŸš€ æ‰¹é‡æ·»åŠ 10ä¸ªæ ‡æ³¨...');
      for (let i = 0; i < 10; i++) {
        const type = Math.floor(Math.random() * 3);
        setTimeout(() => {
          if (type === 0) testAddScreenshot();
          else if (type === 1) testAddTextHighlight();
          else testAddComment();
        }, i * 100); // æ¯100msæ·»åŠ ä¸€ä¸ªï¼Œæœ‰åŠ¨ç”»æ•ˆæœ
      }
    };

    // è‡ªåŠ¨æ‰“å¼€ä¾§è¾¹æ 
    setTimeout(() => {
      sidebarUI.show();
    }, 500);

    console.log('âœ¨ æ ‡æ³¨UIæµ‹è¯•é¡µé¢å·²å°±ç»ª');
    console.log('ğŸ’¡ å¯ç”¨çš„å…¨å±€å¯¹è±¡:');
    console.log('  - window.eventBus: äº‹ä»¶æ€»çº¿');
    console.log('  - window.sidebarUI: ä¾§è¾¹æ UIå®ä¾‹');
    console.log('  - window.annotations: æ ‡æ³¨æ•°ç»„');
  </script>
</body>
</html>
