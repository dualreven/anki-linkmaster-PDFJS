<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>标注UI测试 - Annotation UI Test</title>
  <link rel="stylesheet" href="src/frontend/pdf-viewer/features/annotation/components/annotation-sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      overflow: hidden;
    }

    main {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #fff;
    }

    .viewer-placeholder {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #999;
      transition: left 0.3s;
    }

    .viewer-placeholder.sidebar-open {
      left: 350px;
    }

    .viewer-placeholder h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }

    .test-controls {
      position: fixed;
      right: 20px;
      top: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10000;
      max-width: 300px;
    }

    .test-controls h3 {
      margin-bottom: 12px;
      font-size: 14px;
      color: #333;
    }

    .test-controls button {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .test-controls button:hover {
      background: #f5f5f5;
      border-color: #bbb;
    }

    .test-controls button:active {
      background: #e0e0e0;
    }

    .test-controls .info {
      font-size: 12px;
      color: #666;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    .test-controls .status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .test-controls .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .test-controls .status-indicator.off {
      background: #999;
    }
  </style>
</head>
<body>
  <main id="main-container">
    <div class="viewer-placeholder" id="viewer-placeholder">
      <h1>📝 标注功能UI测试</h1>
      <p>使用右侧控制面板测试标注侧边栏</p>
    </div>
  </main>

  <div class="test-controls">
    <h3>🧪 测试控制面板</h3>

    <div class="status">
      <div class="status-indicator off" id="sidebar-indicator"></div>
      <span>侧边栏状态: <span id="sidebar-status">关闭</span></span>
    </div>

    <button onclick="testToggleSidebar()">切换侧边栏</button>
    <button onclick="testAddScreenshot()">添加截图标注</button>
    <button onclick="testAddTextHighlight()">添加选字标注</button>
    <button onclick="testAddComment()">添加批注标注</button>
    <button onclick="testClearAll()">清空所有标注</button>
    <button onclick="testBatch()">批量添加（10个）</button>

    <div class="info">
      <strong>已实现功能：</strong><br>
      ✅ 侧边栏UI<br>
      ✅ 工具按钮<br>
      ✅ 标注卡片<br>
      ✅ 数据模型<br>
      <br>
      <strong>待实现：</strong><br>
      ⏳ 工具交互逻辑<br>
      ⏳ 标注管理器<br>
      ⏳ PDF渲染集成
    </div>
  </div>

  <script type="module">
    // 导入依赖
    import { EventBus } from './src/frontend/common/event/event-bus.js';
    import { PDF_VIEWER_EVENTS } from './src/frontend/common/event/pdf-viewer-constants.js';
    import { AnnotationSidebarUI } from './src/frontend/pdf-viewer/features/annotation/components/annotation-sidebar-ui.js';
    import { Annotation, AnnotationType, HighlightColor } from './src/frontend/pdf-viewer/features/annotation/models/annotation.js';

    // 初始化EventBus
    const eventBus = new EventBus();
    window.eventBus = eventBus; // 便于调试

    // 初始化侧边栏UI
    const sidebarUI = new AnnotationSidebarUI(eventBus, {
      container: document.getElementById('main-container')
    });
    sidebarUI.initialize();
    window.sidebarUI = sidebarUI; // 便于调试

    // 存储标注
    let annotations = [];
    window.annotations = annotations;

    // 监听侧边栏状态变化
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.OPENED, () => {
      document.getElementById('sidebar-status').textContent = '打开';
      document.getElementById('sidebar-indicator').classList.remove('off');
      document.getElementById('viewer-placeholder').classList.add('sidebar-open');
    });

    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.CLOSED, () => {
      document.getElementById('sidebar-status').textContent = '关闭';
      document.getElementById('sidebar-indicator').classList.add('off');
      document.getElementById('viewer-placeholder').classList.remove('sidebar-open');
    });

    // 监听工具激活
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.TOOL.ACTIVATE, (data) => {
      console.log('🔧 工具已激活:', data.tool);
    });

    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.TOOL.DEACTIVATE, () => {
      console.log('🔧 工具已停用');
    });

    // 监听标注跳转
    eventBus.on(PDF_VIEWER_EVENTS.ANNOTATION.JUMP_TO, (data) => {
      const annotation = annotations.find(a => a.id === data.id);
      if (annotation) {
        console.log('📍 跳转到标注:', annotation.type, '页码:', annotation.pageNumber);
        alert(`跳转到第 ${annotation.pageNumber} 页的 ${annotation.getTypeIcon()} 标注`);
      }
    });

    // 测试函数
    window.testToggleSidebar = () => {
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.SIDEBAR.TOGGLE, {});
    };

    window.testAddScreenshot = () => {
      const annotation = Annotation.createScreenshot(
        Math.floor(Math.random() * 50) + 1,
        { x: 100, y: 200, width: 300, height: 200 },
        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
        '这是一个测试截图标注'
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('✅ 添加截图标注:', annotation.id);
    };

    window.testAddTextHighlight = () => {
      const texts = [
        '这是一段重要的文本内容，需要高亮标记。',
        '机器学习是人工智能的一个分支。',
        '深度学习网络可以自动提取特征。',
        'Transformer架构改变了NLP领域。',
        '注意力机制是深度学习的重要组成部分。'
      ];
      const colors = Object.values(HighlightColor);
      const text = texts[Math.floor(Math.random() * texts.length)];
      const color = colors[Math.floor(Math.random() * colors.length)];

      const annotation = Annotation.createTextHighlight(
        Math.floor(Math.random() * 50) + 1,
        text,
        [{ start: 0, end: text.length }],
        color,
        '这是一条笔记'
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('✅ 添加选字标注:', annotation.id);
    };

    window.testAddComment = () => {
      const comments = [
        '这里需要进一步研究',
        '这段内容有疑问',
        '重点关注这部分',
        '和第3章的内容有关联',
        '这个概念很重要'
      ];
      const comment = comments[Math.floor(Math.random() * comments.length)];

      const annotation = Annotation.createComment(
        Math.floor(Math.random() * 50) + 1,
        { x: 150, y: 300 },
        comment
      );
      annotations.push(annotation);
      eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.CREATED, { annotation });
      console.log('✅ 添加批注标注:', annotation.id);
    };

    window.testClearAll = () => {
      if (annotations.length === 0) {
        alert('没有标注可清空');
        return;
      }

      if (!confirm(`确定要清空所有 ${annotations.length} 个标注吗？`)) {
        return;
      }

      // 逐个删除
      [...annotations].forEach(annotation => {
        eventBus.emit(PDF_VIEWER_EVENTS.ANNOTATION.DELETED, { id: annotation.id });
      });
      annotations = [];
      window.annotations = annotations;
      console.log('🗑️ 已清空所有标注');
    };

    window.testBatch = () => {
      console.log('🚀 批量添加10个标注...');
      for (let i = 0; i < 10; i++) {
        const type = Math.floor(Math.random() * 3);
        setTimeout(() => {
          if (type === 0) testAddScreenshot();
          else if (type === 1) testAddTextHighlight();
          else testAddComment();
        }, i * 100); // 每100ms添加一个，有动画效果
      }
    };

    // 自动打开侧边栏
    setTimeout(() => {
      sidebarUI.show();
    }, 500);

    console.log('✨ 标注UI测试页面已就绪');
    console.log('💡 可用的全局对象:');
    console.log('  - window.eventBus: 事件总线');
    console.log('  - window.sidebarUI: 侧边栏UI实例');
    console.log('  - window.annotations: 标注数组');
  </script>
</body>
</html>
